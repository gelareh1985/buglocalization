<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 563030 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> builder.State: SimpleLookupTable performance does not scale </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2020-05-11T08:01:16Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> RESOLVED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 563178 - [15] Records - final modifier not allowed for record
components

Change-Id: Ibc6de70247ba50854fc769c512b7545143f15d32
 </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2020-05-15T14:57:33Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterJavadocTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClasspathUtil; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> DatabaseRef; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AptBuilder; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleInfoBuilder; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GenericsRegressionTest_9; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Parser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RunOnly335CompilerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavaProjectTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IField; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BinaryIndexer; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavaIndexerApplication; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> TestingEnvironment; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CodeFormatterApplication; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavaModelManager; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JarClassLoader; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerToolJava9Tests$CompilerBuilder; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> EclipseCompilerImpl; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AptConfig$ProcessorOptionsParser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> SwitchExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CtSym; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BuildJarIndex; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompletionEngine; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerInvocationTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> TokenTraverser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> SourceTypeBinding; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterJavadocTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/generatedfile/ClasspathUtil; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/DatabaseRef; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/build/AptBuilder; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/AbstractRegressionTest$JavacCompiler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/builder/ModuleInfoBuilder; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_9; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/parser/Parser; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunOnly335CompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_1_8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/JavaProjectTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS3; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/field/IField; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/JavaModelManagerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunOnlyJava8Tests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunCompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/JEP286Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/search/indexing/BinaryIndexer; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/builder/JavaBuilder; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/CompilerInvocationTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/index/JavaIndexerApplication; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/indexer/Indexer; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.builder/Lorg/eclipse/jdt/core/tests/builder/TestingEnvironment; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/formatter/CodeFormatterApplication; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_1_7; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/JavaModelManager; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/indexer/ClassFileToIndexConverter; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T08:01:16Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I see minute long "Analyzing deltas" progress dialog while re-generating project source with 80.000 java source files.
The code first removes all java sources and after that generates new files via Java nio API. 
Refreshing the project after that causes minute long waiting on JDT with one CPU core fully loaded.

All on Linux workstation with Xeon W-2145 CPU (16 cores), 256 GB RAM, SSD, OpenJDK 11.0.7 with 4 GB heap. This is not acceptable.

Most time is spent in SimpleLookupTable.rehash.

I believe this table must be replaced with standard Java HashMap, I've never seen such bad behavior with standard library classes.

"Worker-0: Building" #51 prio=5 os_prio=0 cpu=155671.47ms elapsed=1318.43s tid=0x00007ffff0970000 nid=0x18988 runnable  [0x00007fff078f6000]
   java.lang.Thread.State: RUNNABLE
        at org.eclipse.jdt.internal.compiler.util.SimpleLookupTable.put(SimpleLookupTable.java:105)
        at org.eclipse.jdt.internal.compiler.util.SimpleLookupTable.rehash(SimpleLookupTable.java:155)
        at org.eclipse.jdt.internal.compiler.util.SimpleLookupTable.removeValue(SimpleLookupTable.java:147)
        at org.eclipse.jdt.internal.core.builder.State.removeLocator(State.java:215)
        at org.eclipse.jdt.internal.core.builder.State.removePackage(State.java:229)
        at org.eclipse.jdt.internal.core.builder.State.removePackage(State.java:224)
        at org.eclipse.jdt.internal.core.builder.State.removePackage(State.java:224)
        at org.eclipse.jdt.internal.core.builder.State.removePackage(State.java:224)
        at org.eclipse.jdt.internal.core.builder.State.removePackage(State.java:224)
        at org.eclipse.jdt.internal.core.builder.IncrementalImageBuilder.findSourceFiles(IncrementalImageBuilder.java:631)
        at org.eclipse.jdt.internal.core.builder.IncrementalImageBuilder.findSourceFiles(IncrementalImageBuilder.java:591)
        at org.eclipse.jdt.internal.core.builder.IncrementalImageBuilder.findSourceFiles(IncrementalImageBuilder.java:542)
        at org.eclipse.jdt.internal.core.builder.IncrementalImageBuilder.build(IncrementalImageBuilder.java:118)
        at org.eclipse.jdt.internal.core.builder.JavaBuilder.buildDeltas(JavaBuilder.java:292)
        at org.eclipse.jdt.internal.core.builder.JavaBuilder.build(JavaBuilder.java:212)
        at org.eclipse.core.internal.events.BuildManager$2.run(BuildManager.java:832)
        at org.eclipse.core.runtime.SafeRunner.run(SafeRunner.java:45)
        at org.eclipse.core.internal.events.BuildManager.basicBuild(BuildManager.java:220)
        at org.eclipse.core.internal.events.BuildManager.basicBuild(BuildManager.java:263)
        at org.eclipse.core.internal.events.BuildManager$1.run(BuildManager.java:316)
        at org.eclipse.core.runtime.SafeRunner.run(SafeRunner.java:45)
        at org.eclipse.core.internal.events.BuildManager.basicBuild(BuildManager.java:319)
        at org.eclipse.core.internal.events.BuildManager.basicBuildLoop(BuildManager.java:371)
        at org.eclipse.core.internal.events.BuildManager.build(BuildManager.java:392)
        at org.eclipse.core.internal.events.AutoBuildJob.doBuild(AutoBuildJob.java:154)
        at org.eclipse.core.internal.events.AutoBuildJob.run(AutoBuildJob.java:244)
        at org.eclipse.core.internal.jobs.Worker.run(Worker.java:63) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T08:37:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> If I understand this correctly, 

org.eclipse.jdt.internal.compiler.util.SimpleLookupTable.removeValue(SimpleLookupTable.java:147)
        at org.eclipse.jdt.internal.core.builder.State.removeLocator(State.java:215)


it is a lookup of keys by value. There won't be any benefit with a plain HashMap, but maybe the entire code path around removeLocator should be revisited instead. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T08:44:41Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/162792 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T10:15:21Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Zarnekow from comment #1)
> If I understand this correctly, 
> 
> org.eclipse.jdt.internal.compiler.util.SimpleLookupTable.
> removeValue(SimpleLookupTable.java:147)
>         at
> org.eclipse.jdt.internal.core.builder.State.removeLocator(State.java:215)
> 
> 
> it is a lookup of keys by value. 

It is a bit different, it is just removing value without a key, so traversing map by value, and all that inside another loop :-).

> There won't be any benefit with a plain
> HashMap

Interestingly, I see the wait time halved here (from ~6 to ~2.5 minutes). Still too long, however.

> but maybe the entire code path around removeLocator should be
> revisited instead.

This State.removeLocator(String) is for sure not nice. There are 3 callers, and it *could be* they have enough context to use, but may be not, need to be reverse engineered:

org.eclipse.jdt.internal.core.builder.IncrementalImageBuilder.deleteGeneratedFiles(IFile[])
org.eclipse.jdt.internal.core.builder.IncrementalImageBuilder.findSourceFiles(IResourceDelta, ClasspathMultiDirectory, int)
org.eclipse.jdt.internal.core.builder.State.removePackage(IResourceDelta) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T10:26:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> If you switch to JDK maps, be sure to measure the memory impact (they create an object for every entry, SimpleLookupTable just uses two references (one in keyTable and one in valueTable) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T12:36:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Andrey Loskutov from comment #3)
> (In reply to Sebastian Zarnekow from comment #1)
> > If I understand this correctly, 
> > 
> > org.eclipse.jdt.internal.compiler.util.SimpleLookupTable.
> > removeValue(SimpleLookupTable.java:147)
> >         at
> > org.eclipse.jdt.internal.core.builder.State.removeLocator(State.java:215)
> > 
> > 
> > it is a lookup of keys by value. 
> 
> It is a bit different, it is just removing value without a key, so
> traversing map by value, and all that inside another loop :-).
> 
> > There won't be any benefit with a plain
> > HashMap
> 
> Interestingly, I see the wait time halved here (from ~6 to ~2.5 minutes).
> Still too long, however.
> 

It is even worse! Even if we *use key*, the SimpleLookupTable rehash() is called and hangs. It is unfortunately "too" simple :-)

In the stack below this.references.removeKey(typeLocatorToRemove) is the bottle neck => so even solving the problem with sourceLocations we still will see that code hanging:

Thread [Worker-26: Building] (Suspended)	
	SimpleLookupTable.rehash() line: 155	
	SimpleLookupTable.removeKey(Object) line: 127	
	State.removeLocator(String) line: 230	
	State.removePackage(IResourceDelta) line: 269	
	State.removePackage(IResourceDelta) line: 264	
	State.removePackage(IResourceDelta) line: 264	
	State.removePackage(IResourceDelta) line: 264	
	State.removePackage(IResourceDelta) line: 264	
	State.removePackage(IResourceDelta) line: 264	
	State.removePackage(IResourceDelta) line: 264	
	State.removePackage(IResourceDelta) line: 264	
	IncrementalImageBuilder.findSourceFiles(IResourceDelta, ClasspathMultiDirectory, int) line: 631	
	IncrementalImageBuilder.findSourceFiles(IResourceDelta, ClasspathMultiDirectory, int) line: 591	
	IncrementalImageBuilder.findSourceFiles(IResourceDelta) line: 542	
	IncrementalImageBuilder.build(SimpleLookupTable) line: 118	
	JavaBuilder.buildDeltas(SimpleLookupTable) line: 292	
	JavaBuilder.build(int, Map, IProgressMonitor) line: 212	
	BuildManager$2.run() line: 832	
	SafeRunner.run(ISafeRunnable) line: 45	
	BuildManager.basicBuild(int, IncrementalProjectBuilder, Map<String,String>, MultiStatus, IProgressMonitor) line: 220	
	BuildManager.basicBuild(IBuildConfiguration, int, IBuildContext, ICommand[], MultiStatus, IProgressMonitor) line: 263	
	BuildManager$1.run() line: 316	
	SafeRunner.run(ISafeRunnable) line: 45	
	BuildManager.basicBuild(IBuildConfiguration, int, IBuildContext, MultiStatus, IProgressMonitor) line: 319	
	BuildManager.basicBuildLoop(IBuildConfiguration[], IBuildConfiguration[], int, MultiStatus, IProgressMonitor) line: 371	
	BuildManager.build(IBuildConfiguration[], IBuildConfiguration[], int, IProgressMonitor) line: 392	
	AutoBuildJob.doBuild(IProgressMonitor) line: 154	
	AutoBuildJob.run(IProgressMonitor) line: 244	
	Worker.run() line: 63 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T14:31:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #4)
> If you switch to JDK maps, be sure to measure the memory impact (they create
> an object for every entry, SimpleLookupTable just uses two references (one
> in keyTable and one in valueTable)

I believe this is irrelevant here, the table manages String -> String pairs that represent partial vs full file paths, *they* have a memory impact. If this didn't explode in environments with big projects, it will not explode after the collection type change too.

(In reply to Andrey Loskutov from comment #5)
> (In reply to Andrey Loskutov from comment #3)
> > (In reply to Sebastian Zarnekow from comment #1)
> > > If I understand this correctly, 
> > > 
> > > org.eclipse.jdt.internal.compiler.util.SimpleLookupTable.
> > > removeValue(SimpleLookupTable.java:147)
> > >         at
> > > org.eclipse.jdt.internal.core.builder.State.removeLocator(State.java:215)
> > > 
> > > 
> > > it is a lookup of keys by value. 
> > 
> > It is a bit different, it is just removing value without a key, so
> > traversing map by value, and all that inside another loop :-).
> > 
> > > There won't be any benefit with a plain
> > > HashMap
> > 
> > Interestingly, I see the wait time halved here (from ~6 to ~2.5 minutes).
> > Still too long, however.

This was because I've not expected that removeKey() has also extremely bad performance in worst case. Fixing that too removed all remaining overhead.

> It is even worse! Even if we *use key*, the SimpleLookupTable rehash() is
> called and hangs. It is unfortunately "too" simple :-)
> 
> In the stack below this.references.removeKey(typeLocatorToRemove) is the
> bottle neck => so even solving the problem with sourceLocations we still
> will see that code hanging:

After moving *both* sourceLocations and references to LinkedHashMap and fixing the value traversal, the time spent before in State.removeLocator() is almost irrelevant behind other build tasks.

I will check the overall performance impact (not just in the use case of source file removal). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T15:25:12Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Andrey Loskutov from comment #6)
> (In reply to Till Brychcy from comment #4)
> > If you switch to JDK maps, be sure to measure the memory impact (they create
> > an object for every entry, SimpleLookupTable just uses two references (one
> > in keyTable and one in valueTable)
> 
> I believe this is irrelevant here, the table manages String -> String pairs
> that represent partial vs full file paths, *they* have a memory impact. If
> this didn't explode in environments with big projects, it will not explode
> after the collection type change too.


Hmm on the typical 64bit vm with compressed references, an empty string takes 40 bytes (String instance + char[]/byte[]-instance). For non-empty strings you have to add the memory for the actual characters (byte/char), aligning the size to 8.

Size of a java.util.LinkedHashMap$Entry is 40 bytes (and it needs one reference in the hashmap-table, where SimpleLookupTable uses to two references). So this is 36 bytes more per entry than in SimpleLookupTable. This is of course smaller than the memory needed for the strings, but not by orders of magnitude.

For your example of 80.000 files this means it takes approx 2.5MByte more. Also there will be a small GC impact, as those Maps are long-lived, so all the extra references will have to be traversed during GC's marking.

Nothing really bad, but should be taking into consideration.

(Estimations done with jol https://openjdk.java.net/projects/code-tools/jol/) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T15:58:28Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #7)
> For your example of 80.000 files this means it takes approx 2.5MByte more.
> Also there will be a small GC impact, as those Maps are long-lived, so all
> the extra references will have to be traversed during GC's marking.

Sure, but with heap sizes that are used in such projects (100k files as entry size) we have other issues as few MB more (I believe we are starting with 12 GB and go up to 24 depending on workstation available RAM). And for small projects this overhead is not visible on modern hardware anyway.

> Nothing really bad, but should be taking into consideration.

Sure, I'm happy someone else is looking into this too. I will try to create a semi-manual test case and measure the performance.

Current steps to reproduce my build "hang" are:

Import this small project into the target debuggee workspace: https://github.com/iloveeclipse/java-project-generator/tree/Bug_563017, the project should NOT be located on NFS, otherwise steps below will be extremely slow.

The project is just a stupid Java code generator for performance tests I've wrote for bug 562727. The branch above is special for bug 563017, as the generated files are almost empty, but this should be perfect for current case too, where we don't want to wait for slow ct.sym traversal :-).

1) Run Main (just use defaults), it will generate 80.000 Java files. 
2) Refresh the project to recompile everything. This will take about 30 seconds (time depending on your system).
3) Change Main.main() and use now: int roots = 10; int depth = 10; int classes = 100; values (that will produce 20.000 files, and remove all previously generated source artifacts).
4) Run Main again and refresh the project second time to start build. This will probably take *very* long (6+ minutes) without the patch, depending on your CPU / RAM, and in the Progress view you will see "Analyzing delta" job. The compilation itself is then again around 30 seconds after the delta is processed.

> (Estimations done with jol https://openjdk.java.net/projects/code-tools/jol/)

Thanks. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T16:05:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I gave this a shot to put the 2.5 megs into perspective:

Empty SimpleLookupTable: 960064 bytes
Empty LinkedHashMap: 56 bytes
Populating the table (80.000 entries): 165 ms
Populated SimpleLookupTable: 25279904 bytes
Populating the table (80.000 entries): 30 ms
Populated LinkedHashMap: 28044200 bytes

So we are talking about a memory increase of 10% or indeed 2.5mb. 

Maps populated via

for(int i = 0; i < 80_000; i++) {
  m.put(
    "com.acme.my.deep.pack.SomeClassName" + i, 
    "project.name/src/main/java/com.acme.my.deep.pack.SomeClassName" + i + ".java");
}

I think it's a fair tradeoff. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-11T16:10:51Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Till, Sebastian, would you be interested to review the patch https://git.eclipse.org/r/162792? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-12T20:27:13Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/162914 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-13T07:34:09Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Xtext is affected by this change (see https://github.com/eclipse/xtext-eclipse/issues/1450) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-13T10:55:03Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> +1 from PMC member for the change as requested by Andrey via the mailing list </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-13T12:17:52Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Lars Vogel from comment #13)
> +1 from PMC member for the change as requested by Andrey via the mailing list

+1 from me also.  Do we now have API available for Xtext to use?  If now can we have a plan to add something so they don't have to keep reacting to our internal changes? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-13T16:25:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I plan to wait for today's SDK build (with changes for bug 562727), and if nobody else will have objections, merge this patch & PDE fix tomorrow. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-15T13:45:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I see NPE's in new build, see

https://download.eclipse.org/eclipse/downloads/drops4/I20200514-1800/testresults/html/org.eclipse.jdt.debug.tests_ep416I-unit-win32-java8_win32.win32.x86_64_8.0.html

https://download.eclipse.org/eclipse/downloads/drops4/I20200514-1800/testresults/html/org.eclipse.jdt.debug.tests_ep416I-unit-cen64-gtk3-java8_linux.gtk.x86_64_8.0.html

!SUBENTRY 1 org.eclipse.jdt.core 4 2 2020-05-14 20:13:54.157
!MESSAGE Error saving last build state for project DebugTests
!STACK 0
java.lang.NullPointerException
	at org.eclipse.jdt.internal.core.builder.State.write(State.java:786)
	at org.eclipse.jdt.internal.core.builder.JavaBuilder.writeState(JavaBuilder.java:165)
	at org.eclipse.jdt.internal.core.JavaModelManager.saveBuiltState(JavaModelManager.java:4393)
	at org.eclipse.jdt.internal.core.JavaModelManager.saveState(JavaModelManager.java:4372)
	at org.eclipse.jdt.internal.core.JavaModelManager.saving(JavaModelManager.java:4716)
	at org.eclipse.core.internal.resources.SaveManager.executeLifecycle(SaveManager.java:387)
	at org.eclipse.core.internal.resources.SaveManager$1.run(SaveManager.java:204)
	at org.eclipse.core.runtime.SafeRunner.run(SafeRunner.java:45)
	at org.eclipse.core.internal.resources.SaveManager.broadcastLifecycle(SaveManager.java:207)
	at org.eclipse.core.internal.resources.SaveManager.save(SaveManager.java:1164)
	at org.eclipse.core.internal.resources.SaveManager.save(SaveManager.java:1143)
	at org.eclipse.core.internal.resources.Project.close(Project.java:197)
	at org.eclipse.jdt.debug.tests.breakpoints.BreakpointListenerTests.testMultiListenerProjectCloseOpen(BreakpointListenerTests.java:211)

I can't reproduce it running test locally. I'm thinking. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-15T14:40:04Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Andrey Loskutov from comment #16)
> I can't reproduce it running test locally. I'm thinking.

So we do have type locators that do not have an entry in the references list. My bet is on the change in removeTypeLocator(..).

Can we add an assertion that after removeTypeLocator no such type locator is present anymore and run a build with that assertion enabled? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-15T15:01:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Zarnekow from comment #17)
> (In reply to Andrey Loskutov from comment #16)
> > I can't reproduce it running test locally. I'm thinking.
> 
> So we do have type locators that do not have an entry in the references
> list. My bet is on the change in removeTypeLocator(..).
> 
> Can we add an assertion that after removeTypeLocator no such type locator is
> present anymore and run a build with that assertion enabled?

I'm still debugging, but this is probably *the* candidate.

Another one is the call org.eclipse.jdt.internal.core.builder.State.recordLocatorForType(String, String) that may add a typeLocator without touching "references" (or at least I don't see it).

What I see in debugger is: there are few *equal* values in typeLocators in the project that is used in the test - this are non-inner types that are defined in the same file, they have different keys but same file name as value. So I assume if we are asked to remove such type locator by value our assumption with "remove if it matches with prefix" doesn't work. I will now simply remove that part and run (performance) tests again, I believe this was not the biggest problem (it was rehashing).

Interesting fact is that I can't reproduce with same project that is used in debug tests. Also I don't see (yet) errors in my SDK workspace that has the commit, that is strange. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-15T15:37:53Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Patch is https://git.eclipse.org/r/#/c/163109/ (Gerrit still doesn't like us, see bug 563149) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-16T12:40:46Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/163130 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-16T14:52:33Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/163130 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=302894c7bc98fd880776f5e317788c7b3da88ebe </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-19T05:49:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #21)
> Gerrit change https://git.eclipse.org/r/163130 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=302894c7bc98fd880776f5e317788c7b3da88ebe

Can this be resolved as fixed? If there's work pending please move it to out of 4.16M3 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-19T06:33:52Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Sorry for reopening, but I think adding a regression test for changes in jdt.core is kind of mandatory, especially if a regression happens ;-)

But this can be done for RC1 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-05-25T10:35:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #23)
> Sorry for reopening, but I think adding a regression test for changes in
> jdt.core is kind of mandatory, especially if a regression happens ;-)
> 
> But this can be done for RC1

I've tried but I can't reproduce the fail conditions with a junit test case => I've created bug 563546 for 4.17 and closing this one. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-06-09T08:56:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/164505 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-06-09T08:57:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/164505 was merged to [BETA_JAVA15].
Commit: http://git.eclipse.org/c/pde/eclipse.pde.ui.git/commit/?id=7bb60c67a9ae42e254742be93e13655331ba5ed4 </td> </tr>
        </table>
</body>
</html>
