<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 559645 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> [annotation processing] Some warnings generated by APT processors missing when ecj is run via mvn command-line </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2020-01-28T22:12:44Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> RESOLVED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 404648 - [1.8][compiler] investigate differences between ECJ & javac

- excuse null-related differences in NullTypeAnnotationTest
- don't expect difference re 'real' (JLS) errors

Change-Id: I1cee2c854b04d58b7e787941f2c561839b40e304
 </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2020-02-01T13:14:23Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverter10Test; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JDTCompilerAdapter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FieldInitsFakingFlowContext; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ProblemReporter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavaModelManagerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CombinedBinaryExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> StandAloneASTParserTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Util; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RunCompilerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClasspathUtil; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaFactory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GenericsRegressionTest_1_8; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RawGrowableArray; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FinalRoundTestTrigger; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NonNull; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerToolTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RawGrowableArray; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Util; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractLeakTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ParameterizedTypeBinding; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IField; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Chunk; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JdtApt; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AptConfig$ProcessorOptionsParser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Database; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter10Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/JDTCompilerAdapter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter9Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/flow/FieldInitsFakingFlowContext; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS3; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterJavadocTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/problem/ProblemReporter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/JavaModelManagerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/CombinedBinaryExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/dom/StandAloneASTParserTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/util/Util; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/util/Disassembler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/AbstractRegressionTest$JavacCompiler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ClasspathTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunCompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS4; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ModuleBuilderTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/generatedfile/ClasspathUtil; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/LambdaFactory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter15JLS8Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_1_8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/RawGrowableArray; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_9; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.pluggable.tests/Lorg/eclipse/jdt/apt/pluggable/tests/annotations/FinalRoundTestTrigger; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/SwitchExpressionTest; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-28T22:12:44Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 281638
Sample maven project showing the problem

I have a case where some warnings generated by an annotation processor are shown in Eclipse, but are not reported when the same project is built via the mvn command-line in our CI build.

The attached project can be used to reproduce the behavior. I use an Eclipse (STS 4.5) including m2e and m2e-apt, APT is configured by m2e-apt from the pom.xml.

Performing a clean build in Eclipse generates a (correct) warning on file SomeObjectMapper.java:[8,23] Unmapped target properties: "a, b"

Running mvn clean install on the command-line using ecj (as specified in the pom.xml) does _not_ report this warning.

Running mvn clean install using javac (I'm using Java 11; un-comment the second <build> block in the POM and comment the first one) _does_ correctly report the warning.

I tried to debug this but didn't get very far. The annotation processor is mapstruct, and it seems to me that it reports that warning as "extraProblems". Looks like those somehow do not show up when mvn calls the BatchCompiler, but they do show up in Eclipse (which doesn't use BatchCompiler, I presume).

Problem occurs with mvn 3.6.2 and AdoptOpenJdk 11.0.5 (didn't try other combinations). I have _no_ idea whether this is a problem in ecj's BatchCompiler, or in plexus-compiler-plugin, or in maven-compiler-plugin.

It's rather annoying in our case since we fail our build on warnings (zero warning policy). That's also why we want to use ecj in the CI build so we can be sure the Eclipse JDT settings are taken into account and we thus get the same errors/warnings in Eclipse and in the CI build. But here we clearly don't, and because of this warning not being reported a bug sneaked into our product. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-29T23:37:43Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Looks like the problem is two-fold, partly in ecj, and partly in plexus-compiler-eclipse.

The XML log of the compile output contains

        <sources>
                <source output=".../org.test.mapper/target/classes" package="org/test/mapper" path=".../org.test.mapper/src/main/java/org/test/mapper/SomeObjectDTO.java">
                        <classfile path=".../org.test.mapper/target/classes/org/test/mapper/SomeObjectDTO.class"/>
                </source>
                <source output=".../org.test.mapper/target/classes" package="org/test/mapper" path=".../org.test.mapper/src/main/java/org/test/mapper/SomeObjectMapper.java">
                        <classfile path=".../org.test.mapper/target/classes/org/test/mapper/SomeObjectMapper.class"/>
                </source>
                <source output=".../org.test.mapper/target/classes" package="org/test/mapper" path=".../org.test.mapper/src/main/java/org/test/mapper/SomeObject.java">
                        <classfile path=".../org.test.mapper/target/classes/org/test/mapper/SomeObject.class"/>
                </source>
                <source output=".../org.test.mapper/target/classes" package="org/test/mapper" path=".../org.test.mapper/target/generated-sources/annotations/org/test/mapper/SomeObjectMapperImpl.java">
                        <classfile path=".../org.test.mapper/target/classes/org/test/mapper/SomeObjectMapperImpl.class"/>
                </source>
        </sources>
        <extra_problems problems="1">
                <extra_problem charEnd="136" charStart="116" line="8" severity="WARNING">
                        <message value="Unmapped target properties: &quot;a, b&quot;."/>
                        <source_context sourceEnd="34" sourceStart="14" value="SomeObjectDTO toDTO(SomeObject obj);"/>
                </extra_problem>
        </extra_problems>
        <stats>
                <problem_summary errors="0" infos="0" problems="1" tasks="0" warnings="1"/>
        </stats>

Several problems here:

ECJ:

* The extra_problem does not identify which source it belongs to.

plexus-compiler-eclipse:

* It doesn't parse the extra_problems at all, see [1].
* It ignores the <stats> completely. If it did read the stats, it could at least detect that there was one warning that it hadn't found in the XML.

[1] https://github.com/codehaus-plexus/plexus-compiler/blob/plexus-compiler-2.8.5/plexus-compilers/plexus-compiler-eclipse/src/main/java/org/codehaus/plexus/compiler/eclipse/EcjResponseParser.java

So I see two ways to resolve this:

1. ECJ only: get those messages from the APT processor recorded as normal problems if possible.

2. ECJ and plexus-compiler-eclipse: include a source file name in an extra_problem if possible, and make plexus-compiler-eclipse also parse the extra-problems. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-01T14:46:26Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Thomas Wolf from comment #1)
> So I see two ways to resolve this:
> 
> 1. ECJ only: get those messages from the APT processor recorded as normal
> problems if possible.
> 
> 2. ECJ and plexus-compiler-eclipse: include a source file name in an
> extra_problem if possible, and make plexus-compiler-eclipse also parse the
> extra-problems.

After digging more through the ECJ code I found a third way to resolve this in plexus-compiler-eclipse alone.

3. plexus-compiler-eclipse: rewrite it to use JSR-199 to call ECJ.

ECJ internally does record the source file for these extra_problems, it just doesn't report them in the log XML. And the JSR-199 EclipseCompiler does pass all extra_problems, including source, to the DiagnosticListener.

See [1] and [2].

On the ECJ side, there's thus basically:

1. The log XML does not report the source file for <extra_problem> elements.
2. The Diagnostic created by EclipseCompilerImpl.logExtraProblems() throw an NPE in Diagnostic.getSource() if ((DefaultProblem) problem).getOriginatingFileName() == null. (I.e., the underlying problem has no file associated.)
3. It would still be nicer if these APT diagnostics were reported normally, not as extra_problems.
4. There's a difference between BatchCompiler.compile() and EclipseCompiler.getTask().call(): if no source level is specified on the command line, BatchCompiler uses 1.3 but the JSR-199 implementation uses the latest version supported by ECJ.

[1] https://github.com/codehaus-plexus/plexus-compiler/issues/68
[2] https://github.com/codehaus-plexus/plexus-compiler/pull/69 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-01T19:55:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/157015 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-02T13:11:23Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Thomas Wolf from comment #2)
> 2. The Diagnostic created by EclipseCompilerImpl.logExtraProblems() throw an
> NPE in Diagnostic.getSource() if ((DefaultProblem)
> problem).getOriginatingFileName() == null. (I.e., the underlying problem has
> no file associated.)

can you say a word about why the originating file name can legally be null? And: if it is null: what will be the consequence of proceeding with null return from getSource()? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-02T13:42:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #4)
> can you say a word about why the originating file name can legally be null?
> And: if it is null: what will be the consequence of proceeding with null
> return from getSource()?

Occurs for instance in APT tests. Doesn't cause a problem because nobody calls Diagnostic.getSource() on these diagnostics.

I hit this when I played around with the APT tests to verify that the warning from the APT processor was really an extra-problem, was reported and would include a source. (It is, and it does.) To do so I simply dumped all the diagnostics when they were created. As soon as I did, tests failed with that NPE.

Basically I changed EclipseCompilerImpl.loggingExtraProblems() from

  if (this.diagnosticListener != null) {
    // Create disgnostic
    this.diagnosticListener.report(diagnostic)
  }

to

  // Create disgnostic
  System.err.println("DIAG: src=" + diagnostic.getSource() + " " + diagnostic.getMessage(Locale.ROOT));
  if (this.diagnosticListener != null) {
    this.diagnosticListener.report(diagnostic)
  }

then ran org.eclipse.jdt.compiler.apt.tests.BatchDispatchTest

With the fix, this produces

DIAG: src=null No SupportedSourceVersion annotation found on org.eclipse.jdt.compiler.apt.tests.processors.elements.Java9ElementProcessor, returning RELEASE_6.
DIAG: src=null No SupportedSourceVersion annotation found on org.eclipse.jdt.compiler.apt.tests.processors.elements.Java11ElementProcessor, returning RELEASE_6.
DIAG: src=null No SupportedSourceVersion annotation found on org.eclipse.jdt.compiler.apt.tests.processors.elements.Java13ElementProcessor, returning RELEASE_6.
DIAG: src=null No SupportedSourceVersion annotation found on org.eclipse.jdt.compiler.apt.tests.processors.elements.Java9ElementProcessor, returning RELEASE_6.
DIAG: src=null No SupportedSourceVersion annotation found on org.eclipse.jdt.compiler.apt.tests.processors.elements.Java11ElementProcessor, returning RELEASE_6.
DIAG: src=null No SupportedSourceVersion annotation found on org.eclipse.jdt.compiler.apt.tests.processors.elements.Java13ElementProcessor, returning RELEASE_6.

Without the fix, the tests fail with NPEs.

I don't know whether it's normal that these diagnostics don't have a source.

As for whether returning null is safe: since other code paths in Diagnostic.getSource() do already return null, a caller must be prepared to deal with it anyway. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-02T23:32:28Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Thomas Wolf from comment #5)
> I don't know whether it's normal that these diagnostics don't have a source.

These diagnostics appear come from the standard Java library, javax.annotation.processing.AbstractProcessor, and are issued at run-time of the processor. Nothing that can be done there to supply a source file (there might not even be one). So Diagnostics without originating file name are something "normal". </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-06T13:32:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/157015 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=dca945b44e00531039b6e9dc0e38efd6c65b498d </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-06T13:34:24Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #7)
> Gerrit change https://git.eclipse.org/r/157015 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=dca945b44e00531039b6e9dc0e38efd6c65b498d

Released to master for 4.15 M3.

Thanks, Thomas. Anything else needed in JDT to close this bug? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-06T13:54:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #8)
> (In reply to Eclipse Genie from comment #7)
> > Gerrit change https://git.eclipse.org/r/157015 was merged to [master].
> > Commit:
> > http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> > ?id=dca945b44e00531039b6e9dc0e38efd6c65b498d
> 
> Released to master for 4.15 M3.
> 
> Thanks, Thomas. Anything else needed in JDT to close this bug?

I think this can be closed. Feel free to create separate issues in bugzilla for the two remaining minor things mentioned in comment 2:

<extraProblems> in the log xml do not report the source related to the problem. (Messages from annotation processors about processed sources should include that info.) Unless one wants to hack fixing this would require a change to the DTD.

The different default source version between BatchCompiler.compile() and JSR-199 is a nuisance. To make my PR for plexus-compiler-eclipse backwards-compatible (and make it pass their tests!) I had to examine all command-line arguments and add -source 1.3 explicitly if not already present. But that still doesn't set the legacy defaults for target (1.2) and complianceLevel (1.4). Setting those correctly would involve copying a lot of arcane logic from Main. So it might be good if either they both used the same defaults, or there was a simple way to tell EclipseCompilerImpl to use the 1.3/1.2/1.4 default. </td> </tr>
        </table>
</body>
</html>
