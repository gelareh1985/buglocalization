<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 482242 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> [compiler][null] option to raise problems when unsafely passing annotated parameterized types into unannotated code </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2015-11-16T08:01:59Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> RESOLVED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 482242 - [compiler][null] option to raise problems when unsafely
passing annotated parameterized types into unannotated code

Change-Id: Ifd22f01d180a41fc1e7e9f878bfa6060c354e11f
 </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2020-01-26T14:21:23Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> InferenceContext18; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IPolyExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaFactory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTRewrite; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaExpressionsTest; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IProblem; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BindingMap; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterAST8Test; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Parser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NonNull; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> StandAloneASTParserTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ParserTest1_7; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BindingToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FormatterRegressionTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTRewritingExpressionsTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NonNullDefaultAwareTypeAnnotationWalker; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Nullable; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ConditionalFlowInfo; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> InvocationSite$EmptyWithAstNode; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaExpression$LocalTypeSubstitutor; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerInvocationTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> SelectionParser; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NullAnnotationModelTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTRewriteFormatter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> TypeBinding$LocalTypeBinding; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> TypeRef; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CodeStream; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/InferenceContext18; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/IPolyExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/LambdaExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/SwitchExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/ConstraintExpressionFormula; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/TypeVariableBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/LambdaFactory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/rewrite/ASTRewrite; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/ParameterizedTypeBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/LambdaExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/LambdaExpressionsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/compiler/IProblem; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullReferenceImplTransformations; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/AllocationExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_9; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/CombinedBinaryExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/NullAnnotationMatching; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/hierarchy/BindingMap; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NegativeLambdaExpressionsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/ConditionalExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/ImplicitNullAnnotationVerifier; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullReferenceTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/EqualExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterAST8Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/parser/Parser; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.annotation/Lorg/eclipse/jdt/annotation/NonNull; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/ProblemMethodBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/CastExpression; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2015-11-16T08:01:59Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> This may very well be an issue on my end, but I haven't been able to work around it. My code looks as follows:

import java.util.Set;
import java.util.stream.Collectors;

import org.eclipse.jdt.annotation.NonNull;

public class Test {
    public Set<String> test(Set<String> args) {
        @NonNull Set<@NonNull String> mapped = args.stream().collect(Collectors.toSet());
        return mapped;
    }
}


The compiler says: 
Null type safety (type annotations): The expression of type '@NonNull Set<String>' needs unchecked conversion to conform to '@NonNull Set<@NonNull String>'
Null type safety (type annotations): The expression of type '@NonNull Collector<@NonNull String,@NonNull capture#of ?,Set<@NonNull String>>' needs unchecked conversion to conform to 'Collector<? super @NonNull String,capture#of ?,@NonNull Set<String>>'

EEA for Stream looks as follows:

class java/util/stream/Stream
collect
 <R:Ljava/lang/Object;A:Ljava/lang/Object;>(Ljava/util/stream/Collector<-TT;TA;TR;>;)TR;
 <R:Ljava/lang/Object;A:Ljava/lang/Object;>(Ljava/util/stream/Collector<-TT;TA;TR;>;)T1R;

How can I make the compiler warnings disappear? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2015-11-16T23:19:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> This looks tricky ...

(In reply to Marcel Bruch from comment #0)
> The compiler says: 
> Null type safety (type annotations): The expression of type '@NonNull
> Set<String>' needs unchecked conversion to conform to '@NonNull Set<@NonNull
> String>'

This I cannot see. Was that triggered by some variant? Without external annotations? Without external annotations I get:

Null type safety (type annotations): The expression of type 'Set<@NonNull String>' needs unchecked conversion to conform to '@NonNull Set<@NonNull String>'

> Null type safety (type annotations): The expression of type '@NonNull
> Collector<@NonNull String,@NonNull capture#of ?,Set<@NonNull String>>' needs
> unchecked conversion to conform to 'Collector<? super @NonNull
> String,capture#of ?,@NonNull Set<String>>'

This resembles the variant I get *with* the external annotation. I do get:

Null type safety (type annotations): The expression of type 'Collector<@NonNull String,capture#of ?,Set<@NonNull String>>' needs unchecked conversion to conform to 'Collector<? super String,capture#of ?,@NonNull Set<@NonNull String>>'

Is some @NNBD effective on this class?

In my workspace and after applying the external annotation for Stream.collect() the remaining problem is:
The 3rd type argument to Collector<? super T, A, R> is lacking a @NonNull:
- have Set<@NonNull String>
- need @NonNull Set<@NonNull String>
The unannotated Set is derived from this signature in Collectors:
  <T>  Collector<T, ?, Set<T>> toSet()
Seeing the HashSet::new expression in the implementation I tend to believe that the set involved can be considered as nonnull, so another external @NonNull resolves the issue, for your reference:

Collectors.eea:
class java/util/stream/Collectors
toSet
 <T:Ljava/lang/Object;>()Ljava/util/stream/Collector<TT;*Ljava/util/Set<TT;>;>;
 <T:Ljava/lang/Object;>()Ljava/util/stream/Collector<TT;*L1java/util/Set<TT;>;>;

Now the eea on Stream isn't needed any more and that's good, because I see no reason to believe that Stream.collect() returns nonnull. The return type R must correspond with the type argument to the Collector being used (type & nullness).

So far so good, but here's a problem:

//---
import java.util.Collections;
import java.util.Set;
import java.util.stream.Collectors;

import org.eclipse.jdt.annotation.NonNull;

public class Test {
    static Set<@NonNull String> test1(Set<String> args) {
        @NonNull Set<@NonNull String> mapped = args.stream().collect(Collectors.toSet());
        return mapped;
    }
    public static void main(String[] args) {
		Set<String> set = Collections.singleton(null);
		for (@NonNull String s : test1(set))
			System.out.println(s.toUpperCase());
	}
}
//---

... is accepted by the compiler and prints:

Exception in thread "main" java.lang.NullPointerException
	at Test.main(Test.java:24)

We should only accept when the method parameter has type Set<@NonNull String>, because from a stream containing nulls we can not directly map to a set without nulls.

Hovering over collect I see this substituted signature:
 @NonNull Set<@NonNull String> java.util.stream.Stream.collect(Collector<? super String, ?, @NonNull Set<@NonNull String>> collector)

This shouldn't accept the toSet() expression, declared to return Collector<T, ?, Set<T>>, where both occurrences of T have the same nullness.


This definitely needs closer investigation. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2015-11-16T23:43:28Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> After pulling lots of stuff from java.util.stream into my own package, I see a bunch of "Null type mismatch" inside the library, but while stepping through the program from comment 1 no location is touched, which our compiler considers as null-unsafe. This proves that we are failing to report a necessary error. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2016-03-15T14:48:48Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Rechecking today, here's what I see:

Example from comment 0

- without .eea:

1. ERROR in /tmp/Test0.java (at line 8)
        @NonNull Set<@NonNull String> mapped = args.stream().collect(Collectors.toSet());
                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Null type safety (type annotations): The expression of type 'Set<@NonNull String>' needs unchecked conversion to conform to '@NonNull Set<@NonNull String>'


- with the provided Stream.eea:

ACCEPT


==>> Regarding the toplevel type Set both looks correct to me.
==>> TODO: check whether '<@NonNull String>' is correctly inferred.


The NPE in comment 1 can still be reproduced. Contrary to what I wrote in comment 1, in order to get the program accepted by ecj I only need Stream.eea, Collectors.eea seems to be irrelevant. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2016-04-24T21:07:14Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Bulk move: too late for 4.6 M7.

Very likely has to be moved out of 4.6 entirely. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-05-16T16:05:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Ran out of time for 4.7. Bulk move to 4.8. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-05-16T16:56:32Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> bulk move out of 4.8 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T22:41:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Bulk move to 4.13.

Hopefully I can dedicate a sprint during 4.13 just to static analysis (null and resource). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-02T17:51:07Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The target type can "trick" type inference into weaving a '@NonNull' into the signature of collect() where this is in fact unsafe. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T00:03:44Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/156573 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T11:49:50Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #9)
> New Gerrit change created: https://git.eclipse.org/r/156573

Once more giving this issue a new direction: it's not type inference that creates the gap, but lack of warnings when passing values of annotated parameterized types into unannotated code, simplified example:

//---
import java.util.*;
import org.eclipse.jdt.annotation.*;
class Test {
    static void dangerous(List<String> list) {
        list.add(null);
    }
    public static void main(String[] args) {
        List<@NonNull String> l = new ArrayList<>();
        dangerous(l);
        for (String string : l)
            System.out.println(string.toLowerCase());
    }
}
//---

In this case, it is obvious how the method dangerous "pollutes" our List<@NonNull String>.

Until now, our analysis has not considered any conversion from annotated to unannotated as dangerous. So via this bug I'm introducing a new option to report such unsafe and unchecked conversions. The tricky part is then to understand which such conversions from annotated to unannotated are in fact dangerous?

For conversions like List<@NonNull String> --> List<String> the problem is obvious. The original case from comment 1 is more tricky as it involves a lot of generics magic.

Here's an example of intermediate complexity, showing the role of wildcards:

//---
import java.util.*;
import java.util.stream.Collectors;
import org.eclipse.jdt.annotation.*;

public class Test {
    public static void main(String[] args) {
        ArrayList<@NonNull String> list = new ArrayList<>();
        collect(list, null);
        for (String s : list)
            System.out.println(s.toUpperCase());
    }
    static void collect(List<@NonNull String> list, String string) {
        list.add(string);     // (1)
        insert(list, string); // (2)
    }
    static void insert(List<? super String> l, String s) {
        l.add(s);
    }    
}
//---

We detect the problem at (1) (warning), but at (2) the same code extracted to method insert() goes undetected, because we assume that
    '@NonNull String' <= ? super String
For the unannotated types this is true, but the example shows how the unannotated method insert() can again pollute our list.

If we change the signature of insert to List<?> or List<? extends String>, then the implementation would already raise a type error. Or if we try l.add(null) we get "... 'null' is not compatible to the free type variable '?'" etc.

So the only gap regarding wildcards is the wrong assumption regarding "? super X". </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T14:35:29Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Pending changes via  https://git.eclipse.org/r/156573 :

@Till, I'm cc'ing you, because this is a significant change in null analysis, and touches also your work notably from bug 485988. Comments welcome.


(1) At the core NullAnnotationMatching adds a new constant to its enum Severity: UNCHECKED_TO_UNANNOTATED. This flag is returned from two arms of computeNullProblemSeverity(): In checking mode EXACT, we have a closer look when

 - the required type is unannotated (bits == 0) or,

 - the required type has both bits set as is the case for wildcards admitting non-null and nullable. In this case we need to have a closer look when a nonnull provided type meets a lower-bounded wildcard. Only when the receiving side is truly unconstrained we raise UNCHECKED_TO_UNANNOTATED.


(2) requiredNullTagBits() only answers AnnotationNullMASK (both bits admitted), when nullness is not constrained by an annotated bound.


(3) New option JavaCore.COMPILER_PB_ANNOTATED_TYPE_ARGUMENT_TO_UNANNOTATED to choose how the new NAM.Severity should be handled. Note, that we still re-use the existing IProblems regarding unchecked conversion. This implies that the problem hover will not support configuring the new option, but only the existing underlying option for null-unchecked conversions.

Reason for making this a separate option: in many cases this issue will be unavoidable, as it happens when passing values from annotated code into legacy libraries. Typically, it will be responsibility of the library owner to resolve this. But clients should at least have a chance to learn about the problem.


(4) Test adjustments include expecting a few more issues, and silencing the issue in other tests (trying to strike a balance btw. testing the new problem and keeping tests essentially unchanged).


(5) While analysing test expectations I was irritated by messages like:

  Null type safety (type annotations): The expression of type 'ArrayList<String>' needs unchecked conversion to conform to '@NonNull List<@NonNull String>', corresponding supertype is 'List<String>' 

When looking for the actual mismatch, one will think that the top-level @NonNull is missing from the given expression type, but then looking into the code, the expression was a 'new' expression, which is implicitly @NonNull. To make error messages aware of this fact, I let (Qualified)AllocationExpression add a synthetic @NonNull to their resolvedType, to yield (see the 1st @NonNull):

  Null type safety (type annotations): The expression of type '@NonNull ArrayList<String>' needs unchecked conversion to conform to '@NonNull List<@NonNull String>', corresponding supertype is 'List<String>'

Tests have been adjusted accordingly. I have NOT checked if this change might obsolete previous tweaks re 'new' expressions.



Reverted: patch set #1 contained two new IProblems so we can give a hint when a mismatch is caused by an annotated type variable (similar to NAM#superTypeHint). In the end and after some back-and-forth there was no test needing this, so I'm reverting this part. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T16:35:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/156573 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=26442c4da93bb37c148503ede232875b5244e58f </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T16:36:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #12)
> Gerrit change https://git.eclipse.org/r/156573 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=26442c4da93bb37c148503ede232875b5244e58f

JDT/Core part released to master so we have a chance to include this plus the UI option in M2.

Comments are still welcome :) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T17:23:11Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #11)
> (3) New option JavaCore.COMPILER_PB_ANNOTATED_TYPE_ARGUMENT_TO_UNANNOTATED
> to choose how the new NAM.Severity should be handled. Note, that we still
> re-use the existing IProblems regarding unchecked conversion. This implies
> that the problem hover will not support configuring the new option, but only
> the existing underlying option for null-unchecked conversions.

This is not good, because when following the advice in the problem hover, and changing the suggested option, the problem is actually not affected.

=> I will introduce a new IProblem, and try to write some new poetry how to more precisely explain the problem to the user :)

From the current message ...

Null type safety (type annotations): The expression of type 'Collector<@NonNull String,capture#of ?,Set<@NonNull String>>' needs unchecked conversion to conform to 'Collector<? super String,Object,@NonNull Set<@NonNull String>>'

We could go to ...

Null type safety (type annotations): Converting the expression of type 'Collector<@NonNull String,capture#of ?,Set<@NonNull String>>' to type 'Collector<? super String,Object,@NonNull Set<@NonNull String>>' risks polluting a '@NonNull' type with null.

Or more technically ...

Null type safety (type annotations): The value of type 'Collector<@NonNull String,capture#of ?,Set<@NonNull String>>' is made accessible using the less-annotated type 'Collector<? super String,Object,@NonNull Set<@NonNull String>>'.


Using the word "pollution" would allow us to draw an analogy to heap pollution wrt non-reifiable varargs, but the second option sounds more straight-forward to me (while not explaining, why exactly this is a problem). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T21:05:45Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/156591 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T21:11:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/156592 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-26T21:15:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #15)
> New Gerrit change created: https://git.eclipse.org/r/156591

New IProblem IDs & messages:

Unsafe null type conversion (type annotations): The value of type 'Collector<@NonNull String,capture#of ?,Set<@NonNull String>>' is made accessible using the less-annotated type 'Collector<? super String,Object,@NonNull Set<@NonNull String>>'.

Possibly adding a super type hint as with existing message.


(In reply to Eclipse Genie from comment #16)
> New Gerrit change created: https://git.eclipse.org/r/156592

Add the new option to the compiler preferences UI. With the above change in JDT/Ocre, "Configure problem severity" works as intended. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-27T08:29:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/156591 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=a1de6c1dd7cb7912b7e2b8fdaf34292a4e39cf91 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-27T17:25:49Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/156592 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.ui.git/commit/?id=44b70f3a991174b3fccf95a82dcb21db02b672c4 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-27T18:22:56Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #19)
> Gerrit change https://git.eclipse.org/r/156592 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.ui.git/commit/
> ?id=44b70f3a991174b3fccf95a82dcb21db02b672c4

This is how the new option is represented in the UI (in accordance with the compiler message shown in comment 17):

Unsafe conversion of annotated parameterized type to less-annotated type: [EWII]

All parts have been released to master for 4.15 M3 (M2) </td> </tr>
        </table>
</body>
</html>
