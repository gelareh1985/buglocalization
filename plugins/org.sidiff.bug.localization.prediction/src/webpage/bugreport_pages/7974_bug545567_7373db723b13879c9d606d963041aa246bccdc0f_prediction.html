<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 545567 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> [14][codegen] switch expression with try - java.lang.VerifyError: Inconsistent stackmap frames error </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2019-03-20T04:32:02Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> VERIFIED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 561197 - improve subword boundaries for UPPER_CASE names

Find all word boundaries in a first pass via state machine.
Distinguish between consecutive upper case letters in camel case vs.
caps names:
- getXYListener has boundaries at |get|X|Y|Listener
- UPPER_CASE_NAME has boundaries at |UPPER|_|CASE|_|NAME, but not
  in-between separators


Change-Id: Iffddd4307068a6194d207cca9143d733d18f8c10
Signed-off-by: Julian Honnen <julian.honnen@vector.com>
 </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2020-04-03T19:29:36Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RawGrowableArray; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FormatterRegressionTests; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GenericsRegressionTest_1_8; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterBugsTestJLS3; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RunOnly335CompilerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerToolTests; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Parser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IField; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FieldInitsFakingFlowContext; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BatchCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BindingToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractLeakTest; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CombinedBinaryExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaExpressionSyntaxTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NullAnnotationModelTests; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ProblemReferenceBinding; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> DatabaseRef; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CodeStream; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacTestOptions$MismatchType; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JDTCompilerAdapter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerToolJava9Tests$CompilerBuilder; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CodeFormatterApplication$Messages; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> SelectionOnLambdaExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaFactory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RegressionTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Database; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IDEInterface; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/RawGrowableArray; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/formatter/FormatterRegressionTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_1_8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS3; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/SwitchExpressionTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/formatter/DefaultCodeFormatterOptions; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullTypeAnnotationTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter18Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunOnly335CompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.compiler.tool.tests/Lorg/eclipse/jdt/compiler/tool/tests/CompilerToolTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/parser/Parser; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/LambdaRegressionTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/field/IField; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_9; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/flow/FieldInitsFakingFlowContext; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/formatter/FormatterCommentsBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/SwitchExpressionsYieldTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/compiler/batch/BatchCompiler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/indexer/BindingToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.builder/Lorg/eclipse/jdt/core/tests/builder/AbstractLeakTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/CombinedBinaryExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/impl/CompilerOptions; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/AbstractRegressionTest$JavacCompiler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/Compiler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/JavadocBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/formatter/FormatterBugsTests; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-20T04:32:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277934
Test Case to reproduce

From https://mail.openjdk.java.net/pipermail/compiler-dev/2019-March/013073.html

ecj also gives error as shown.
Error: Unable to initialize main class X
Caused by: java.lang.VerifyError: Inconsistent stackmap frames at branch target 13
Exception Details:
  Location:
    X.main([Ljava/lang/String;)V @4: goto
  Reason:
    Current frame's stack size doesn't match stackmap.
  Current Frame:
    bci: @4
    flags: { }
    locals: { '[Ljava/lang/String;' }
    stack: { 'java/io/PrintStream', integer }
  Stackmap Frame:
    bci: @13
    flags: { }
    locals: { '[Ljava/lang/String;' }
    stack: { }
  Bytecode:
    0000000: b200 1004 a700 094c 05a7 0004 5706 b600
    0000010: 16b1                                   
  Exception Handler Table:
    bci [3, 7] => handler: 7
    bci [3, 12] => handler: 12
  Stackmap Table:
    same_locals_1_stack_item_frame(@7,Object[#28])
    same_locals_1_stack_item_frame(@12,Object[#35])
    same_frame(@13) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-09T15:41:20Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Use this  https://git.eclipse.org/r/140311 from bug 545715 comment 19 and then run the following:
enum X {
    A, B; 
    @SuppressWarnings("preview")
    public static void main(String[] args) {
         X myEnum = X.A;
         int o;
         switch(myEnum) {
             case A -> o = 5;
             case B -> o = 10;
//             default -> o = 4;
         }
         System.out.println(o);
     }
}
 a similar error is thrown:
Error: Unable to initialize main class X
Caused by: java.lang.VerifyError: Inconsistent stackmap frames at branch target 44
Exception Details:
  Location:
    X.main([Ljava/lang/String;)V @44: getstatic
  Reason:
    Type top (current frame, locals[2]) is not assignable to integer (stack map, locals[2])
  Current Frame:
    bci: @12
    flags: { }
    locals: { '[Ljava/lang/String;', 'X' }
    stack: { integer }
  Stackmap Frame:
    bci: @44
    flags: { }
    locals: { '[Ljava/lang/String;', 'X', integer }
    stack: { }
  Bytecode:
    0000000: b200 144c b800 212b b600 242e aa00 0000
    0000010: 0000 0020 0000 0001 0000 0002 0000 0018
    0000020: 0000 001d 083d a700 0610 0a3d b200 281c
    0000030: b600 2eb1                              
  Stackmap Table:
    append_frame(@36,Object[#1])
    same_frame(@41)
    append_frame(@44,Integer)

Adding this here since this looks simpler than the one in comment 0. Assumption here is that these two issues are similar/identical </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-09T16:32:59Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I will take a look. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-15T13:45:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The problem comes from the fact that the default -> throw code is only generated for a switch expression. In this case, we have a switch statement.
When I try to compile this example with javac, it fails with:
X.java:11: error: variable o might not have been initialized
         System.out.println(o);

I applied the changes and I don't see that error anymore with Eclipse, but I hit the VerifyError due to what I said above. Manoj, are you sure this code should compile ? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-15T13:51:58Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> You can ping me anytime to clarify this. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-15T14:05:44Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Olivier Thomann from comment #3)
> The problem comes from the fact that the default -> throw code is only
> generated for a switch expression. In this case, we have a switch statement.
> When I try to compile this example with javac, it fails with:
> X.java:11: error: variable o might not have been initialized
>          System.out.println(o);
> 
> I applied the changes and I don't see that error anymore with Eclipse, but I
> hit the VerifyError due to what I said above. Manoj, are you sure this code
> should compile ?

Switch Statement without default looks like bug 545716 comment 0, where I thought we agree that this code is indeed illegal. Remi's comment "the spec says the compiler will add a default -> throw" was withdrawn wrt Switch Statement in bug 545716 comment 1 (where I read "is Ok" as "it's correct to reject"). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-15T15:02:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> It looks like you can write an switch expression without a default statement, but you cannot write a switch statement without a default statement. A bit weird I would say as I was seeing the switch expression as a switch statement that returns a value.
Adding the code generation to emulate a default statement that throws a exception is trivial. I haven't checked the spec though. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-17T10:20:11Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Olivier Thomann from comment #3)
> hit the VerifyError due to what I said above. Manoj, are you sure this code
> should compile ?

We need more clarity - however, at this point,  we believe it should compile. Please see the discussion in bug 545716 comment 16 and neighborhood.
We can hold on to this bug until we have a consensus there. I am marking this to be dependent on 545716. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-19T04:14:19Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Update:
 The original issue in description which is a switch expression still gives an exception (albeit with yield now)
public class X {
    @SuppressWarnings("preview")
	public static void main(String[] args) {
        System.out.println(switch (0) {
           default -> {
               try {
                   yield 1;
               }
               catch (Exception ex) {
                   yield 2;
               }
               finally {
                   yield 3;
               }
           }
        });
    }
}
@Olivier: However, as you mentioned in the comment 6, the switch statement issue mentioned in comment 1 can be ignored - we need to fix the switch expression though </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-09T03:25:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The following variant crashes at compile time itself
public class X {
	
    @SuppressWarnings({ "preview", "finally" })
	public static int foo() {
       System.out.println(switch (0) {
        default -> {
            try {
                yield 1;
            } finally {
                 yield 3;
            }
        }
     });
       return 0;
  }
   public static void main(String[] args) {
	System.out.println(X.foo());
}
}

ST: java.lang.ArrayIndexOutOfBoundsException: -1
	at org.eclipse.jdt.internal.compiler.codegen.StackMapFrame.addStackItem(StackMapFrame.java:108)
	at org.eclipse.jdt.internal.compiler.ClassFile.traverse(ClassFile.java:5984)
	at org.eclipse.jdt.internal.compiler.ClassFile.generateStackMapTableAttribute(ClassFile.java:4804)
	at org.eclipse.jdt.internal.compiler.ClassFile.completeCodeAttribute(ClassFile.java:1513)
	at org.eclipse.jdt.internal.compiler.ast.AbstractMethodDeclaration.generateCode(AbstractMethodDeclaration.java:357)
	at org.eclipse.jdt.internal.compiler.ast.AbstractMethodDeclaration.generateCode(AbstractMethodDeclaration.java:281)
	at org.eclipse.jdt.internal.compiler.ast.TypeDeclaration.generateCode(TypeDeclaration.java:583)
	at org.eclipse.jdt.internal.compiler.ast.TypeDeclaration.generateCode(TypeDeclaration.java:653)
	at org.eclipse.jdt.internal.compiler.ast.CompilationUnitDeclaration.generateCode(CompilationUnitDeclaration.java:410) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-11T07:58:28Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> @Olivier: capturing the debugging notes so far:

The javac asm is: 
// Method descriptor #24 ()I
  // Stack: 2, Locals: 3
  public static int foo();
     0  getstatic java.lang.System.out : java.io.PrintStream [7]
     3  astore_0
     4  iconst_0
     5  lookupswitch default: 16
    16  iconst_1
    17  istore_1
    18  iconst_3
    19  istore_1
    20  aload_0
    21  iload_1
    22  goto 33
    25  astore_2
    26  iconst_3
    27  istore_1
    28  aload_0
    29  iload_1
    30  goto 33
    33  invokevirtual java.io.PrintStream.println(int) : void [13]
    36  iconst_0
    37  ireturn
      Exception Table:
        [pc: 16, pc: 18] -> 25 when : any
      Line numbers:
        [pc: 0, line: 5]
        [pc: 16, line: 8]
        [pc: 18, line: 10]
        [pc: 33, line: 5]
        [pc: 36, line: 14]
      Stack map table: number of frames 3
        [pc: 16, append: {java.io.PrintStream}]
        [pc: 25, same_locals_1_stack_item, stack: {java.lang.Throwable}]
        [pc: 33, full, stack: {java.io.PrintStream, int}, locals: {}]
  
For the code:
public class X {
	
    @SuppressWarnings({ "preview", "finally" })
	public static int foo() {
       System.out.println(switch (0) {
        default -> {
            try {
                yield 1;
            } finally {
                 yield 3;
            }
        }
     });
     return 0;
  }
   public static void main(String[] args) {
	System.out.println(X.foo());
}
}

As mentioned above the compilation fails due to negative indexing and this happens at 12 in the assembly code shown below. For debugging purpose, this was checked and reset to zero to generate the following assembly code:
Ecj  generated: 
  // Method descriptor #15 ()I
  // Stack: 2, Locals: 0
  public static int foo();
     0  getstatic java.lang.System.out : java.io.PrintStream [16]
     3  iconst_1
     4  goto 8
     7  pop
     8  iconst_3
     9  invokevirtual java.io.PrintStream.println(int) : void [22]
    12  iconst_0
    13  ireturn
      Exception Table:
        [pc: 3, pc: 7] -> 7 when : any
      Line numbers:
        [pc: 0, line: 5]
        [pc: 3, line: 8]
        [pc: 7, line: 9]
        [pc: 8, line: 10]
        [pc: 9, line: 5]
        [pc: 12, line: 14]
      Stack map table: number of frames 2
        [pc: 7, same_locals_1_stack_item, stack: {java.lang.Throwable}]
        [pc: 8, same]
  
When run, gave the following error:
Error: Unable to initialize main class X
Caused by: java.lang.VerifyError: Inconsistent stackmap frames at branch target 8
Exception Details:
  Location:
    X.foo()I @4: goto
  Reason:
    Current frame's stack size doesn't match stackmap.
  Current Frame:
    bci: @4
    flags: { }
    locals: { }
    stack: { 'java/io/PrintStream', integer }
  Stackmap Frame:
    bci: @8
    flags: { }
    locals: { }
    stack: { }
  Bytecode:
    0000000: b200 1004 a700 0457 06b6 0016 03ac     
  Exception Handler Table:
    bci [3, 7] => handler: 7
  Stackmap Table:
    same_locals_1_stack_item_frame(@7,Object[#29])
    same_frame(@8)

To debug further, programmatically cached the branch targets of yield in case of subroutines, and at the code gen, checked the mapping from the yield gotos to the targets (in this case only 8) to �insert� the VerificationTypeInfo at branch target 8 to yield the following (just check the stackmap at 8):

  // Method descriptor #15 ()I
  // Stack: 2, Locals: 0
  public static int foo();
     0  getstatic java.lang.System.out : java.io.PrintStream [16]
     3  iconst_1
     4  goto 8
     7  pop
     8  iconst_3
     9  invokevirtual java.io.PrintStream.println(int) : void [22]
    12  iconst_0
    13  ireturn
      Exception Table:
        [pc: 3, pc: 7] -> 7 when : any
      Line numbers:
        [pc: 0, line: 5]
        [pc: 3, line: 8]
        [pc: 7, line: 9]
        [pc: 8, line: 10]
        [pc: 9, line: 5]
        [pc: 12, line: 14]
      Stack map table: number of frames 2
        [pc: 7, same_locals_1_stack_item, stack: {java.lang.Throwable}]
        [pc: 8, full, stack: {java.io.PrintStream, int}, locals: {}]

At 8, we have : {java.io.PrintStream, int} � this looked correct wrt     bci: @4 target type to pass targetIsTypeSafe (). However,the run of this gave the following error:

Error: Unable to initialize main class X
Caused by: java.lang.VerifyError: Instruction type does not match stack map
Exception Details:
  Location:
    X.foo()I @8: iconst_3
  Reason:
    Current frame's stack size doesn't match stackmap.
  Current Frame:
    bci: @8
    flags: { }
    locals: { }
    stack: { }
  Stackmap Frame:
    bci: @8
    flags: { }
    locals: { }
    stack: { 'java/io/PrintStream', integer }
  Bytecode:
    0000000: b200 1004 a700 0457 06b6 0016 03ac     
  Exception Handler Table:
    bci [3, 7] => handler: 7
  Stackmap Table:
    same_locals_1_stack_item_frame(@7,Object[#29])
    full_frame(@8,{},{Object[#23],Integer})

This looks like that the verification of targetIsTypeSafe() is true for goto at 4 and it proceeded further. But then, there seems to be a conflicting requirement for the smt to be containing     stack: { 'java/io/PrintStream', integer } for the target and     stack: { } in the second case. Are we missing any instructions, [just guessing] say for saving the value of yield in the second case of yield 3 alongwith the existing locals [PrintStream] ? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-11T12:39:56Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Further analysis of the code:
  // Stack: 2, Locals: 0
  public static int foo();
     0  getstatic java.lang.System.out : java.io.PrintStream [16]
     3  iconst_1
     4  goto 8
     7  pop
     8  iconst_3
     9  invokevirtual java.io.PrintStream.println(int) : void [22]
    12  iconst_0
    13  ireturn
      Exception Table:
        [pc: 3, pc: 7] -> 7 when : any

I think there are two issues here : 1) Code generated is wrong and 2) the stack frame mismatch.

Code generated wrong: � consider the control flow 0,3,4 ->8. At 8, we should have had icost_3 overwriting iconst_1, on the stack � but in this case both are on stack. Essentially, a store to a common LocalVarBind should take care of this. Tried this out to introduce this particular variable for a given switch and then the generated code is shown below:

  // Stack: 2, Locals: 1
  public static int foo();
     0  getstatic java.lang.System.out : java.io.PrintStream [16]
     3  iconst_1
     4  istore_0
     5  goto 9
     8  pop
     9  iconst_3
    10  istore_0
    11  iload_0
    12  invokevirtual java.io.PrintStream.println(int) : void [22]
    15  iconst_0
    16  ireturn
      Exception Table:
        [pc: 3, pc: 8] -> 8 when : any
      Line numbers:
        [pc: 0, line: 5]
        [pc: 3, line: 8]
        [pc: 8, line: 9]
        [pc: 9, line: 10]
        [pc: 12, line: 5]
        [pc: 15, line: 14]
      Stack map table: number of frames 2
        [pc: 8, full, stack: {java.lang.Throwable}, locals: {int}]
        [pc: 9, same]
  
And here we have 3,4,5 ->9 but then 10 pushes to istore_0 which is the same as in 4. At this point, I�ve introduced this store indiscriminately, ie without checking for exception handling, for all yields. However, we still have the stackmap mimatch dump:

Error: Unable to initialize main class X
Caused by: java.lang.VerifyError: Stack map does not match the one at exception handler 8
Exception Details:
  Location:
    X.foo()I @8: pop
  Reason:
    Type top (current frame, locals[0]) is not assignable to integer (stack map, locals[0])
  Current Frame:
    bci: @3
    flags: { }
    locals: { }
    stack: { 'java/lang/Throwable' }
  Stackmap Frame:
    bci: @8
    flags: { }
    locals: { integer }
    stack: { 'java/lang/Throwable' }
  Bytecode:
    0000000: b200 1004 3ba7 0004 5706 3b1a b600 1603
    0000010: ac                                     
  Exception Handler Table:
    bci [3, 8] => handler: 8
  Stackmap Table:
    full_frame(@8,{Integer},{Object[#29]})
    same_frame(@9) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-18T09:52:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Trying out an experimental merge from branch new_stack_map to the BETA_JAVA13, the compilation of the following:
public class X {
	@SuppressWarnings({ "preview", "finally" })
	public static int foo() {
		System.out.println(switch (0) {
		default -> {
			try {
				yield 1;
			} finally {
				yield 3;
			}
		}
		});
		return 0;
	}

	public static void main(String[] args) {
		System.out.println(X.foo());
	}
}

Gets the bytecode (disasm):
  // Method descriptor #15 ()I
  // Stack: 2, Locals: 0
  public static int foo();
     0  getstatic java.lang.System.out : java.io.PrintStream [16]
     3  iconst_1
     4  goto 8
     7  pop
     8  iconst_3
     9  invokevirtual java.io.PrintStream.println(int) : void [22]
    12  iconst_0
    13  ireturn
      Exception Table:
        [pc: 3, pc: 7] -> 7 when : any
      Line numbers:
        [pc: 0, line: 4]
        [pc: 3, line: 7]
        [pc: 7, line: 8]
        [pc: 8, line: 9]
        [pc: 9, line: 4]
        [pc: 12, line: 13]
      Stack map table: number of frames 2
        [pc: 7, same_locals_1_stack_item, stack: {java.lang.Throwable}]
        [pc: 8, full, stack: {java.io.PrintStream, int}, locals: {}]

Running gives the following error:

Error: Unable to initialize main class X
Caused by: java.lang.VerifyError: Instruction type does not match stack map
Exception Details:
  Location:
    X.foo()I @8: iconst_3
  Reason:
    Current frame's stack size doesn't match stackmap.
  Current Frame:
    bci: @8
    flags: { }
    locals: { }
    stack: { }
  Stackmap Frame:
    bci: @8
    flags: { }
    locals: { }
    stack: { 'java/io/PrintStream', integer }
  Bytecode:
    0000000: b200 1004 a700 0457 06b6 0016 03ac     
  Exception Handler Table:
    bci [3, 7] => handler: 7
  Stackmap Table:
    same_locals_1_stack_item_frame(@7,Object[#29])
    full_frame(@8,{},{Object[#23],Integer}) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-18T14:45:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Manoj Palat from comment #12)

javac byte code 

    0  getstatic java.lang.System.out : java.io.PrintStream [7]
     3  astore_0
     4  iconst_0
     5  lookupswitch default: 16
    16  iconst_1
    17  istore_1
    18  iconst_3
    19  istore_1
    20  aload_0
    21  iload_1
    22  goto 33
    25  astore_2
    26  iconst_3
    27  istore_1
    28  aload_0
    29  iload_1
    30  goto 33
    33  invokevirtual java.io.PrintStream.println(int) : void [13]
    36  iconst_0
    37  ireturn
      Exception Table:
        [pc: 16, pc: 18] -> 25 when : any
      Line numbers:
        [pc: 0, line: 4]
        [pc: 16, line: 7]
        [pc: 18, line: 9]
        [pc: 33, line: 4]
        [pc: 36, line: 13]
      Stack map table: number of frames 3
        [pc: 16, append: {java.io.PrintStream}]
        [pc: 25, same_locals_1_stack_item, stack: {java.lang.Throwable}]
        [pc: 33, full, stack: {java.io.PrintStream, int}, locals: {}] </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-21T12:53:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> A simpler case demonstrating the issue - a try block with a yield inside a switch expression

public class X {
    @SuppressWarnings({ "preview", "finally", "preview" })
	public static void main(String[] args) {
    	int t = switch (0) {
        default -> {
            try {
                yield 1;
            }
//            catch (Exception ex) {
//                yield 2;
//            }
            finally {
                yield 3;
            }
        }
     };
     System.out.println(t);
    }
}

with or without comment in the exception catch block - error is shown

Error: Unable to initialize main class X
Caused by: java.lang.VerifyError: Instruction type does not match stack map
Exception Details:
  Location:
    X.main([Ljava/lang/String;)V @5: iconst_3
  Reason:
    Current frame's stack size doesn't match stackmap.
  Current Frame:
    bci: @5
    flags: { }
    locals: { '[Ljava/lang/String;' }
    stack: { }
  Stackmap Frame:
    bci: @5
    flags: { }
    locals: { '[Ljava/lang/String;' }
    stack: { integer }
  Bytecode:
    0000000: 04a7 0004 5706 3cb2 0010 1bb6 0016 b1  
  Exception Handler Table:
    bci [0, 4] => handler: 4
  Stackmap Table:
    same_locals_1_stack_item_frame(@4,Object[#33])
    same_locals_1_stack_item_frame(@5,Integer) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-12-13T15:06:14Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/154479 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-12-13T15:55:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #15)
> New Gerrit change created: https://git.eclipse.org/r/154479

@Jay: Please check the test case in comment 8 as well </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-27T18:18:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The problem comes from the try/catch code generation inside the switch expression. We have an issue because when you enter the exception handler the JVM specs mention that the only item on the stack is the thrown exception. In this case, we already have another item on the stack. I need to think about a way to compile that code. Clearly not trivial. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-27T18:55:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I am looking at this example:
public class X {
	public static void main(String[] args) {
		int t = switch (4) {
			case 4 -> {yield 2;}
			default -> {
				try {
					yield 1;
				} finally {
					yield 3;
				}
			}
		};
		System.out.println(t);
	}
}

In this case, we generate:
  // Method descriptor #15 ([Ljava/lang/String;)V
  // Stack: 2, Locals: 2
  public static void main(java.lang.String[] args);
     0  iconst_4
     1  tableswitch default: 24
          case 4: 20
    20  iconst_2
    21  goto 30
    24  iconst_1
    25  goto 29
    28  pop
    29  iconst_3
    30  istore_1 [t]
    31  getstatic java.lang.System.out : java.io.PrintStream [16]
    34  iload_1 [t]
    35  invokevirtual java.io.PrintStream.println(int) : void [22]
    38  return
      Exception Table:
        [pc: 24, pc: 28] -> 28 when : any
      Line numbers:
        [pc: 0, line: 3]
        [pc: 20, line: 4]
        [pc: 24, line: 7]
        [pc: 28, line: 8]
        [pc: 29, line: 9]
        [pc: 30, line: 3]
        [pc: 31, line: 13]
        [pc: 38, line: 14]
      Local variable table:
        [pc: 0, pc: 39] local: args index: 0 type: java.lang.String[]
        [pc: 31, pc: 39] local: t index: 1 type: int
      Stack map table: number of frames 5
        [pc: 20, same]
        [pc: 24, same]
        [pc: 28, same_locals_1_stack_item, stack: {java.lang.Throwable}]
        [pc: 29, same_locals_1_stack_item, stack: {int}]
        [pc: 30, same_locals_1_stack_item, stack: {int}]

which is wrong at pc 29. There is no int on the stack at pc 29. The stack should be empty. The goto 29 at pc 25 should be a goto 30. I am investigating why we end up generating this code. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-27T19:09:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I think the biggest issue is that till now try statement could not return a value. If you look at the test case, the try statement returns a value (one of the yield value). In fact it always returns 3 because of the finally but this is not relevant. I need more time to figure out how we can solve this case. Any suggestion is welcome. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-02-28T03:44:13Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Olivier Thomann from comment #19)
> I think the biggest issue is that till now try statement could not return a
> value. If you look at the test case, the try statement returns a value (one
> of the yield value). In fact it always returns 3 because of the finally but
> this is not relevant. I need more time to figure out how we can solve this
> case. Any suggestion is welcome.

@Olivier: What we (Jay and I) have attempted is to have a "secret result value", similar to multiple " SECRET" variables in TryStatement. However, we attempted to make the switch expression have this secret result value - you can take a look at the git above.
(currently in the patch it is upper scope of switch expression - ideally I think it should be in the switch expression scope since multiple sibling switch expressions in a block will have conflict)

The result is always stored in this variable and then at the end of switch/finally this is loaded. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-03-08T16:15:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Manoj Palat from comment #20)
> attempted to make the switch expression have this secret result value - you
> can take a look at the git above.

Adding that with the git above (https://git.eclipse.org/r/#/c/154479/), the test case mentioned in comment 18 passes, but there are other failures.

The generated code is given below:

 // Method descriptor #15 ([Ljava/lang/String;)V
  // Stack: 3, Locals: 3
  public static void main(java.lang.String[] args);
     0  iconst_4
     1  tableswitch default: 25
          case 4: 20
    20  iconst_2
    21  istore_2
    22  goto 33
    25  iconst_1
    26  istore_2
    27  goto 31
    30  pop
    31  iconst_3
    32  istore_2 [ yieldValue]
    33  iload_2
    34  istore_1 [t]
    35  getstatic java.lang.System.out : java.io.PrintStream [16]
    38  iload_1 [t]
    39  invokevirtual java.io.PrintStream.println(int) : void [22]
    42  return
      Exception Table:
        [pc: 25, pc: 30] -> 30 when : any

Though the testcase you mentioned is fine with this git, the original testcase (modified to have yield) discussed in comment 8 still fails.

In that case, we already have one more value in stack even before entry into switch expression. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-03T11:27:19Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Olivier Thomann from comment #17)
> The problem comes from the try/catch code generation inside the switch
> expression. We have an issue because when you enter the exception handler
> the JVM specs mention that the only item on the stack is the thrown
> exception. In this case, we already have another item on the stack. I need
> to think about a way to compile that code. Clearly not trivial.

@Olivier: I think we have a solution (atleast partly) now. Just uploaded a latest gerrit here at : https://git.eclipse.org/r/#/c/160107/

Dev Notes:


- Taking a cude from Olivier's comment, switch expression with a try should keep track of the stack. Before entering (codegen) these need to be saved and post codegen, these need to be restored, else this will result in stack map inconsistencies. First, a traversal would signal whether a switch will contain a try - there is no additional traversal here - this is done using Parser.collectResultExpressions. 

- CodeStream is initialized and signalled to track the stack.  The stack is tracked from the concerned Methodlevel. 
- Just before codegen (inside SE.generateCode()), the processTypeBindingsOnStack would create the variable using appropriate typebinding and store. 
- In addition, a specific slot is reserved, depending on the size for the yield result. This variable is not made live yet since a continous life over the switch expression resulted in stackmap frame verification errors at gotos.
- In the yield statement, the result is transformed into a synthetic assignment statement which takes care of type conversions and then stored into the yield value. Only after the store (a SNR with ASTNode.IsSecretYieldValueUsage to signal yield set) is then made live with recordInitializationStartPC().Then this is loaded, and immediately the value range is closed - essentially a minimalistic range as possible.
- Further in the yield statement, when the subroutines are traversed, the final part is inlined - this is major deviation from the optimized codegen which is existing currently.
- tested with nested levels and same levels with appropriate test cases.
- one bug 561726 found wrt target level - slight modification in codeStream required once that is fixed (unrelated to this issue anyway).

Todo: 
- This does not cover try with resources - have issues wrt exception range handling - Looking into that now - may be addressed by another patch.

- As an optimization, we can switch off the stack tracing if all the switch expressions are processed in a method - currently not doing that to catch any issues. 
- And of course, more testing.

@Olivier : Can you please review the code? This can be released as the first part of the fix if the review is fine. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-03T11:29:59Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/160107 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-03T18:12:03Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #23)
> New Gerrit change created: https://git.eclipse.org/r/160107

The exception handlers including try with autocloseables also fixed in the latest patch. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-04T04:48:06Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/160107 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=74957ea9182f53b199c28221d0b1f24ac23dc7b4 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-04T04:51:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #25)
> Gerrit change https://git.eclipse.org/r/160107 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=74957ea9182f53b199c28221d0b1f24ac23dc7b4

Finally, submitted the fix! Thanks Olivier for a quick high level review!
If further issues found, please create new follow-up bugs rather than reopening/commenting this issue. This bug will be resolved once the fix is backported for P builds. Thanks </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-06T03:19:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/160502 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-06T03:23:56Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #27)
> New Gerrit change created: https://git.eclipse.org/r/160502

backport for P- Build </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-06T04:22:04Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/160502 was merged to [BETA_JAVA14].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=c24298e0eb88351d62c82402069b97d96c275652 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-06T04:24:46Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #29)
> Gerrit change https://git.eclipse.org/r/160502 was merged to [BETA_JAVA14].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=c24298e0eb88351d62c82402069b97d96c275652


As mentioned in comment #26)
> If further issues found, please create new follow-up bugs rather than
> reopening/commenting this issue. 

>This bug will be resolved once the fix is
> backported for P builds. Thanks

Resolving. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-04-10T06:18:46Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Verified for 4.16 M1 using build I20200409-0200. </td> </tr>
        </table>
</body>
</html>
