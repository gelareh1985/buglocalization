<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 525822 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> [1.8] ECJ compiles ambiguous lambda method invocation without warning, breaking builds with javac. </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2017-10-10T15:04:13Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> VERIFIED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 545420 - [1.8][inference] Receiving The target type of this
expression must be a functional interface

Change-Id: Ia55c7f0399cdea0c4448a15bf835406ceb828977
 </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2019-05-18T21:42:00Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ProblemReporter; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GenericsRegressionTest_1_8; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ConstraintExpressionFormula; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterBugsTestJLS3; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> DatabaseRef; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IProblem; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaExpression; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CombinedBinaryExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FieldInitsFakingFlowContext; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BindingMap; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IDOMFactory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerToolTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaExpression$LocalTypeSubstitutor; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTRewrite; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaExpressionSyntaxTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> InternalHexFloatTest$DoubleTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CodeCorrectionTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTRewritingReferenceExpressionTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ImplicitNullAnnotationVerifier$InheritedNonNullnessInfo; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerOptions; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> StructDef; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FinalRoundTestTrigger; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTBasedDeclarationImpl; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RawGrowableArray; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NonNullDefaultAwareTypeAnnotationWalker; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NonNullByDefault; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BindingToIndexConverter; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/problem/ProblemReporter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_1_8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/ConstraintExpressionFormula; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS3; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_9; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/DatabaseRef; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/util/Factory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/compiler/IProblem; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/LambdaExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/CombinedBinaryExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/CompilerInvocationTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/flow/FieldInitsFakingFlowContext; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/LambdaExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/MethodVerifier15; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/hierarchy/BindingMap; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/ReferenceExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter9Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/SerializableLambdaTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/jdom/IDOMFactory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullReferenceTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullReferenceImplTests~Generator; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/LambdaFactory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/ConditionalExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NegativeLambdaExpressionsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/DefaultBindingResolver; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/ParameterizedTypeBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/UnaryExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS4; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-10-10T15:04:13Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The following class compiles in Eclipse without any warnings or runtime errors:

import java.util.*;
import java.util.function.*;

public class EJCTest {

	static {
		final List<String> list = new ArrayList<>();
		accept(list::add);
	}

	static void accept(Consumer<String> yay) {};
	static void accept(BiConsumer<String, String> nooo) {};
}


But when compiled with javac (OpenJDK 1.8.0_131) the following error occurs:

EJCTest.java:7: error: reference to accept is ambiguous
    	accept(list::add);
    	^
  both method accept(Consumer<String>) in Test and method accept(BiConsumer<String,String>) in Test match
1 error


The javac compiler is correct I think. List<T>::add(int, T) may not be compatible with BiConsumer<String,String> at runtime, but according to the simplified method resolution rules (resolve method first, functional interface and parameter types later) it should still be rejected as ambiguous based on the parameter count only. ECJ is 'to smart' in this case and compiles code that should not compile according to the JLS. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-10-10T17:17:19Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Marcel Hellkamp from comment #0)
> The javac compiler is correct I think. List<T>::add(int, T) may not be
> compatible with BiConsumer<String,String> at runtime, but according to the
> simplified method resolution rules (resolve method first, functional
> interface and parameter types later)

were exactly do you see that in JLS? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-10-12T12:17:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I'm not sure, but:

> 15.12.2. Compile-Time Step 2: Determine Method Signature
> ...
> To check for applicability, the types of an invocation's arguments cannot, in general, be inputs to the analysis. This is because:
>   The arguments to a method invocation may be poly expressions
>   Poly expressions cannot be typed in the absence of a target type
>   Overload resolution has to be completed before the arguments' target types will be known
> Instead, the input to the applicability check is a list of argument expressions, which can be checked for compatibility with potential target types, even if the ultimate types of the expressions are unknown.
> ...
> Certain argument expressions that contain implicitly typed lambda expressions (§15.27.1) or inexact method references (§15.13.1) are ignored by the applicability tests, because their meaning cannot be determined until a target type is selected.

This implies that target type selection happens after applicability tests. I assume this is specified at some other place more clearly, but I could not find it.

Without an explicit target type (e.g. by casting the method reference to the desired functional interface type), List<T>::add(int, T) cannot be ruled out during applicability tests:

> 15.12.2.1. Identify Potentially Applicable Methods
>  A method reference expression (§15.13) is potentially compatible with a functional interface type if, where the type's function type arity is n, there exists at least one potentially applicable method for the method reference expression with arity n (§15.13.1), and one of the following is true:
>     The method reference expression has the form ReferenceType :: [TypeArguments] Identifier and at least one potentially applicable method is i) static and supports arity n, or ii) not static and supports arity n-1.
>     The method reference expression has some other form and at least one potentially applicable method is not static.

Only the arity is considered here. Thus, `List<T>::add(int, T)` should be 'potentially compatible' with `BiConsumer<String, String>` and `EJCTest::accept(BiConsumer<String, String>)` should be part of the set of 'potentially applicable' methods.

I could not find a rule that removes `EJCTest::accept(BiConsumer<String, String>)` from the set of 'potentially applicable' methods, until: 

> 15.12.2.5. Choosing the Most Specific Method
> (at the very end)
> * Otherwise, the method invocation is ambiguous, and a compile-time error occurs.

Even if I am wrong and this is a bug in javac or simply undefined behavior, I still think that ECJ should match the behavior of a recent javac or at least emit a warning. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-03-04T18:18:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> bulk move to 4.8 M7 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-08-16T04:06:49Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Bulk move out of 4.9 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-08-16T10:14:44Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Partial analysis:

The BiConsumer variant is dropped in this stack:

BlockScope(Scope).findMethod0(ReferenceBinding, char[], TypeBinding[], InvocationSite, boolean) line: 1737	
BlockScope(Scope).findMethod(ReferenceBinding, char[], TypeBinding[], InvocationSite, boolean) line: 1637	
BlockScope(Scope).getMethod(TypeBinding, char[], TypeBinding[], InvocationSite) line: 2920	
ReferenceExpression.resolveType(BlockScope) line: 696	
ReferenceExpression.cachedResolvedCopy(TypeBinding) line: 946	
ReferenceExpression.isCompatibleWith(TypeBinding, Scope) line: 1223	
PolyTypeBinding.isCompatibleWith(TypeBinding, Scope) line: 40	
ClassScope(Scope).parameterCompatibilityLevel(TypeBinding, TypeBinding, LookupEnvironment, boolean) line: 4903	
ClassScope(Scope).parameterCompatibilityLevel(MethodBinding, TypeBinding[], boolean) line: 4870	
ClassScope(Scope).computeCompatibleMethod(MethodBinding, TypeBinding[], InvocationSite, boolean) line: 864	
ClassScope(Scope).computeCompatibleMethod(MethodBinding, TypeBinding[], InvocationSite) line: 791	
ClassScope(Scope).findMethod0(ReferenceBinding, char[], TypeBinding[], InvocationSite, boolean) line: 1736	
ClassScope(Scope).findMethod(ReferenceBinding, char[], TypeBinding[], InvocationSite, boolean) line: 1637	
BlockScope(Scope).getImplicitMethod(char[], TypeBinding[], InvocationSite) line: 2604	
MessageSend.findMethodBinding(BlockScope) line: 948	
MessageSend.resolveType(BlockScope) line: 770	

The top findMethod0() does not consider any of the found "add" methods as compatible with the parameters (String,String), hence this branch, investigating the BiConsumer variant yields no applicable method.

I agree that both accept methods are potentially applicable. Next we need to apply 15.12.2.2., which involves checking parameter compatibility. My quick guess is: the check PolyTypeBinding.isCompatibleWith() is too strict in this situation, given that the expression (list::add) is not pertinent to applicability. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-08-16T18:57:24Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/127537 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-08-17T07:44:46Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #6)
> New Gerrit change created: https://git.eclipse.org/r/127537

Remaining failures after initial round of adjusting tests to the proposed fix (each occurring at both 1.8 and 10:

    org.eclipse.jdt.core.tests.compiler.regression.NegativeLambdaExpressionsTest.test401939b
    org.eclipse.jdt.core.tests.compiler.regression.OverloadResolutionTest8.test4008712q
    org.eclipse.jdt.core.tests.compiler.regression.OverloadResolutionTest8.test4008712r
    
Intriguingly in one case (LambdaExpressionsTest) the excuse EclipseBug510528 is no longer needed (while another test still needs it). It feels like we're on a good path here. Still I'm suspending work until I find some more time to investigate the above regressions. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-08-19T22:15:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 534466 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-17T22:02:49Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #7)
> (In reply to Eclipse Genie from comment #6)
> > New Gerrit change created: https://git.eclipse.org/r/127537
> 
> Remaining failures after initial round of adjusting tests to the proposed
> fix (each occurring at both 1.8 and 10:
> 
>    
> org.eclipse.jdt.core.tests.compiler.regression.NegativeLambdaExpressionsTest.
> test401939b

This has been fixed in patch set #3. At the time of checking parameterCompatibilityLevel() we're unable to give a definite answer. This must be compensated in ASTNode.resolvePolyExpressionArguments(). Interestingly, we already checked lambda.isCompatibleWith() but didn't react to any 'false' answer.
   
> org.eclipse.jdt.core.tests.compiler.regression.OverloadResolutionTest8.
> test4008712q
>    
> org.eclipse.jdt.core.tests.compiler.regression.OverloadResolutionTest8.
> test4008712r

These cases now report "The method goo(I) is ambiguous for the type X<T>" while javac accepts with error. Interestingly, with -Xlint:all javac reports:

  warning: [overloads] goo(I) in X is potentially ambiguous with goo(J) in X

We should be able to morph the current ambiguous into "potentially ambiguous" but that would be too big a change for 4.11 at this point.

Additionally, the latest change produces regressions in:
org.eclipse.jdt.core.tests.compiler.regression.LambdaShapeTests.test016
org.eclipse.jdt.core.tests.compiler.regression.LambdaShapeTests.test029
org.eclipse.jdt.core.tests.compiler.regression.NullTypeAnnotationTest.testBug448777
org.eclipse.jdt.core.tests.compiler.regression.NullTypeAnnotationTest.testTypeVariable7a
org.eclipse.jdt.core.tests.compiler.regression.NullTypeAnnotationTest.testTypeVariable7err

The former two are a change in how we report the error, assumably reporting "is not applicable" prevents proceeding into analyseCode().

In NullTypeAnnotationTest an expected error "Contradictory null annotations" triggers an unexpected secondary error "method _ is not applicable for the arguments _".

Apparently check for errors in the lambda must better distinguish different kinds of problems.

Moving to 4.12 for a full solution. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T12:47:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Found an interesting detail re OverloadResolutionTest8.test4008712q:

Contrary to comment 9, javac doesn't complain at the method invocation, it only flags the declaration of X.goo(I) as potentially ambiguous. At the invocation javac is silent (except for unchecked warnings).

In the existing example, javac & ecj (HEAD without this bug's change) agree on accepting and invocation in both cases says:
foo(I)

NOW, if I change the receiver of the reference expression from raw "new X()" to "new X<>()", all compiler accept *including* ecj with my current patch here, and all generate code that prints
foo(J)

Hence, overload resolution must see that new X<String>()::foo has a String return whereas new X()::foo has an Object return type, so that the former matches to J, whereas the latter does not, leaving only the goo(I) candidate.

Hence the question: where is overload resolution allowed to inspect the return type of a functional type?

- 15.12.2.1 defines a method reference as potentially compatible with a target type with no regard to the function type's return type (not even voidness is considered, unlike the corresponding rule for lambdas), hence goo(I) would be potentially applicable with the given argument.

- To find out, if 15.12.2.2 ff. help to disqualify this candidate, we need to know whether the method reference is pertinent to applicability (if it is not, we have to accept this method without further checks).

- A method reference is pertinent to applicability (15.12.2.2.) if it is exact (15.13.1). The latter paragraph considers rawness for the case ReferenceType::[TypeArguments] Identifier, but not for the case Primary::[TypeArguments] Identifier.

ecj currently implements exactness check by checking rawness regardless of the shape of the reference expression. If I would change this to literally match 15.13.1, we'd get around 25 unique failures only in OverloadResolutionTest8. I am not going to furhter analyze this branch.


Hence, I don't see how applicability analysis can rule out goo(J) and most-specific analysis doesn't help either, so I believe reporting ambiguity is the best thing to do here.


Having to choose between two different deviations from javac, I won't hesitate to introduce a deviation when raw types are involved, in order to align another case without raw types. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T15:49:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Trying to summarize the changes that have accumulated through ripple effects:

In the original case, Scope.parameterCompatibilityLevel() was stricter than desired, by unconditionally calling arg.isCompatibleWith(param, this), without considedring pertinence to applicability. The changes in Scope reduce these checks such that for non-pertinent arguments the softer isPotentiallyCompatibleWith() is used.
=> this fixed the original case
=> it also resolved one excuse EclipseBug510528 in LambdaExpressionsTest.test437781


A regression in NegativeLambdaExpressionsTest.test401939b was compensated by error detection in ASTNode.resolvePolyExpressionArguments(): If lambda.isCompatibleWith() returns false, we react by returning a ProblemMethodBinding, which is propagated back into #binding of the respective invocation site. 
The change around FunctionalExpression.hasDescripterProblem avoids the new effects for problem cases that have been detected before.


Regressions in NullTypeAnnotationTest.{testBug448777,testTypeVariable7a,testTypeVariable7err} are compensated in PTB.getSingleAbstractMethod() by extracting the closestMatch in the case of ContradictoryNullAnnotations. Perfectly legal, since these are our own rules :) (there may be more locations that would need to check this or similar problem ids. If so we could think of a variant isValidBindingByJLS()).


Then analysis of failures in LambdaShapeTests.{test016,test029} led to more specific error reporting in ASTNode.resolvePolyExpressionArguments(), the very block that was introduced to paragraphs up. Affected classes:
ProblemReasons
IProblem + messages.properties
ProblemReporter
ASTNode
LambdaExpression


Test changes not mentioned above:
- Expect more (secondary?) error in NegativeLambdaExpressionTests.test401610e
- NegativeLambdaExpressionTests.test423129 had a bogus line number, no idea how this could slip through (yes, I checked, it is run on jenkins etc.)
- OverloadResolutionTest8: expect 2 more errors as discussed in comment 10 (covered by a generic javac excuse), added another test using diamond instead of raw. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T15:50:49Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/127537 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=c3bca83c3ba740ea3abc5cd2e334d9ab35a56b82 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T15:53:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #12)
> Gerrit change https://git.eclipse.org/r/127537 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=c3bca83c3ba740ea3abc5cd2e334d9ab35a56b82

Released for 4.12 M3 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T10:26:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The fix is not good. When using the latest compiler from I20190519-1800 we get compile errors in JFace:

Description	Resource	Path	Location	Type
The constructor Image(Device, ImageFileNameProvider) is ambiguous	ImageDescriptor.java	/org.eclipse.jface/src/org/eclipse/jface/resource	line 293	Java Problem
The type of getImageData(int) from the type ImageDescriptor is ImageData, this is incompatible with the descriptor's return type: String	ImageDescriptor.java	/org.eclipse.jface/src/org/eclipse/jface/resource	line 293	Java Problem


Steps to reproduce:
1. Install I20190519-1800
2. Start with a new workspace
3. Import org.eclipse.jface from https://git.eclipse.org/c/platform/eclipse.platform.ui.git/
==> compile errors


I verified that reverting the change fixes the issue. Also, using the previous build fixes the issue.


NOTE: In my big workspace with almost everything in source I only got the above two compile errors. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T10:44:53Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> At the moment I have no time for a detailed look into this.

Have you checked if the affected code in JFace is definitely correct? Is that code (or a reproducing extract) accepted by javac? If yes to both, reverting may be the only option for now. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T11:25:23Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #15)
> At the moment I have no time for a detailed look into this.
> 
> Have you checked if the affected code in JFace is definitely correct? Is
> that code (or a reproducing extract) accepted by javac? If yes to both,
> reverting may be the only option for now.
The code looks OK to me. I currently can't check with javac. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T11:40:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #15)
> At the moment I have no time for a detailed look into this.
> 
> Have you checked if the affected code in JFace is definitely correct? Is
> that code (or a reproducing extract) accepted by javac? If yes to both,
> reverting may be the only option for now.

Before the patch JDT implicitly assumed "this" to be instanceof ImageDataProvider and generated lambda matching ImageDataProvider::getImageData(int) invocation.

Now the code expects that there could be multiple matches for functional interface (ImageFileNameProvider too) and so creates compilation error.

I have no idea how to compile SWT with javac, but I'm trying to create standalone example.

Scary enough and unrelated to this issue, the code in getImageData(int) calls getImageData() and back, actually we should have stack overflow here, but it only works because the real implementations of ImageDescriptor override one of those methods. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T11:51:09Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 278661
example project demonstrating problem in ImageDescriptor

See attached project, which compiles with old Eclipse and does not compiles with new one and also does NOT compile with javac 1.8_181 and javac 11.02.

Error reported by javac:

javac -Xdiags:verbose *.java
X.java:6: error: reference to Y is ambiguous
                y = new Y(new Object(), this::getZ);
                    ^
  both constructor Y(Object,FunctionalZ) in Y and constructor Y(Object,FunctionalString) in Y match
1 error </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T11:51:12Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 278662
Isolated test case

I extracted this from the cited source code, but with all referenced types locally available. And I see the same problem with Javac 13 (EA) as well. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T11:57:57Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/142431 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T11:58:30Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #20)
> New Gerrit change created: https://git.eclipse.org/r/142431

This is the fix for ImageDescriptor. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T12:03:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> OK, looks like the issue is with the code itself. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T12:19:58Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/142431 was merged to [master].
Commit: http://git.eclipse.org/c/platform/eclipse.platform.ui.git/commit/?id=3cf23b7d8b0fc4e57f18118cb6fc92a8e6de0490 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T12:26:13Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> To close on this: the code seemed to work, so, are ECJ and javac maybe too restrictive here? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T12:35:07Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Dani Megert from comment #24)
> To close on this: the code seemed to work, so, are ECJ and javac maybe too
> restrictive here?

From the "stupid user" point of view, ECJ was more clever before and automatically selected the "right" interface to compile lambda. 

I (as stupid user) do not see how ImageFileNameProvider can be used for lambda here - there are no matching methods in ImageDescriptor for ImageFileNameProvider::getImagePath(int). 

I only could imagine this is allowed because the ImageDescriptor class is abstract and so the clients *could* have implemented this method, so this *could* be ambiguous. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T13:38:48Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Sorry, but in the context of overloading with functional interface involved intuition is of *very* limited use.

Even if it appeared to work before, it doesn't say it will always work, nor does it imply this would be valid Java (i.e., conforming to JLS), nor will users like if ecj accepts programs that javac does not (see the original problem from comment 0).

This entire story is *much* more complex than meets the eye.

Lesson to be learned: developers should *never* write overloaded methods which only differ in types when functional interfaces are involved. You will not understand the code nor the reasoning which the compiler has to perform - promised :)

Other than that: thanks Andrey, Jay, for identifying & isolating the bogus code in JFace! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T15:37:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Verified for Eclipse Version: 2019-06 (4.12) Build id: I20190520-0600 </td> </tr>
        </table>
</body>
</html>
