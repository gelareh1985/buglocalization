<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 512156 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> [inference] Eclipse build freezes due to generics processing </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2017-02-14T08:15:25Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> VERIFIED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 547197 - [9][model] API to get the kind of a IModuleDescription

Change-Id: I711c1322ade275a3ca0fff51e53588a02cef2935
Signed-off-by: Stephan Herrmann <stephan.herrmann@berlin.de> </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2019-05-12T10:53:11Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterJavadocTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> DatabaseRef; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GenericsRegressionTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RunCompilerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ConstraintExpressionFormula; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BuildNotifier; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IPolyExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FieldInitsFakingFlowContext; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ProblemReporter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IProblem; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BindingMap; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerOptions; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FormatterMassiveRegressionTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GeneratedResourceChangeListener$PreBuildVisitor; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleBuilderTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaFactory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> TokenScanner; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AptBuilder; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavadocParser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IField; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Database; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RawGrowableArray; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IDOMFactory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ReconcileFilerImpl; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AptConfig$ProcessorOptionsParser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> TokenTraverser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterJavadocTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/util/Factory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/DatabaseRef; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullReferenceImplTests~Generator; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunCompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/ConstraintExpressionFormula; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/builder/BuildNotifier; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/IPolyExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/flow/FieldInitsFakingFlowContext; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/builder/JavaBuilder; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/problem/ProblemReporter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/CombinedBinaryExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/compiler/IProblem; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/CastExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/hierarchy/BindingMap; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/SwitchExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter9Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/impl/CompilerOptions; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/search/matching/MatchLocator; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/formatter/FormatterMassiveRegressionTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/generatedfile/GeneratedResourceChangeListener$PreBuildVisitor; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ModuleBuilderTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ast/LambdaExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/LambdaFactory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/dom/rewrite/TokenScanner; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/MethodVerifier15; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/build/AptBuilder; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-02-14T08:15:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hi all,
This is not a new thing but it is probably worth to look at this again (see for example bug https://bugs.eclipse.org/bugs/show_bug.cgi?id=434326).

When a library uses lots of generics (for example jOOQ) the org.eclipse.jdt.internal.compiler uses lots of CPU/memory resources parsing/analysing the generics resulting in an unresponsive UI.

For example, create a new project, add jooq-3.8.4.jar as library (https://www.jooq.org/download/license-accepted?type=oss&file=jOOQ-3.8.4.zip) and create a class containing the following one-liner:

SelectWhereStep<Record11<Long, String, Boolean, String, String, String, String, String, String, String, String>> step = DSL.selectFrom(DSL.values(DSL.row(1L, "bar", Boolean.TRUE, "a", "b", "c", "d", "e", "f", "g", "h")));

When you click save, Eclipse will take several seconds to refresh the workspace. If instead you paste the code below, Eclipse will freeze forever:

SelectWhereStep<Record13<Long, String, Boolean, String, String, String, String, String, String, String, String, String, String>> step = DSL.selectFrom(DSL.values(DSL.row(1L, "bar", Boolean.TRUE, "a", "b", "c", "d", "e", "f", "g", "h", "i", "j")));

I have shortly analyzed the Eclipse process with jvisualvm, it looks like that most of the time is spent in org.eclipse.jdt.internal.compiler.lookup.ConstraintTypeFormula.reduce() and org.eclipse.jdt.internal.compiler.lookup.BoundSet$ThreeSets.addBound().

It would be great if you could look at this again, since this issue is forcing some users to another IDE.

Thanks a lot in advance,
Ciaccia </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-02-14T09:00:23Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Did you try with latest and greatest I-build? http://download.eclipse.org/eclipse/downloads/ Lots of improvements in JDT core. But I'm not sure if they affect your scenario, adding Stefan as he is the master mind behind most of JDT core performance improvements with the JDT cache. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-02-14T10:32:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hi Lars,
I have tested it with Eclipse Oxygen (4.7M5) and the problem is still there. Also with latest (error free?) nightly build I20170212-2000 nothing changes... </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-02-19T17:24:41Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Missing name from comment #0)
> I have shortly analyzed the Eclipse process with jvisualvm, it looks like
> that most of the time is spent in
> org.eclipse.jdt.internal.compiler.lookup.ConstraintTypeFormula.reduce() and
> org.eclipse.jdt.internal.compiler.lookup.BoundSet$ThreeSets.addBound().

Thanks for analyzing. Unfortunately, there's little leeway in how we implement ConstraintTypeFormula.reduce(), it's pretty much a 1:1 copy of what is required by JLS. If our computation is wasteful (i.e., more wasteful than inherent complexity of Java 8 inference), then it'd have to be above or below, meaning: some operations invoked from reduce() could be more expensive than needed, or reduce() is called more often than needed.

The other method, ThreeSets.addBound() has a hidden option for experimental optimization, please see bug 476718 comment 30. Could you please set 
-Duseunspecdtypeinferenceperformanceoptimization=true
in eclipse.ini and report if this changes anything. I'm interested in differences both regarding performance and also whether new compile errors are raised with this option.

The index, OTOH, shouldn't play any role in this. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-02-22T14:05:48Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hallo Stephan,
I have tested this issue again setting the -Duseunspecdtypeinferenceperformanceoptimization=true flag in eclipse.ini as you suggested, nothing changed.

I have noticed something quite interesting: if in Eclipse (Neon or Oxygen) I go under Properties... -> Java Compiler -> JDK Compliance and I set Source Compatibility to 1.7 the problem disappears.

Is the performance problem due to the "improved type inference" (i.e. JEP 101 Generalized Target-Type Inference) support? Is there some documentation (rather that the code itself) that describe Eclipse's internal working?

Thanks again for your support </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-02-22T21:47:29Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Missing name from comment #4)
> Hallo Stephan,
> I have tested this issue again setting the
> -Duseunspecdtypeinferenceperformanceoptimization=true flag in eclipse.ini as
> you suggested, nothing changed.

Thanks for trying.

> I have noticed something quite interesting: if in Eclipse (Neon or Oxygen) I
> go under Properties... -> Java Compiler -> JDK Compliance and I set Source
> Compatibility to 1.7 the problem disappears.
> 
> Is the performance problem due to the "improved type inference" (i.e. JEP
> 101 Generalized Target-Type Inference) support?

Yep, type inference has been completely re-written, both in JLS and in ecj. It is more powerful now, which implies more complexity internally.

> Is there some documentation
> (rather that the code itself) that describe Eclipse's internal working?

The source code actually contains some documentation (mostly in class InferenceContext18 [1]), but be warned that this stuff *is* complex). Additionally, most parts of the new inference quite closely relate to JLS [2]. That's all the reading I could recommend.

[1] http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/tree/org.eclipse.jdt.core/compiler/org/eclipse/jdt/internal/compiler/lookup/InferenceContext18.java
[2] https://docs.oracle.com/javase/specs/jls/se8/html/jls-18.html </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-02-28T08:13:36Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hallo Stephan,
I thought about this and two things came to my mind.

1. the class InferenceContext18 does not have one single log statement... Would it make  sense to add some verbose logging to help debugging?

2. How difficult would be to execute the code in InferenceContext18 outside of the Eclipse UI? Would it be possible to create a "command line" application that takes some parameters (i.e. required libs and java source files), the org.eclipse.jdt.internal.compiler source classes and goes though InferenceContext18? The problem described in this bug does not require the UI, it appears by just refreshing/opening the workspace (so it is probably a good candidate for a command line test case). This would substantially make debugging easier without having to remote-debugging the Eclipse process.

Thanks a lot in advance for your help
Cheers </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-03-09T11:31:14Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Missing name from comment #6)
> Hallo Stephan,
> I thought about this and two things came to my mind.
> 
> 1. the class InferenceContext18 does not have one single log statement...
> Would it make  sense to add some verbose logging to help debugging?

This would have to be plain stdout logging, since the compiler cannot depend on any logging framework. I could easily identify a few locations that would generated megabytes of logs even for simple programs. :)
I'm not sure, you'd need very different logging approaches when debugging correct behaviour vs. analysing performance.
For the latter, the standard approach would be a profiler not logging, I believe. Do you have access to such a tool?

> 2. How difficult would be to execute the code in InferenceContext18 outside
> of the Eclipse UI? Would it be possible to create a "command line"
> application that takes some parameters (i.e. required libs and java source
> files), the org.eclipse.jdt.internal.compiler source classes and goes though
> InferenceContext18? The problem described in this bug does not require the
> UI, it appears by just refreshing/opening the workspace (so it is probably a
> good candidate for a command line test case). This would substantially make
> debugging easier without having to remote-debugging the Eclipse process.

Sounds like you are asking for the application called ecj (Eclipse compiler for Java) :) For debugging: just launch org.eclipse.jdt.internal.compiler.batch.Main

One more thing: I have observed previously that the following non-trivial method is invoked more frequently then necessary: org.eclipse.jdt.internal.compiler.lookup.ConstraintExpressionFormula.inputVariables(InferenceContext18)
Can you identify this as a hotspot in your use case?

Thanks for your investigations! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-03-10T04:34:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 513351 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-03-10T04:44:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 267204
simple test class that's slow to compile with JDT

Self-contained example class adapted from one of javaslang's classes, but without the dependencies. The class itself is less than 100 lines of code, maybe around 50 lines without comments and empty lines. It takes around 10 seconds for JDT to compile it.

I'm attaching in the hope that you might find it useful when debugging this JDT performance problem. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-10-12T22:58:04Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Perhaps what is done for javac as part of https://bugs.openjdk.java.net/browse/JDK-8051946 (and related issues) can help. I've noticed similar performance issues in compiling same classes with both Eclipse and javac (JDK 8). JDK 9 javac is much faster. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-10-13T22:48:43Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Marko Mitrovi� from comment #10)
> Perhaps what is done for javac as part of
> https://bugs.openjdk.java.net/browse/JDK-8051946 (and related issues) can
> help. I've noticed similar performance issues in compiling same classes with
> both Eclipse and javac (JDK 8). JDK 9 javac is much faster.

That approach is very specific to the implementation of javac - where they had their very own performance issues. Translating this into ecj would be a huge effort.

First we need to understand, what's slow in ecj... </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2017-10-15T22:18:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Of course. It was a long shot, but worth mentioning. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-01-21T20:11:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277215
visualvm snapshot when compiling test class with 6 type parameters </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-01-21T20:12:23Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277216
visualvm snapshot when compiling test class with 7 type parameters </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-01-21T20:14:56Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I'm also writing code with lots of type parameters and have problematic build times, too, so I guess I'm affected by this issue as well. I used visualvm to profile a test that invokes org.eclipse.jdt.internal.compiler.batch.Main in a Java 11 project in Eclipse 2018-12. The Main class was used to compile derived versions of the class attached by Nándor in comment 9. Nándor's class has 8 type parameters, I reduced them to 7 and 6 respectively, to speed up profiling and to be able to see the effect that an additional type parameter has on run-time complexity. It looks like adding the 7th type parameter slows compilation by a factor of 10.

I attached visualvm snapshots of the profiling sessions with 7 and 6 type parameters. Stephan (or someone else familiar with JDT): Could you have a look at the visualvm snapshots? I though it might be best to provide visualvm snapshots so you can browse the data yourself but I could also attach screenshots or whatever is suitable to move forward. I can also attach the code used for to this issue, should that be of interest.

I noticed the following when looking at the visualvm snapshots myself:
(1) compilation is *not* slowed down by excessive garbage collection
(2) ConstraintExpressionFormula.inputVariables(InferenceContext18) is not the topmost hotspot and its invocation count grows (only) from 966 to 1306 when using 6 vs. 7 type parameters. It might still be relevant, though.
(3) BoundSet.dependsOnResolutionOf(...), InferenceVariable.hashCode() and InferenceContext18.addDependencies(...) have the highest self times among the classes in the org.eclipse.jdt.internal.compiler.lookup package
(4) The invocation counts of BoundSet.dependsOnResolutionOf(...) grows by a factor of 10 when comparing 6 vs. 7 type parameters (152.438 vs. 1.529.481) and its source code has the following comment: // TODO: optimization: consider separate index structure (by IV)
(5) BoundSet.dependsOnResolutionOf(...) is invoked by 
    InferenceContext18.addDependencies(...) which is invoked by 
    InferenceContext18.getSmallestVariableSet(...)
    There are multiple paths between these methods: I analyzed the one that contains addDependencies(...) 4 times. Here, 
    InferenceContext18.getSmallestVariableSet(...) has 416 vs. 537 invocations for 6 vs. 7 type parameters whereas
    InferenceContext18.getSmallestVariableSet(...) invokes InferenceContext18.addDependencies(...) 3.584 vs. 10.224 times for 6 vs. 7 type parameters. This spread gets worse for the recursive 2nd, 3rd and 4th invocations of InferenceContext18.addDependencies(...):
2nd: 21.631 vs. 175.347
3rd: 25.215 vs. 185.571
4th: 148.540 vs. 1.503.059 I.e. this might be the area where the growth in complexity comes from when more type parameters are added?!

Thanks in advance for your thoughts! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-01-22T10:29:07Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Those Visual VM snapshots show similar hotspots as my analysis in this issue here: https://bugs.eclipse.org/bugs/show_bug.cgi?id=543480 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-03T20:37:11Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I analyzed the problem a bit further:
(1) The optimization proposed in the TODO comment "optimization: consider separate index structure (by IV)" in BoundSet.dependsOnResolutionOf(...) does not seem to be applicable to the test class attached by Nándor. I added print statements to show the number of captures that the index is supposed to be based on, but there are no captures at all.
(2) I tried to cache the results of BoundSet.dependensOnResolutionOf(...) in a Map in InferenceContext18 but that slowed down compilation.
(3) I then added print statements to InferenceContext18.addDependencies(...) to show the contents of InferenceContext18.inferenceVariables that this method iterates over. I found that there are many duplicates in this array. E.g. for 7 type parameters, there are many invocations when there are 145 elements in inferenceVariables but only 7 unique ones. So I wrote a hack that maintains a Set InferenceContext18.uniqueInferenceVariables alongside InferenceContext.inferenceVariables. That reduces compile times considerably: for 6 type parameters, the CPU time in the Compiler Processing Task is reduced from 1.870 ms to 1.198 ms, for 7 type parameters, it is reduced from 9.974 ms to 2.361 ms. Invocations of BoundSet.dependsOnResolutionOf(...) for 6 type parameters are reduced from 152.438 to 22.036 and for 7 type parameters from 1.529.481 to 114.254. So this might be a potential optimization. I assume that using unique input variables is a valid optimization when determining dependencies - I'm quite clueless in this area, though.
(4) It would be interesting to know why there are so many duplicates in InferenceContext18.inferenceVariables and whether unique values could be used in other places that use InferenceContext18.inferenceVariables.

If there are no comments suggesting to head into another direction, I'll clean up the code and submit it to Gerrit so the fix is available for others (via Gerrit) and can be reviewed/discussed there. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-03T23:31:26Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Thanks a lot, Sebastian, for your analysis!

Your mentioning of duplicate InferenceVariables piqued my curiosity, and I found those to be added on this path:

InferenceContext18.resumeSuspendedInference(InferenceContext18$SuspendedInferenceRecord) line: 1605	
ConstraintExpressionFormula.reduce(InferenceContext18) line: 139	
BoundSet.reduceOneConstraint(InferenceContext18, ConstraintFormula) line: 869	
BoundSet.reduceOneConstraint(InferenceContext18, ConstraintFormula) line: 885	
InferenceContext18.inferInvocationType(TypeBinding, InvocationSite, MethodBinding) line: 465	
ParameterizedGenericMethodBinding.computeCompatibleMethod18(MethodBinding, TypeBinding[], Scope, InvocationSite) line: 270	

The situation in ConstraintExpressionFormula.reduce() is the following:
During outer inference for a message send (flatMap()), we have a contraint mentioning the inner poly invocation (map() in my case, but it could be the next inner invocation of flatMap() as well). So we start a nested inference for map() and when that one completes, we integrate the content of the inner InferenceContext18 with the previous results. This per se is correct.

One thing we need to check: if at some level overloading requires us to resolve the same thing with various overload candidates, does that mean we duplicate the same data right in resumeSuspendedInference()? Or more to the point here: repeated inference of the same thing probably results from the fact that each level of inference can only complete when both its inner and outer inferences have completed before - well almost. Truth is: we have to navigate a heavy up-and-down traversal until incrementally all levels of inference share the same information.

In the debugger it looks weird in what deep recursion all this happens, but that recursion only reflects the nested structure in the input program.

(In reply to Sebastian Lohmeier from comment #17)
> [...] So I wrote a hack
> that maintains a Set InferenceContext18.uniqueInferenceVariables alongside
> InferenceContext.inferenceVariables.
This is an interesting experiment performancewise, but will probably create wrong results as order in the array is relevant.

>  I'm quite clueless in this area, though.
Don't worry, it's the most complex piece of software I've written in my career, and when debugging it with such a complex input program, I'm impressed at what you found out so far :) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-08T11:09:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277507
Test class with 2 type parameters </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-08T11:09:39Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277508
Test class with 3 type parameters </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-08T11:10:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277509
Trace of inference contexts for test class with 2 type parameters </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-08T11:11:12Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277510
Trace of inference contexts for test class with 3 type parameters </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-08T11:19:52Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Thanks for your input, Stephan!

(In reply to Stephan Herrmann from comment #18)
> One thing we need to check: if at some level overloading requires us to
> resolve the same thing with various overload candidates, does that mean we
> duplicate the same data right in resumeSuspendedInference()? Or more to the
> point here: repeated inference of the same thing probably results from the
> fact that each level of inference can only complete when both its inner and
> outer inferences have completed before - well almost. Truth is: we have to
> navigate a heavy up-and-down traversal until incrementally all levels of
> inference share the same information.

Ok, I tried some more stuff: I created variants of Nándors sample classes with 2 and 3 type parameters respectively: TestFor2TypeParameters (attachment 277507) and TestFor3TypeParameters (attachment 277508). I then added debug statements to trace InferenceContext18 instances. That yield two traces: attachment 277509 and attachment 277510. The trace has the format <System.identityHashCode(...) of the InferenceContext18 instance> followed by details on the method of InferenceContext18 being invoked and the invocation site it belongs to. It also includes information on InferenceContext18.inferenceVariables. When a new InferenceContext18 is created for a given outer context, it is indented by one more level. A stack trace is included for the first line in InferenceContext18.enterPolyInvocation(...). The line numbers in the stack trace should match the line numbers in the Git HEAD - the debug code is added to existing lines.

Looking at the traces, you see that for TestFor2TypeParameters,
InferenceContext18.enterPolyInvocation(...) is invoked only once, whereas
for TestFor3TypeParameters it is invoked more than once - for the same method
invocation. E.g. the first two stack traces are for the same invocation
stream(ts3).map((<no type> t3) -> f.apply(t1, t2, t3))
with arguments [(<no type> t3) -> f.apply(t1, t2, t3)]:

enterPolyInvocation([...]) suspending this.inferenceVariables=[R#5]
resumeSuspendedInference([...] record.inferenceVariables=[R#5]) this.inferenceVariables=[R#7]
After resumeSuspendedInference(...) this.inferenceVariables=[R#5, R#7]

enterPolyInvocation([...]) suspending this.inferenceVariables=[R#5, R#7]
resumeSuspendedInference([...] record.inferenceVariables=[R#5, R#7]) this.inferenceVariables=[R#7]
After resumeSuspendedInference(...) this.inferenceVariables=[R#5, R#7, R#7]

The top elements of the two associated stack traces are

InferenceContext18.enterPolyInvocation(InferenceContext18.java:1570)
ConstraintExpressionFormula.reduce(ConstraintExpressionFormula.java:103)
BoundSet.reduceOneConstraint(BoundSet.java:869)
BoundSet.reduceOneConstraint(BoundSet.java:885)
InferenceContext18.reduceAndIncorporate(InferenceContext18.java:1092)
InferenceContext18.lambda$2(InferenceContext18.java:584)
InferenceContext18.collectingInnerBounds(InferenceContext18.java:528)
InferenceContext18.addJDK_8153748ConstraintsFromFunctionalExpr(InferenceContext18.java:584)
InferenceContext18.addJDK_8153748ConstraintsFromExpression(InferenceContext18.java:562)
InferenceContext18.addJDK_8153748ConstraintsFromInvocation(InferenceContext18.java:547)
InferenceContext18.inferInvocationType(InferenceContext18.java:418)
ParameterizedGenericMethodBinding.computeCompatibleMethod18(ParameterizedGenericMethodBinding.java:270)

and

InferenceContext18.enterPolyInvocation(InferenceContext18.java:1570)
ConstraintExpressionFormula.reduce(ConstraintExpressionFormula.java:103)
BoundSet.reduceOneConstraint(BoundSet.java:869)
BoundSet.reduceOneConstraint(BoundSet.java:885)
InferenceContext18.inferInvocationType(InferenceContext18.java:465)
ParameterizedGenericMethodBinding.computeCompatibleMethod18(ParameterizedGenericMethodBinding.java:270)

So this is a minimal case where duplicate inference variables are added.
Most likely these two enterPolyInvocation(...) invocations are required
- what do you think?

(In reply to Stephan Herrmann from comment #18)
> (In reply to Sebastian Lohmeier from comment #17)
> > [...] So I wrote a hack
> > that maintains a Set InferenceContext18.uniqueInferenceVariables alongside
> > InferenceContext[sic!].inferenceVariables.
> This is an interesting experiment performancewise, but will probably
> create wrong results as order in the array is relevant.

Since you mentioned that order in the array is relevant, I searched through
the code, but wasn't able to identify a spot where it was clear to me that
the order of InferenceContext18.inferenceVariables was relevant when iterating
over the array. I might have missed something, thought, and there might be
other implicit dependencies on the order. Thanks to your reply I also found
that InferenceContext18.resumeSuspendedInference(...) puts the resumed
inference variables at the beginning of the resulting array, i.e. at least
establishes some explicit order!
	
Out of curiosity: Do you know why this order is chosen or which parts of the code depend on the order in InferenceContext18.inferenceContext?

Besides that: If only order was relevant and it were ok to remove duplicates,
could duplicates be removed (actually: not be added) in resumeSuspendedInference(...)?

Thanks for your help! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-09T16:47:46Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I just found out that setting InferenceContext18.SHOULD_WORKAROUND_BUG_JDK_8153748 to false leads to a situation where InferenceContext18.inferenceVariables contains no duplicates and compilation is faster (less than 50% of the time taken when SHOULD_WORKAROUND_BUG_JDK_8153748==true for the program provided by Nándor). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-10T19:03:43Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Lohmeier from comment #23)
> Since you mentioned that order in the array is relevant, I searched through
> the code, but wasn't able to identify a spot where it was clear to me that
> the order of InferenceContext18.inferenceVariables was relevant when
> iterating
> over the array. I might have missed something, thought, and there might be
> other implicit dependencies on the order. Thanks to your reply I also found
> that InferenceContext18.resumeSuspendedInference(...) puts the resumed
> inference variables at the beginning of the resulting array, i.e. at least
> establishes some explicit order!
> 	
> Out of curiosity: Do you know why this order is chosen or which parts of the
> code depend on the order in InferenceContext18.inferenceContext?

I just had another look at this aspect. Yes, it was the comment in resumeSuspendedInference() that cautioned me to speak of order. But right now I experimentally changed order exactly here and ran the GenericsRegressionTest_1_8 suite and saw no regression. Running some more tests as we speak.

The said comment was there since day one of that particular method. I may have been overly cautious as at the same time I introduced similar array merging for IC18.initialConstraints where order is relevant, since IIRC more constraints can be added during iterating over the array. This doesn't seem to happen for inferenceVariables.

This should give us a little room to breathe :) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-10T19:09:07Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Lohmeier from comment #24)
> I just found out that setting
> InferenceContext18.SHOULD_WORKAROUND_BUG_JDK_8153748 to false leads to a
> situation where InferenceContext18.inferenceVariables contains no duplicates
> and compilation is faster (less than 50% of the time taken when
> SHOULD_WORKAROUND_BUG_JDK_8153748==true for the program provided by Nándor).

This confirms that method addJDK_8153748ConstraintsFromInvocation() has a finger in the pie. You may have seen that this is not a workaround for our own problem, but for lack of specification in JLS how a particular desired behaviour should be achieved. So, yes, this is not mandated by JLS, but no, we cannot disable that part nor do we have a better strategy.

At best, we can remember when we are working below addJDK_8153748ConstraintsFromInvocation() to apply some optimization only in that control flow. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-10T20:31:56Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Here's an idea:

InferenceContext18 could remember from which inner contexts it has already adopted inference variables. If resumeSuspendedInference() is called in a situation where the same inner context was handled for a second time, then it could go into detailed operation, i.e., perform IV-merging as a true set operation.

This would additionally require feeding 'innerCtx' from 
ConstraintExpressionFormula.reduce() into resumeSuspendedInference().

That should at least avoid the duplicate inference variables.

Your analysis could also be read as a hint that the same computation is performed more than once. This is quite possible, but avoiding repeated computations would require a deeper understanding. Unfortunately, truly understanding this particular code section is already a huge challenge, specifically because ecj tries to serve two masters: implement JLS and accept the same programs that javac does. After long mail threads with JLS author and javac engineer, we still haven't come to a full, common understanding of type inference. SHOULD_WORKAROUND_BUG_JDK_8153748 is an example of tweaks that we applied contrary to JLS, just to make ecj more similar to javac. 
Long story short: I'm reluctant to make any changes that could affect observable behavior, because the ice on which all this is built is quite thin. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-11T19:31:01Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Yup, that's a good solution, thank you!

How should we proceed? Should I write a test and a fix and submit it to Gerrit? Or would you like to do that? (In the latter case I'd analyze bug 543480 further as the solution for this issue doesn't help there.) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-12T13:00:23Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Lohmeier from comment #28)
> Yup, that's a good solution, thank you!
> 
> How should we proceed? Should I write a test and a fix and submit it to
> Gerrit? Or would you like to do that? (In the latter case I'd analyze bug
> 543480 further as the solution for this issue doesn't help there.)

I'd much appreciate a gerrit from you, so I can focus on other pressing issues.

LMK if you need help. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-17T18:58:07Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/137091 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-17T19:47:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I submitted a change to Gerrit. I wanted to implement it (unit) test-driven but was not able to simply add it to org.eclipse.jdt.core.tests.compiler.regression.GenericsRegressionTest (that I found suitable) because SuspendedInferenceRecord is not public. It might be possible to write a performance test, but I didn't find a suitable spot. I'm also not familiar with the testing practices in this project. Please let me know if you can come up with an idea for a suitable test!

I performed a rudimentary performance comparison, this time without VisualVM. All tests were performed 6 times in a loop and were based on Nándor's example, with modifications to the number of type parameters. Times are in milliseconds.

1 type parameter:
unoptimized: 2207, 518, 461, 294, 317, 255
  optimized: 1809, 426, 434, 220, 417, 262

2 type parameters:
unoptimized: 1813, 547, 403, 373, 339, 281
  optimized: 2175, 430, 397, 297, 372, 397

6 type parameters
unoptimized: 2581, 685, 654, 632, 492, 352
  optimized: 2567, 593, 479, 410, 477, 381

7 type parameters:
unoptimized: 2852, 590, 552, 522, 442, 432
  optimized: 2610, 662, 674, 403, 556, 461

8 type parameters (Nándor's example):
unoptimized: 6112, 1514, 1412, 1261, 1210, 1138
  optimized: 2515,  616,  595,  583,  385,  441

9 type parameters:
unoptimized: 4637, 1756, 1549, 1507, 1590, 1411
  optimized: 2721,  803,  672,  587,  583,  519 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-17T22:53:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Thanks Sebastian!
I'll take a look. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-29T20:40:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Any update on the Gerrit review? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-29T07:13:49Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Any update on the review?

This issue is now over 2 years old and the milestones for 2019-06 are progressing, I'd like to see progress on this issue so it gets included in 2019-06 and I can get it off my head. Thank you! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-29T07:30:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Lohmeier from comment #34)
> Any update on the review?
> 
> This issue is now over 2 years old and the milestones for 2019-06 are
> progressing, I'd like to see progress on this issue so it gets included in
> 2019-06 and I can get it off my head. Thank you!

Sebastian, first of all thanks for the Gerrit.
I typically recommend to use our public channels to make the team aware of missing review feedback.

Please send an email to https://accounts.eclipse.org/mailing-list/jdt-dev asking for a review and explain why this review is important (for you). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-29T11:10:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Lohmeier from comment #34)
> Any update on the review?
> 
> This issue is now over 2 years old and the milestones for 2019-06 are
> progressing, I'd like to see progress on this issue so it gets included in
> 2019-06 and I can get it off my head. Thank you!

Sebastian, can you please attach a simple reproducible test case that really "freezes" Eclipse? I've tried all attached files, but they seem to compile in milliseconds area. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-29T12:01:01Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 278428
Test class with 10 type parameters

Thanks for helping, Andrey! I attached an example which is a variant of Nándor's example from comment 9 that uses 10 instead of 8 type parameters. I use a dual-core machine with Eclipse 2019-03 without the contributed optimization and code mining enabled for showing method parameter names. On that machine the attached example uses both cores for about 100 seconds and one core for an additional 40 seconds on each compilation run ("Building workspace"). When I e.g. try to perform a rename refactoring via CTRL+ALT+R shortly after building started, the rename refactoring won't start before building is complete. (I also created a variant with 9 type parameters that maxes both cores for about 10 seconds, but the results for 10 type parameters is even clearer.) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-29T12:20:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Lohmeier from comment #37)
> Created attachment 278428 [details]
> Test class with 10 type parameters
> 
> Thanks for helping, Andrey! I attached an example which is a variant of
> Nándor's example from comment 9 that uses 10 instead of 8 type parameters. I
> use a dual-core machine with Eclipse 2019-03 without the contributed

Yep, I can confirm that on a 16 core Xeon with 128 GB RAM this example fully loads one CPU during compilation for some ~30 seconds, and the patch changes this to almost instant compile. Unfortunately I have no clue about the related API, so can't say anything about the changed code itself. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-29T13:32:57Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #32)
> Thanks Sebastian!
> I'll take a look.

despite the delay, this promise still holds :)

Thanks, Sebastian, for pinging.
Thanks Andrey for confirming the performance effect. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-01T21:46:14Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #25)
> (In reply to Sebastian Lohmeier from comment #23)
> > Since you mentioned that order in the array is relevant, I searched through
> > the code, but wasn't able to identify a spot where it was clear to me that
> > the order of InferenceContext18.inferenceVariables was relevant when
> > iterating
> > over the array. I might have missed something, thought, and there might be
> > other implicit dependencies on the order. Thanks to your reply I also found
> > that InferenceContext18.resumeSuspendedInference(...) puts the resumed
> > inference variables at the beginning of the resulting array, i.e. at least
> > establishes some explicit order!
> > 	
> > Out of curiosity: Do you know why this order is chosen or which parts of the
> > code depend on the order in InferenceContext18.inferenceContext?
> 
> I just had another look at this aspect. Yes, it was the comment in
> resumeSuspendedInference() that cautioned me to speak of order. But right
> now I experimentally changed order exactly here and ran the
> GenericsRegressionTest_1_8 suite and saw no regression. Running some more
> tests as we speak.
> 
> The said comment was there since day one of that particular method. I may
> have been overly cautious as at the same time I introduced similar array
> merging for IC18.initialConstraints where order is relevant, since IIRC more
> constraints can be added during iterating over the array. This doesn't seem
> to happen for inferenceVariables.
> 
> This should give us a little room to breathe :)

Another search through uses of IC18#inferenceVariables confirms, that my worries regarding order should be unnecessary. The hotest candidate was in InferenceSubstitution, where the variables array is shared with an IC18. Both substitute() methods iterate over #variables and use the same index 'i' also in invocation of getP(i), giving the index some relevance. Checking the two existing implementations of getP(), however, dispels the worries. So let's close the issue of order as a red herring. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-01T22:20:32Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I updated the gerrit:
- added tests with 3 & 10 levels to GRT_1_8 (not strictly performance tests ..)
- polished the impl:
  - remove comments about order after worries have been put aside
  - micro optimization to access seenInnerContexts only once
- rebased

For now I believe this is good (tests pending), but then I found s.t. else fishy: when we see an innerContext for the second time, it isn't actually an inner context, it is a fresh context for the same MessageSend as the current context.

Apparently, our cashing in MessageSend#inferenceContexts isn't as effectively as one might hope. (It's bad enough that copies of the enclosing lambdas will create new copies of the enclosed MessageSend, requiring fresh new IC18 in each of these universes...).

=> May want to investigate this in a follow-up bug. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-03T18:42:07Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/137091 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=116c160724dfe3a8d68edaf406d0ec168fce56ef </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-03T18:46:19Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #41)
> [...] I found s.t. else
> fishy: when we see an innerContext for the second time, it isn't actually an
> inner context, it is a fresh context for the same MessageSend as the current
> context.
> 
> Apparently, our cashing in MessageSend#inferenceContexts isn't as
> effectively as one might hope. (It's bad enough that copies of the enclosing
> lambdas will create new copies of the enclosed MessageSend, requiring fresh
> new IC18 in each of these universes...).
> 
> => May want to investigate this in a follow-up bug.

=> bug 546972

(In reply to Eclipse Genie from comment #42)
> Gerrit change https://git.eclipse.org/r/137091 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=116c160724dfe3a8d68edaf406d0ec168fce56ef

Released to master for 4.12 M3

Thanks, Sebastian! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T17:15:24Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Thanks for the review, Stephan! I'm happy we finished this! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-12T11:19:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I noticed a new test failure in our back-to-back tests with javac [1]

Since we have a "normal" compile error, the excuse for comparison is bogus in this particular test. Fixed via https://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=b150a823927c3586fa8e11a2cb098c3e2dbbc1e5


[1] https://ci.eclipse.org/jdt/job/eclipse.jdt.core-run.javac-1.8/97/testReport/org.eclipse.jdt.core.tests.compiler.regression/AnnotationTest/testBug546084b___1_8/ </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-12T11:45:11Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I commented on the wrong bug, marking comment as OBSOLETE. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T15:44:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Verified for Eclipse Version: 2019-06 (4.12) Build id: I20190520-0600 </td> </tr>
        </table>
</body>
</html>
