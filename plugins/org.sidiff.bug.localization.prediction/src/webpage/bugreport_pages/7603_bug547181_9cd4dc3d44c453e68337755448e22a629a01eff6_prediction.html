<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 547181 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> [9][impl] Reconsider representation and lookup of packages (SplitPackageBinding) </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2019-05-11T11:33:26Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> VERIFIED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 548699 - [dom] proposal for a new API for AST for preview

Change-Id: I821aca059451b5a8a8c619ee9085ade8cf2f7f73
Signed-off-by: Sarika Sinha <sarika.sinha@in.ibm.com> </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2019-07-03T09:14:30Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavaProject$JImageModuleFragmentBridge; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleBinding; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavaModelAccess; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ExternalPackageFragmentRoot; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IDOMFactory; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NameLookupTests2; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> PackageBinding; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleInfoBuilder; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterJavadocTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> INameEnvironment; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BindingMap; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleUtil; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GenericsRegressionTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CodeFormatterApplication; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClasspathUtil; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClasspathDirectory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Parser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IPolyExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RunCompilerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTRewrite; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> DefaultCodeFormatterOptions; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> PackageInfoTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractModule$AutoModule; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompletionParser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> DatabaseRef; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IndexBinaryType; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IModuleDescription; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Util; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/JavaProject$JImageModuleFragmentBridge; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/ModuleBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/provisional/JavaModelAccess; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/ExternalPackageFragmentRoot; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ModuleBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/jdom/IDOMFactory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/NameLookupTests2; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ModuleBuilderTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/PackageBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/builder/ModuleInfoBuilder; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterJavadocTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/RecoveredPackageBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/env/INameEnvironment; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/JrtPackageFragmentRoot; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/hierarchy/BindingMap; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/codeassist/CompletionEngine; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/JModPackageFragmentRoot; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/TypeBinding; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS3; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/util/ModuleUtil; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/util/Util; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/env/INameEnvironmentExtension; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter18Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/formatter/CodeFormatterApplication; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/lookup/LookupEnvironment; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/JavaModelManager; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/generatedfile/ClasspathUtil; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/batch/ClasspathDirectory; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T11:33:26Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Triggered by discussion in bug 547113 I'm putting a central design decision from the BETA_JAVA9 time back on the table for discussion: SplitPackageBinding.

While at that time, I saw now other way to reconcile ecj with new rules of Java as they were gradually being revealed to us, this concept has caused significant grief: 

Incorrectly wired SplitPackageBindings are difficult to debug, because typically the error occurs much earlier than any symptom becomes visible.

Most recently we observed that the desire to fully wire SplitPackageBinding on lookup may lead to re-entrance that is hard to resolve (viz. the current implementation has a cut off mechanism which may cause some SPBs to remain incomplete).

I will add a sequence of comments capturing context, constraints, requirements etc. as input for the discussion. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T11:35:13Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Setting milestone to 4.12 just to keep it on the radar. Most likely we will move this to 4.13 once that milestone exists in bugzilla. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T12:18:39Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> == (1) Qualified Names & the Package Hierarchy ==

Our implementation represents packages in a hierarchy where package p is the parent of p.q, so in order to lookup p.q we first lookup p.

NB: the lookup of widely shared parent packages (like com, java, even java.lang etc.) contributes the lion's share of SPB instances. Mostly, toplevel packages don't contain types, but still our algorithm needs to fully wire them all from all contributing modules. For second-level packages, typically one JRE module will contain types and others only contribute types in "sub-packages". javax.security appears to be an example of an "empty" second-level package, split among several modules.

Semantically we know that the parent-child relation between packages bears no significance.

=> So, if this hierarchical representation causes grief it could - in theory - be dropped from our implementation.

--- Taking a little excursion into JLS we find this: ---

"""
6.5.3.2. Qualified Package Names

If a package name is of the form Q.Id, then Q must also be a package name. The package name Q.Id names a package that is the member named Id within the package named by Q.

If Q.Id does not name a package that is uniquely visible to the current module (§7.4.3), then a compile-time error occurs.
"""

In my interpretation, the question "what is the meaning of Q?" requires to apply 6.5.3.* recursively, which seems to indicate that JLS defines packages as a hierarchy indeed. 

My question to the jigsaw mailing list, if this wouldn't prohibit split parent packages (even if empty), was answered by informing me that "6.5.3.2 did not, and does not, recurse into 6.5.3.1 when the Q in the qualified name Q.Id is simple".[1]

At this point I personally stopped paying any attention to the first sentence of 6.5.3.2, because I have no idea how to reconcile the text in JLS with the answer on the mailing list. This is not a good position to be in, but for me communication has failed in this point.

--- end JLS excursion ---


Unfortunately, when we have a qualified name p.q.r we hardly ever know up-front which portion of this name is a package name. Lookup always has to anticipate three subsequences of any qualified name:
- packages
- classes and static inner classes
- fields
A qualified name can start and stop anywhere in this list.

Additionally, the rules about name clashes need to be truthfully implemented. A simple / odd example being:
What if we have
  package a.b.c with class C
  package a with class b
does class 'a.b' clash with a package 'a.b'??
Answer: yes (disregarding the fact that package a.b doesn't really "exist").


We still have both options for representing packages: hierarchy or flat. But even with a flat representation lookup probably has to be done in a loop, starting with a simple identifier and gradually adding more segments.

Current status:
- LookupEnvironment#knownPackages -> PackageBinding -> knownPackages is a tree
- ModuleBinding#declaredPackages is a flat map (fqn -> PackageBinding)

[1] http://mail.openjdk.java.net/pipermail/jigsaw-dev/2017-May/012488.html </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T12:30:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> == (2) Cycles and re-entrance ==

The design document "State of the Module System" [1] happily declares as its core principle: "reliable configuration", which is meant to imply "The module system ensures [...], that the module graph is acyclic [...]"

Theory speaking.

Enter automatic modules.

Specification about the module graph, aka readability graph is not given in JLS but in the javadoc of package java.lang.module [2]. Here we find:
""" For each enumerated module X that is automatic: X "reads" every other enumerated module (it is "as if" an automatic module has 'requires' directives for every other enumerated module). 
"""

Now all you need is a module M that requires an automatic module X, and as per the above rule X will read M and you have a cycle already.

Ergo: every module graph where an automatic module is requires has at least one cycle.

This is bad.

Ergo: every traversal along 'requires' (aka 'reads') edges must handle re-entrance.

Current state of our implementation: We use ModuleBinding#isPackageLookupActive as a kludge to prevent infinite recursion, but we have no guarantee that the outcome is semantically correct. In fact the core observation in bug 547113 is: our lookup is incomplete, because we simply block re-entrance as detected via this flag.


[1] https://openjdk.java.net/projects/jigsaw/spec/sotms/
[2] http://cr.openjdk.java.net/~mr/jigsaw/spec/api/java/lang/module/package-summary.html </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T12:51:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> == (3) Eager vs. Lazy ==

The original design of lookup in ecj is completely demand driven. I.e., you can immediately start resolving packages & types etc. without first establishing a big universe of bindings. Of course, some types java.lang.* are always pulled in, but this set is small, bootstrapped mainly from the role of j.l.Object within JLS.

Essentially, this design principle is still obeyed in the current implementation.

Conceptually, some computations could be simplified if we add an initial, eager phase of "establishing the module graph".

Ecj has the specific constraint (different from javac) that we want to incur only minimal effort during incremental compilation / reconcile: compilation-as-you-type cannot afford a significant warmup phase where an entire universe of bindings is created before the text in your current editor is processed.

Obviously, such performance-constraint must be backed by measurements to become effective..

We still have some variables to fine tune in order to strike a good balance between eager and lazy:

* Reading only "a bunch of" module-info.{java,class} should be affordable

* Creating PackageBindings just from what we find in module-info might be affordable.

* Searching for CUs within each package for validation may not be affordable

* Eagerly resolving non-exported packages is not a good idea


Technically, such eager phase could possibly be integrated as the first action in LookupEnvironment#completeTypeBindings(). This requires that we avoid *any* traversal of the module graph during LE#buildTypeBindings(CUD). See in particular the stack trace from bug 547113 comment 1, where buildTypeBindings triggers such traversal (via createPackage -> addPackage -> combineWithPackagesFromOtherRelevantModules) before even all input units have their bindings built. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T13:17:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> == (4) fully qualified names are not unique ==

Almost forgot this constraint, which triggered the invention of SplitPackageBinding in the first place (see bug 517808 comment 5):

In Java 9+, a fully qualified name p.q.C need not be unique!

The compiler must accept and understand that this name could refer to several different classes, depending on where this name occurs. As long as unique visibility of packages is ensured, this situation is not a name clash.

In a nice world, the module system would use module boundaries to ensure that compilation of one module is never forced to see different classes of the same qualified name. BUT, by allowing API leaks, this opportunity is missed, and the full complexity of non-unique qualified names hits the compiler.

In my book this is huge collateral damage of a sub-optimal (language) design decision.


For the use case of looking up a type in a given package we have two options:

(a) Either the package must already encode the point of view (module) to find the type that is visible at the location where the FQN occurs.

(b) Or behind a global (i.e., module-agnostic) PackageBinding we need a structure for per-module lookup of types.

Option (a) is materialized in SplitPackageBinding. Perhaps some fine tuning of this design is possible, but I doubt that this will create a huge benefit.

Option (b) would require
- that every p.getType(name) lookup additionally passes the module.
  (This is given for getType() but not for getType0() - 20 callers)
- that PB maintains s.t. like
  - a mapping "moduleName x typeName -> TypeBinding", or
  - a mapping "typeName -> List<TypeBinding>"
    where each binding knows to which module it is associated
- that PB implements a lookup strategy to *find* the correct type for the
  given module perspective.
  
Since option (b) is essentially uncharted territory I will not try to assess feasibility just yet.

I see, however, a chance that this choice (a) vs. (b) turns out to be a red herring. I might become a non-issue if we find a smart answer, e.g., in topic (3). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T21:50:10Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #5)
> == (4) fully qualified names are not unique ==
> 
> In a nice world, the module system would use module boundaries to ensure
> that compilation of one module is never forced to see different classes of
> the same qualified name. BUT, by allowing API leaks, this opportunity is
> missed, and the full complexity of non-unique qualified names hits the
> compiler.

I'm not quite sure I understand the problem: FQN appear in types, which belong to a module. 

FQNs must always be resolved via the LE belonging to that Module, which doesn't see unexpected packages from other modules. 

And types are compared not by there FQN, but via there bindings, so there should not really be an issue. 

Only the TypeBindings of the "leaked" types are every visible (e.g. for return types of methods), but their names should never matter.

> 
> For the use case of looking up a type in a given package we have two options:

Maybe I overlook something here, but the PackageBinding.getType* methods are not about FQN, but about simple names and a PackageBinding should always only return types that belong to itself (i.e. are defined in its module.). 

The point is to make sure that the right PackageBinding is asked (I wonder if there are actually any cases where that is not done already?)

BTW: I think we should probably not at all create PackageBindings for packages that only contain subpackages. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T21:51:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #6)
> (In reply to Stephan Herrmann from comment #5)
> doesn't see unexpected packages from other modules. 

Stupid auto-correction, this should have been:
> doesn't see _unexported_ packages from other modules. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-11T23:59:31Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #6)
> BTW: I think we should probably not at all create PackageBindings for
> packages that only contain subpackages.

With this you are suggesting to entirely drop the hierarchical representation, right?

Currently, qualified names are resolved segment by segment: keep searching packages as long as you find more. If no sub-package is found switch to searching types.

Just one example of an algorithm that would need to be re-written if prefixes of a qualified name don't have a binding representation. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-12T00:57:16Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #6)
> (In reply to Stephan Herrmann from comment #5)
> > == (4) fully qualified names are not unique ==
> > 
> > In a nice world, the module system would use module boundaries to ensure
> > that compilation of one module is never forced to see different classes of
> > the same qualified name. BUT, by allowing API leaks, this opportunity is
> > missed, and the full complexity of non-unique qualified names hits the
> > compiler.
> 
> I'm not quite sure I understand the problem: FQN appear in types, which
> belong to a module. 
> 
> FQNs must always be resolved via the LE belonging to that Module, which
> doesn't see unexpected packages from other modules. 

In a nice world, none of this would be needed, because every compilation only touches types visible to the focus module. We could still be using one single LE and one single hierarchy (if we want) of package bindings. The old compiler design pre Java 9 would have required only tiny changes to become a fully module-aware compiler (just like we did compile OSGi bundles all the way).
 
> And types are compared not by there FQN, but via there bindings, so there
> should not really be an issue. 
> 
> Only the TypeBindings of the "leaked" types are every visible (e.g. for
> return types of methods), but their names should never matter.

If lookup is indeed just a function FQN x module->Binding then - perhaps - you are right, but unfortunately I'm not quite there yet. It's perhaps indeed the hierarchical structure of packages that prevents me from seeing a simple solution.

But if you look closely at JLS §6.5.2, you'll see that *classification* of qualified names is indeed specified in a segment-by-segment way.

To me this implies, the package part of a FQN is only known after resolution, but you seem to suggest to use it as the input for resolution.

So if you favor the flat representation, I suggest you have a look at JLS §6.5 and its implementation in and around Scope.getTypeOrPackage(). Maybe you can suggest an alternative algorithm to achieve the same on a different representation. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-12T10:11:53Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> == (5) Caching ==

From looking at current code, a key design factor was not only to give the correct answers, but to avoid redundant computation.

This is relevant because same / similar questions will be asked many times during compilation. Please see that each resolution of a qualified name may potentially trigger a flood of calls to the NameEnvironment: 

First dimension is piecemeal processing of the name: is p a type? is p.q a type? is p.q.C a type?

Second dimension: is p.q a type in my current module? Is it a type in one of my (transitively) required modules?


Ergo: it is relevant to remember both positive and negative answers in order to significantly reduce the number of calls into the NameEnvironment (which is generally thought to be more expensive than any lookup we do within the compiler).


In the current design, negative answers are cached using TheNotFoundType and TheNotFoundPackage. It is interesting to note, that the hierarchical strategy only needs one map entry "com" -> TheNotFoundPackage to avoid *all* queries about com.*.* inside the current environment.

A non-hierarchical representation of packages needs to be accompanied with a new caching story in order to achieve similar performance. For this new strategy it may or may not be relevant to also minimize the number of negative cache entries: in a worst case each type in the system could require a cache entry (positive or negative) in *every* known module. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-12T16:53:52Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The text in 6.5.3 is certainly sloppy, but I think we agree that the intention is that "uniquely visible" is only supposed to matter for packages which contain not just sub packages.

The initial part of 7.1 really suggests thinking of packages as a hierarchy, and the PackageBinding implementation matches this, but then there is sentence (also in 7.1):

"The hierarchical naming structure for packages is intended to be convenient for organizing related packages in a conventional manner, but has no significance in itself other than the prohibition against a package having a subpackage with the same simple name as a top level type (§7.6) declared in that package."

Regarding FQNs: Certainly we have to interpret them as in loop. 
But when interpreting
p1.p2.c1.c2.f1.f2
even if we already have the PackageBinding of p1, we'll not ask it for p2, but rather ask the current LE for p1.p2

In my experiments, i tried to immediately delete SplitPackageBinding along with PackageBinding.knownPackages, but it has two aspects:
1) code related to the representation of packages as hierarchy, which adds a lot of complexity
2) code that allows error reporting and type resolution in the presence of package conflicts. 

I think for the second aspect, SBP should actually be retained (maybe with a different name like ConflictPackageBinding?) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-12T17:54:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #11)
> Regarding FQNs: Certainly we have to interpret them as in loop. 
> But when interpreting
> p1.p2.c1.c2.f1.f2
> even if we already have the PackageBinding of p1, we'll not ask it for p2,
> but rather ask the current LE for p1.p2

I guess this means that lookup of p1 need not return a PackageBinding, just knowing that this is not a type is sufficient to proceed, right?
 
> In my experiments,

you already started? :)

> i tried to immediately delete SplitPackageBinding along
> with PackageBinding.knownPackages, but it has two aspects:
> 1) code related to the representation of packages as hierarchy, which adds a
> lot of complexity
> 2) code that allows error reporting and type resolution in the presence of
> package conflicts.

yes, SplitPackageBinding carries valuable information for error messages.

Do you already have plans for the type<->package conflict if we have types p.q and p.q.r.s? I understand you don't want to create a PackageBinding for p.q (since it only contains sub-packages), but this package still conflicts with a same named type.


Asked differently, if you are experimenting with an alternative implementation, can you give an outline how you plan to address the topics (1) - (5)? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-13T08:32:56Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> > Looking forward to your comments in bug 547181.

@Stephan: So, I'd like to take the chance to partipicate and to give some comments that possibly may help :)

> (1) Qualified Names & the Package Hierarchy
> 6.5.3.2 did not, and does not, recurse into 6.5.3.1 when the
> Q in the qualified name Q.Id is simple

Q being simple means in my opinion nothing more than "there are no '.' in Q". So, "javax" would be simple (and thus doesn't need recursion into 6.5.3.1), but "javax.security" is not. I don�t see a contradiction between the JLS and the answer given in the mailing list?

> We still have both options for representing packages: hierarchy or flat.
> But even with a flat representation lookup probably has to be done in
> a loop, starting with a simple identifier and gradually adding
> more segments.

Using HashMap's, searching is internally done using binary search. In my opinion, this should be very fast for looking up packages even in an environment of many modules with many visible packages. I�m not sure if looping over a hierarchy-like collection would be "better" (faster)?


> (2) Cycles and re-entrance [...]
> Now all you need is a module M that requires an automatic module X, and
> as per the above rule X will read M and you have a cycle already.
> Ergo: every module graph where an automatic module is requires has at
> least one cycle. This is bad.

Coming back to my suggestion on bug 547113, comment #11 I�d like to bring again the following simple lookup strategy into play:

1. Put all selfcontained package names with contents of all regular modules and automatic modules (from .jars) into selfcontainedPackageNames (=HashMap).
2a. For regular modules: Gather all selfcontained package names as well as all packages of (transitively) required modules and put them into visibleCanonicalPackageNames (=HashMap) 
2b. For automatic modules: Gather all selfcontained package names, all packages within other automatic modules, as well as all other (exported?) packages of all other regular modules on the modulepath and put them into visibleCanonicalPackageNames (=HashMap)
3. Doing steps 2a and 2b while checking visiblePackageNames (=HashMap) for detecting split packages with content (being illegal)

> (3) Conceptually, some computations could be simplified if we
> add an initial, eager phase of "establishing the module graph".

For me, changes to the modulepath and/or module definitions always requires recomputation of the three maps named in (2). In the first step maybe always from scratch, at a later point possibly differentially.

> (4) fully qualified names are not unique
> (a) Either the package must already encode the point of view
> (module) to find the type that is visible at the location where
> the FQN occurs.
> (b) Or behind a global (i.e., module-agnostic) PackageBinding
> we need a structure for per-module lookup of types.

In my opinion both ways would work. I assume that I implicitely suggested (b) when using module names as key in my maps.

> (5) Caching
> From looking at current code, a key design factor was not only
> to give the correct answers, but to avoid redundant computation.

My suggested lookup maps can be reused as long as the module path and the module definitions won't change. Then, as said in (3) above, they can be recomputed from scratch, or differentially.

For classes and members, similar mappings as for packages could be used to speed up class and member lookup performance (if required).


My feeling is that I�m talking way too superficially ;-) As said, I�m not familiar with the implementation details of the JDT code, I�d just put some general ideas here to try to support developing a fast and reliable solution for module-based package resolution. So, please apologize if I left out things that I don�t see through right now :)

Btw., is there any glossar for the abbreviations (like FQN, LE, CU) used in this discussion? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-13T10:45:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sam Peters from comment #13)
> Btw., is there any glossar for the abbreviations (like FQN, LE, CU) used in
> this discussion?

JLS=Java Language Specification
FQN=fully qualified name
CU=compilation unit

The other one are abbreviations of Implementation classes (see https://wiki.eclipse.org/JDT_Core_Committer_FAQ#Where_is_the_JDT.2FCore_code.3F) 

LE=LookupEnvironment
PB=PackageBinding
SBP=SplitPackageBinding
URB=UnresolvedReferenceBinding </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-13T21:18:59Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sam Peters from comment #13)
> > Looking forward to your comments in bug 547181.
> 
> @Stephan: So, I'd like to take the chance to partipicate and to give some
> comments that possibly may help :)
> 
> > (1) Qualified Names & the Package Hierarchy
> > 6.5.3.2 did not, and does not, recurse into 6.5.3.1 when the
> > Q in the qualified name Q.Id is simple
> 
> Q being simple means in my opinion nothing more than "there are no '.' in
> Q". So, "javax" would be simple (and thus doesn't need recursion into
> 6.5.3.1), but "javax.security" is not. I don�t see a contradiction between
> the JLS and the answer given in the mailing list?

Whatever is the shape of Q, it's just a name. In order to interpret the name we need a rule in JLS. Alex told me not to apply 6.5.3.1 but he never told which rule to use instead. Also, he answered only the special case of a more general question. What if Q is not simple? No answer given.


> > We still have both options for representing packages: hierarchy or flat.
> > But even with a flat representation lookup probably has to be done in
> > a loop, starting with a simple identifier and gradually adding
> > more segments.
> 
> Using HashMap's, searching is internally done using binary search. In my
> opinion, this should be very fast for looking up packages even in an
> environment of many modules with many visible packages. I�m not sure if
> looping over a hierarchy-like collection would be "better" (faster)?

Let's please separate performance issues from semantic ones. While I did mention performance elsewhere the snippet to which you reply is written from a purely semantic p.o.v. The loop is needed to determine the subsequences of the qualified name that denote a package, a type (inner types) and finally fields.

What if I told you that the qualified name p1.p2.T1.T2.f1.f2 denotes a class f2 in package p1.p2.T1.T2.f1? What if the class is p1.p2? When lookup starts we have no clue either way.
 
> > (2) Cycles and re-entrance [...]
> > Now all you need is a module M that requires an automatic module X, and
> > as per the above rule X will read M and you have a cycle already.
> > Ergo: every module graph where an automatic module is requires has at
> > least one cycle. This is bad.
> 
> Coming back to my suggestion on bug 547113, comment #11 I�d like to bring
> again the following simple lookup strategy into play:
> 
> 1. Put all selfcontained package names with contents of all regular modules
> and automatic modules (from .jars) into selfcontainedPackageNames (=HashMap).
> 2a. For regular modules: Gather all selfcontained package names as well as
> all packages of (transitively) required modules and put them into
> visibleCanonicalPackageNames (=HashMap) 
> 2b. For automatic modules: Gather all selfcontained package names, all
> packages within other automatic modules, as well as all other (exported?)
> packages of all other regular modules on the modulepath and put them into
> visibleCanonicalPackageNames (=HashMap)
> 3. Doing steps 2a and 2b while checking visiblePackageNames (=HashMap) for
> detecting split packages with content (being illegal)

S.t. along these lines _could_ possibly work _if_ we can afford to analyze the whole world before starting to compile the first class. According to (3) this may not be given.
 
> > (3) Conceptually, some computations could be simplified if we
> > add an initial, eager phase of "establishing the module graph".
> 
> For me, changes to the modulepath and/or module definitions always requires
> recomputation of the three maps named in (2). In the first step maybe always
> from scratch, at a later point possibly differentially.

When I mentioned incremental compilation this does not imply that internal compiler state is preserved between compiler invocations - it is not.
So if compilation requires the module graph to be fully analyzed, this initialization / analysis essentially has to happen "on every keystroke in the editor".

(long term caching happens at another level, the Java Model, where we keep things like jar files).
 
> > (5) Caching
> > From looking at current code, a key design factor was not only
> > to give the correct answers, but to avoid redundant computation.
> 
> My suggested lookup maps can be reused as long as the module path and the
> module definitions won't change. Then, as said in (3) above, they can be
> recomputed from scratch, or differentially.

Here, I spoke of caching at much finer grain. Each qualified name may require dozens of lookups (in attempting different interpretations / looking in different modules). Caching things we found is (relatively) easy, recording which lookup attempts can be avoided, because some similar attempt had failed earlier, is the tricky part - and no less relevant.
 

From comparing your answers with my understanding of the code, I believe on-demand resolving is the biggest difference between the clean conceptual world and getting your hands dirty in real life. Exercise: start with zero knowledge and resolve only those bits that are absolutely necessary to compile the class at hand, pulling in more details about the world only when needed. Till already mentioned a class where this manifests par excellence: UnresolvedReferenceBinding. If you look at that code and how this class is used,  you'll be much closer to real life. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-14T06:11:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Maybe it would be useful to think of adding a tree representation of the visible packages directly in LE (possibly in parallel to a direct hashmap FQN->PackageBinding). Its "LESpecificPackageTreeNodes" would capture the package-hierarchy aspects for which of SplitPackageBinding was needed, but would be private to a specific LookupEnvironment (where SplitPackageBinding is currently handled in many places) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-14T07:08:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> @Till, thanks for clarifying the abbreviations.

@Stephan, thank you for your feedback. I see, I�m entering an another world. Until now, I didn�t have a look at the JDT code but I�d love to have the time to do so.

> When I mentioned incremental compilation this does not imply that
> internal compiler state is preserved between compiler invocations - it
> is not. So if compilation requires the module graph to be fully analyzed,
> this initialization / analysis essentially has to happen "on every
> keystroke in the editor".

That explains a lot. I think the biggest misassumption I made is that I thought that the computed relations of e. g. modules and packages (my proposed HashMaps in Comment #13), once determined, can be reused for "every keystroke" until they get invalid and must be recomputed. But, if I understand your explaination correctly, this is not the way it works in the current JDT implementation. 

So, it is correct that all classes and module-info being relevant for resolution must be re-scanned (from memory cache or disk) with every keystroke if necessary? Or, in other words, does incremental compilation in eclipse always start with "zero knowledge" with every keystroke? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-15T08:15:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Being in the perspective of a "heavy user" of Eclipse I wish that this bug can be fixed soon: Today, I just typed some valid lines of java code in our Eclipse workspace (2018-06 M2) with some modular maven projects being opened. On one moment I have 0 "errors", in the next 68 "errors" (in the editor as well as in the "Problems" tab, but NOT on the package explorer), most likely because of this bug. "Cleaning" all projects and do a "Maven > Update projects" will temporarly "solve" those errors, but typing some valid lines of code causes another x errors and so on. This makes work really hard. Needless to say that these errors are no real errors but are only show as such, 'maven install' works like a charm.

Examples of bug types (always occuring at the import statements of the classes) are:

- The package javax.servlet is accessable from more than one module: jakarta.servlet.api, jakarta.servlet.api
- The package XY is accessable from more than one module: <unnamed>, XY (where package name XY equals module name XY).
- The type javax.naming.NameNotFoundException is not accessable
- ...

If I had the chance to make use only of real modules instead of automatic modules I'd use them (because the problem won't occur then). But in real world, there are lots of libraries, e. g. the jakarta servlet api (https://mvnrepository.com/artifact/jakarta.servlet/jakarta.servlet-api/4.0.2), whose latest versions are not being modularized so far, so I'm stuck.

So again, thank you very much for continuing your work on resolving this bug. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-15T18:41:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Another corner case that where the hierarchy aspect is visible and that is similar to the conflict check use case:

Pre-Java 9, the following is legal (at least both Eclipse and javac allow it):

import java.*;



With Java 9 or later, an error is reported by both:

Eclipse reports:
"The package java is not accessible"

javac reports:
Test.java:1: error: package java does not exist </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-15T18:44:53Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> For comparison:

import bla.*;

is reported by Eclipse as:
The import bla cannot be resolved

and by javac as:
Test.java:1: error: package bla does not exist

So for the case in the previous comment and java 9, maybe Eclipse should also report
The import java cannot be resolved </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T16:01:19Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I think after splitting off the hierarchy-aspect from PackageBinding, they should only be created if they are assumed to "exist" (let's use that term for JLS-speak: "an ordinary compilation unit associated with M contains a declaration of the �package").

In that context, I noted that "open"-directives currently resolves statements the same as "exports"-directives, but they can reference "non-existing" packages (see JLS 7.7.2). I guess that should be changed (but the warning given for missing packages in this situation must be kept)

Another note: The modules mentioned in the optional "to"-clauses of these directives are currently represented by there names only (which makes sense, as they are allowed to be missing). I noted that no warning is given if a module is missing (javac does give a warning in this situation) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T16:03:30Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #21)
> I think after splitting off the hierarchy-aspect from PackageBinding, they
> should only be created if they are assumed to "exist"

Because of comment 19, for pre-java9, the definition of "existance" may be different. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T16:49:56Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I think after laying out the dimensions of the problem, I may now join the game of proposing solutions :)

In the other bug I said:

> Frankly, I don't like the current design, but within the months before 
> Java 9 GA this was the only feasible approach I could find.

Thinking more about it, let me be more precise in what exactly I dislike:  it's the necessity to immediately contextualize each and every PackageBinding into a SplitPackageBinding if applicable. In terms of the above, it's the "on-demand" property (3) which creates those vicious cycles (2).

If we only address this conflict then the following sketch would be worth investigating:

(In reply to Stephan Herrmann from bug 547113 comment #8)
> As a mid-term perspective I had started to think of better leveraging the
> distinction of LE#knownPackages vs. MB#declaredPackages.
> If the latter would only capture locally defined packages, then collecting
> package bindings from a set of modules would not involve recursively
> creating SPBs, those would live only in the package tree below
> LE#knownPackages. Perhaps this could already resolve the
> transitivity/re-entrance/cycle issue, with an effort that can be contained
> within a single milestone.

More specifically: each module binding would eagerly (i.e. around when the binding is created) fill it's #declaredPackages with plain PackageBindings.

When requesting a package via s.t. like MB#getVisiblePackage() or generally in the Scope#getTypeOrPackage() call tree, the module graph can be assumed to exist, populated with all relevant declared packages, so that constructing the correct SplitPackageBinding may no longer be an issue. Packages not available in that global graph can safely be resolved in the context module alone (I think).


I hold that this change would be abound one order of magnitude smaller then getting rid of the package hierarchy. So the question here is: if this succeeds to avoid the cycle issue, what problems remain? For all the little difference what errors/warnings to flag / not flag, I'd claim the model has all necessary information at hand, and changing error detection can be done on a case-by-case basis with no major headache.


For the more drastic refactoring each of the topics (1) - (5) needs an answer before we could even start assessing the cost-benefit ratio.


IOW, how big is the pain caused by the package hierarchy (also in comparison to the rest of our backlog and new Java features in the pipeline)? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T16:51:06Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #12)
> > In my experiments,
> 
> you already started? :)

So far only experiments, that I've always reverted.
Currently I'm trying to figure out how to get rid of PackageBinding#parent. There is one usage not related to the package hierarchy, which is tricky to analyse. It is PackageBinding.clearMissingTagBit() and its effect is read via Binding.problemId() which is used in lots of places.

> Asked differently, if you are experimenting with an alternative
> implementation, can you give an outline how you plan to address the topics
> (1) - (5)?

Let's assume PackageBinding contains only types and belongs to one module, but when exported can directly be used by other modules reading that module. A ModuleBinding contains a map that contains exactly the PackageBindings belonging to that Module. 

For now lets assume we keep in LE a hierarchical representation as PackageTreeNodes , which represents the package tree as visible from the module.
A PackageTreeNode contains a @Nullable reference to a PackageBinding (or for the case of visiblity conflicts, to a ConflictingPackageBinding which contains an array of PackageBinding).
The PackageTreeNodes are maintained privately in LookupEnvironment and are ideally just a cache, that can be dropped and reconstructed at any time (thinking of org.eclipse.jdt.internal.compiler.lookup.ModuleBinding.addReads(char[]))

For the type<->package conflict check, we don't access to a Binding of some kind, but should have a dedicated method in LE, that returns a boolean whether a package with that prefix exists (could be used for explicitly allowing something like import java.* in pre-java9, when no PackageBinding is found)

== (1) Qualified Names & the Package Hierarchy ==
As written in another comment, when iterating "p1.p2.c1.c2.f1.f2", lookup goes via the LE (using either the PackageTreeNodes, or a flat HashMap, or both), asking first for "p1", then "p1.p2"

== (2) Cycles and re-entrance ==
The only situation where cycles might matter is when deciding which other modules to check for a PackageBinding
If the existing ModuleBinding.isPackageLookupActive isn't good enough (it might be after removing SplitPackageBinding) we may have to collect the visited visible modules in a set (but that set could probably be cached)

== (3) Eager vs. Lazy ==
I don't see any conceptual changes here

== (4) fully qualified names are not unique ==
Types are compared via their TypeBindings, not there FQN. The TypeBindings are retrieved via the PackageBinding.
Ignoring errors, each module can see only one PackageBinding for each name package name.
For finding the correct PackageBinding, see (1)

== (5) Caching ==
I don't see any conceptual changes here </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T16:57:47Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #23)
> I think after laying out the dimensions of the problem, I may now join the
> game of proposing solutions :)

You comment #24 was written in parallel, so doesn't reference any of this.

> > As a mid-term perspective I had started to think of better leveraging the
> > distinction of LE#knownPackages vs. MB#declaredPackages.

If you already have a mental model for this and would do it, it would be great!

It is definitely a good a idea and would also be a good preparation to the larger refactoring (if still needed at all) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T20:04:28Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I wish bugzilla had an edit function...

(In reply to Till Brychcy from comment #25)
> You comment #24 was written in parallel, so doesn't reference any of this.

Should have been:
_My_ comment #24 ...

And in comment 24:
> For the type<->package conflict check, we don't access to a Binding of some
For the type<->package conflict check, we don't _need_ access to a Binding of some </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T20:22:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #24)
> Currently I'm trying to figure out how to get rid of PackageBinding#parent.
> There is one usage not related to the package hierarchy, which is tricky to
> analyse. It is PackageBinding.clearMissingTagBit() and its effect is read
> via Binding.problemId() which is used in lots of places.

Followup: This just exists so a missing type p1.p2.M3 doesn't consecutive lookups to assume that p1 exists as package (in the pre-java9 sense, just because of subpackages)

I think we won't need the "missing" bits for parent packages (as we won't actually need to create full PackageBindings for them) if we implement a minor change in error messages, that actually aligns us more with javac and the offered quickfixes:

If there is no package starting with p1, trying to "import p1.p2.Missing;" is currently reported as "The import p1 cannot be resolved" and trying to declare a field as "p1.p2.Missing field;" is reported as "p1 cannot be resolved to a type".

javac reports "package p1.p2 does not exist" for both cases. I think this actually makes more sense. After all, the quickfixes offered by eclipse are not related to p1, but variations of "Create class 'Missing' in package p1.p2" </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-20T20:24:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Have I already mentioned I miss an edit button...

(In reply to Till Brychcy from comment #27)
> Followup: This just exists so a missing type p1.p2.M3 doesn't consecutive
Followup: This just exists so a missing type p1.p2.M3 doesn't _cause_ consecutive </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T13:09:23Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #28)
> Have I already mentioned I miss an edit button...

:)

(meanwhile we do have a Preview tab, though)


Came back here, to say that bug 546508 confirms: dependence on compile order (which is relevant due to on-demand resolving (3)) is indeed a huge (the?) problem. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T16:23:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #24)
> For now lets assume we keep in LE a hierarchical representation as
> PackageTreeNodes , which represents the package tree as visible from the
> module.

Aha! So there still will be a tree :)

Would that also be the place to cache which packages have not been found?

Is it correct to say, that your core idea is really to get rid of "empty" / "non-existing" split parent packages?

It feels like the proposed structure of PackageTreeNodes is not 100% different. Both are module-specific views of packages.

As mentioned my main worry with the existing structure is the combination of on-demand computation, requiring everything to be complete when accessed, with the possibility of cycles in the module graph.

Do you see other problems caused the SplitPackageBinding?

> == (2) Cycles and re-entrance ==
> The only situation where cycles might matter is when deciding which other
> modules to check for a PackageBinding
> If the existing ModuleBinding.isPackageLookupActive isn't good enough (it
> might be after removing SplitPackageBinding) we may have to collect the
> visited visible modules in a set (but that set could probably be cached)

So, to check a requested PackageBinding from a given module's p.o.v. you will not look into PackageTreeNodes, but only into the packages stored in the ModuleBinding, right?
This indeed sound quite similar to my idea in comment 23. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T18:21:24Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #30)
> (In reply to Till Brychcy from comment #24)
> > For now lets assume we keep in LE a hierarchical representation as
> > PackageTreeNodes , which represents the package tree as visible from the
> > module.
> 
> Aha! So there still will be a tree :)

:-)  At least as first step it may help to have them as it is closer to the current implementation.

> 
> Would that also be the place to cache which packages have not been found?

I'm not sure if caching _packages_ which have not been found is really much of an issue, as the assumption is that if there is no type with that name, the next level of a FQN must be a subpackage. But it might make sense to cache the info that there is no _type_ with a given name.

> 
> Is it correct to say, that your core idea is really to get rid of "empty" /
> "non-existing" split parent packages?

That and to remove all parent/subpackage relations from PackageBinding, so it can be shared between modules.

> Do you see other problems caused the SplitPackageBinding?

At least currently, it is handled in too many places (29 * "instanceof SplitPackageBinding" in 12 classes).

> So, to check a requested PackageBinding from a given module's p.o.v. you
> will not look into PackageTreeNodes, but only into the packages stored in
> the ModuleBinding, right?

Actually I meant the other way round: 
A ModuleBinding is only ever asked for the PackageBindings *it defines*. 
To find the PackageBinding visible from p.o.v. of a module, its LE is asked, which uses the PackageTreeNodes. 
So when the LE doesn't have a PackageTreeNode for package name yet, it constructs it by asking its ModuleBinding if it defines a package with that name and the ModuleBindings of the modules required by the LE's module if they export a package with that name (to the LE's module). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T20:35:00Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #31)
> I'm not sure if caching _packages_ which have not been found is really much
> of an issue, as the assumption is that if there is no type with that name,

Answering myself: caching packages is currently relevant if MissingTypeBinding is involved, e.g. in PackageBinding.getTypeOrPackage, where an existing package wins over a MissingTypeBinding </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T21:11:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #31)
> (In reply to Stephan Herrmann from comment #30)
> > Do you see other problems caused the SplitPackageBinding?
> 
> At least currently, it is handled in too many places (29 * "instanceof
> SplitPackageBinding" in 12 classes).

One group is just guarding calls to getIncarnation(), which could trivially be pulled up to PackageBinding.

Another group is actually harvesting the result of all this: if a real reference resolves to a split package, then this is where we need to report an error.

After a quick scan of those 29 locations about 6 look suspicious to me, i.e., leaking technical details into places that shouldn't have to worry.

Anyway and whichever approach we will use, this is a valuable question towards improving the design. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-28T07:06:15Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Bulk move to 4.13 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-08T12:18:14Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/143581 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-08T13:01:45Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #35)
> New Gerrit change created: https://git.eclipse.org/r/143581

This is a first draft towards the smaller solution along the lines of comment 23.

Core concept: give a specific responsibility to ModuleBinding#declaredPackages:

Into this field we eagerly create all exported & opened packages including their parent packages. In this structure all packages are represented by a plain PackageBinding, no Split... at all:

Source Modules:
There's a new call chain 
  CompilationUnitScope.buildTypeBindings()
    -> ... ->  PackageVisibilityStatement.resolvePackageReference()
additionally ModuleBinding.completeIfNeeded(PACKAGE) must be called early to ensure that add-exports is applied early

Binary Modules
This is directly hooked into getDeclaredPackage()
 
Automatic Modules
These are a main contributor to our problems and so require some new strategy here: Since auto modules have no exports we need to scan their content, for which purpose I introduced new internal API in IModuleAwareNameEnvironment and below, start at #listPackages(moduleName). Spreading this into all kinds of module path entries, classpath locations etc. is probably still incomplete as of now.


Now that MB#declaredPackages is populated flat & early, this is the only source that shall be consulted when constructing SplitPackageBindings. This means the methods like MB#combineWithPackagesFromOtherRelevantModules(), SPB#combineWithSiblings() no longer run risk of unhappy re-entrance, because asking MB#getDeclaredPackage() is side-effect free for source modules, and has only local side-effects for binary and auto modules.

OTOH, no other client should directly use #declaredPackages. All downstream lookup functionality must through API in LE or MB#getVisiblePackage(). Specifically, the tree below LE#knownPackages caches only the fully combined SPB where applicable.

To me this appears to bring the smallest risk, while having the potential to fix the known issues of unreliable package lookup due to order dependence etc.


In those tests that I ran locally I made the following observations:
- this already seems to fix the test case from bug 547113
- I saw a few regressions where 'not accessible' changed to 'couldn't resolve'
- I saw a few regressions relating to test sources

Too bad, that failures in compiler tests abort the gerrit build without running model tests ...


@Till, your comments are welcome, specifically I'd appreciate if you take a look at the new failures around test sources, at least these:
- ReconcilerTests9.{testBug544306,testBug546315}
- ModuleBuilderTests.testWithTestAttributeAndTestDependencyOnClassPath </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-09T13:41:10Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Updates in patch set #2:

- adjust scanning of UnNamedModule#declaredPackages

- added an additional scan: if a binding could not be resolved, search for an inaccessible binding to improve error reporting.

- 1 test adjusted to this improved error report

- FileSystem can now distinguish not accessible from not observable (due to limit modules) to keep the "cannot be resolved" error in the unobservable case

- improve ClasspathMultiDirectory.directoryList for the case that .class files have not yet been created. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-09T19:31:17Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #36)
> @Till [...] I'd appreciate if you take a
> look at the new failures around test sources, at least these:
> - ReconcilerTests9.{testBug544306,testBug546315}
> - ModuleBuilderTests.testWithTestAttributeAndTestDependencyOnClassPath

skip that, we have BUILD SUCCESS :))
https://ci.eclipse.org/jdt/job/eclipse.jdt.core-Gerrit/2020/ </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-10T14:01:17Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> After seeing first BUILD SUCCESS I started some cleanup / refactoring:

Added PB.getIncarnation() so that many "instanceof SPB" could be removed. Down to 16 occurrences (from 29). This is part of patch set #4.


Prepared for the removal of previous kludges:

Throw ISE if package lookup is still re-entrant (shouldn't). If we're confident that this no longer occurs, we can remove infra around MB#isPackageLookupActive.

Throw ISE if add-reads is applied after packages have already been created (shouldn't). If successful, we can fully simplify MB#addReads().

Also MB#completeIfNeeded() could be replaced with a one-time initialization method, and use as on-demand initialization can be removed.
To check: IIRC these were implemented as on-demand in order to avoid the need to always fully initialize the module graph and perhaps lots of packages. With the new approach, do we perform avoidable work? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-10T15:03:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Stepping back a little, what were our pain points and what is resolved in the proposed change?


Builds have intermittent bogus errors, assumeably due to issues of compilation order & re-entrance.
=> Seems to be fixed
- compilation order is simplified by doing certain lookup early, rather than on-demand.
- populating ModuleBinding#declaredPackages no longer involves transitive lookup, since only plain PackageBinding are stored here


The tree structure of PackageBinding does not directly match the semantics that each package is independent.
-> Not changed, but the way JLS §6.5 is written, we need a tree anyway in order to find the correct classification for a qualified name.


SplitPackageBinding itself was questioned.
-> Not changed, but at least for conflicting packages some representation of this kind is needed anyway.


Creating (big) SplitPackageBinding for empty parent packages looks wasteful.
-> Not changed.


Specific handling of SPB leaked into (too) many locations in the compiler.
=> Many "instanceof SPB" have been refactored away, many remaining occurrences are essential for error reporting, a few still look leaky.


Finding a PackageBinding does not imply the package "exists" in terms of a CU declaring the packge.
=> Not changed, we handle this by asking PB#hasCompilationUnit().


@Till, did I miss any pain points? How severe do you judge the remaining issues? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-10T15:09:39Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Till, this change is ready for review. Considering its fundamental nature, may I officially ask you for a review? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-10T15:30:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #41)
> Till, this change is ready for review. Considering its fundamental nature,
> may I officially ask you for a review?

Sure. Actually you wrote this while I was already fetching the gerrit :-)
Still, given the size of the change, this may take a few evenings. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-10T15:56:31Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #42)
> (In reply to Stephan Herrmann from comment #41)
> > Till, this change is ready for review. Considering its fundamental nature,
> > may I officially ask you for a review?
> 
> Sure. Actually you wrote this while I was already fetching the gerrit :-)

cool thanks.

> Still, given the size of the change, this may take a few evenings.

no hurry :)
also I can't promise immediate responses during this week, should you have any questions. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-11T16:54:47Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I've added a first round of comments in gerrit, which allow some simplifications.
I think it makes sense to address them first before I continue.

Also, I have one improvement idea:
We have some locations where we know that the PackageBinding is not split. 
It would be helpful, if we could express this using the type system. Currently, this is not possible, because SplitPackageBinding is a subclass of PackageBinding.
Maybe we should make PackageBinding abstract and introduce a subclass "BasicPackageBinding" which would be parallel to SplitPackageBinding? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-16T17:20:50Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #44)
> I've added a first round of comments in gerrit, which allow some
> simplifications.
> I think it makes sense to address them first before I continue.
> 
> Also, I have one improvement idea:
> We have some locations where we know that the PackageBinding is not split. 
> It would be helpful, if we could express this using the type system.
> Currently, this is not possible, because SplitPackageBinding is a subclass
> of PackageBinding.
> Maybe we should make PackageBinding abstract and introduce a subclass
> "BasicPackageBinding" which would be parallel to SplitPackageBinding?

This is an excellent idea.

I named the new type PlainPackageBinding and has you can see here, I was able to use the new type in quite a few places:
  https://git.eclipse.org/r/#/c/143581/6..7

Indeed this helps to make the design more explicit, which already allowed me to remove some obviously redundant code. Another design rule used: MB.getOrCreateDeclaredPackage() never returns null. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-16T18:20:45Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> In patch set #8 I removed the code around MB.isPackageLookupActive which was used to avoid re-entrance but should no longer be needed.

At this point I'm putting my pen down to await further comments. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-16T20:42:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #46)
> In patch set #8 I removed the code around MB.isPackageLookupActive which was
> used to avoid re-entrance but should no longer be needed.
> 
> At this point I'm putting my pen down to await further comments.

Good, I'll continue!

Also, I can also happily report that after a few days this patch I haven't observed any more bogus errors like "The type javax.xml.datatype.XMLGregorianCalendar is not accessible" in a large workspace (with just language switched to java 11, so all non-jdk code in the unnamed module) where I previously got them sometimes. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-25T20:07:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> With patch set #11 we finally have a green build again.

Last (real) failure was in AnnotationProcessorTests.testBug456986, where a package was first not found and later appeared (generated by a processor?).

Since initial creation of packages now only writes to MB#declaredPackages, not LE#knownPackages, at least we need to remove the previous TheNotFoundPackage (relevant only for toplevel packages). Fixed. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-01T16:20:21Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Patch set 12 contains another failing test (It also fails with the master)

I found it while looking for an example for a problem I saw: The (plain) packages returned by ModuleBinding.getDeclaredPackage can have SplitPackageBindings as children (as seen by that module, I assume/hope). The can be an incarnation in another modules' SplitPackageBinding. In SplitPackageBindings.getPackage0 these incarnation-specific (possibly split) childpackages are combined to form a new SplitPackageBinding, which now can contain packages not accessable for the current module. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-01T21:46:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #49)
> Patch set 12 contains another failing test (It also fails with the master)
> 
> I found it while looking for an example for a problem I saw: The (plain)
> packages returned by ModuleBinding.getDeclaredPackage can have
> SplitPackageBindings as children (as seen by that module, I assume/hope).
> The can be an incarnation in another modules' SplitPackageBinding. In
> SplitPackageBindings.getPackage0 these incarnation-specific (possibly split)
> childpackages are combined to form a new SplitPackageBinding, which now can
> contain packages not accessable for the current module.

Thanks for the test.

I see it fail, but in a different way: I could not observe any PlainPackageBinding receiving a SplitPackageBinding as its child nor was a SPB created with a PPB as its parent.

I do observe the following: 
- we resolve import p1.p2.X from the p.o.v. of D/usage.Usage
- we find package p1 (from B, C) - OK
- we ask the above SPB getTypeOrPackage("p2")
- this implies findPackage("p2") for modules B and C
- we find candidates A/p1.p2 and C/p1.p2 to yield SPB package p1.p2 (from C, A)
- we ask the latter SPB getTypeOrPackage("X") and then getType0("X")
- C/p1.p2 doesn't yet have X in knownTypes - <- trouble starts here
- A/p1.p2 has URB(X) in knownTypes
- hence SPB.getType0(X) answers the URB - ignoring type C/p1.p2.X!

Ergo: SPB.getType0() incorrectly proceeds with incomplete information. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-01T22:33:04Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I believe SPB.getType0() should mostly be ditched and return null unless a type was found in the *local* knownTypes.

That change, however, breaks testBug528467b(), and interestingly here I can observe an SPB as a child of a PPB. Bug in SPB.addPackage().

Finally, the modified getType0() broke LE.getCachedType() which can be fixed within getCachedType0().

Let's see what jenkins thinks of this (patch set #13). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T14:03:07Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 548865 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T14:26:31Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Please see here for my full reaction to comment 49: https://git.eclipse.org/r/#/c/143581/12..14

Mostly, SPB.getType0() has gone completely. For those callers that are really interested in *the* type available from this package, the super implementation is good enough. Answering null is better than answering with incomplete information.

I found 3 callers, however, that are not interested in the type, but only in the existence of (at least one) such type (for clash detection). For those a new query PB.hasType0Any() is more suitable (and partly simplifies the code).

@Till, I'd like to release this soon, any objections?
It may not yet be perfect, and I'm happy to accept more review comments, test cases, but I think the current state is already significantly better than master.
WDYT? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T14:46:46Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #53)
> @Till, I'd like to release this soon, any objections?
> It may not yet be perfect, and I'm happy to accept more review comments,
> test cases, but I think the current state is already significantly better
> than master.
> WDYT?

I agree, let's commit this to the master and then continue.

If this is committed, I can also just do some of the not-yet-handled simplifications I suggested in the gerrit myself. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T15:53:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/143581 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=1fbf13c28311e9090a4ae402b14adbc440f874ec </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T15:56:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #55)
> Gerrit change https://git.eclipse.org/r/143581 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=1fbf13c28311e9090a4ae402b14adbc440f874ec

Released to master for 4.13 M1

(In reply to Till Brychcy from comment #54)
> I agree, let's commit this to the master and then continue.

Bug stays open for a little while.
 
> If this is committed, I can also just do some of the not-yet-handled
> simplifications I suggested in the gerrit myself.

I'm sorry, just today I noticed I didn't react on all suggestions.
So, yes, please apply any simplification you see fit. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T20:16:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145337 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T21:06:41Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #53)
> Mostly, SPB.getType0() has gone completely. For those callers that are

I think as consequence PackageBinding.getPackage0Any can be removed. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T21:22:43Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #58)
> (In reply to Stephan Herrmann from comment #53)
> > Mostly, SPB.getType0() has gone completely. For those callers that are
> 
> I think as consequence PackageBinding.getPackage0Any can be removed.

This connection I don't see, please explain. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T21:26:13Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145337 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=bb25e29c367ff12180b5092261f8df5715444abb </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T21:28:26Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145342 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T21:29:39Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #59)
> (In reply to Till Brychcy from comment #58)
> > (In reply to Stephan Herrmann from comment #53)
> > > Mostly, SPB.getType0() has gone completely. For those callers that are
> > 
> > I think as consequence PackageBinding.getPackage0Any can be removed.
> 
> This connection I don't see, please explain.

If it the result is in the cache, it is the same as getPackage0.
Otherwise the result is a freshly combined SPB whose getType0 should be empty. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-02T21:51:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #62)
> (In reply to Stephan Herrmann from comment #59)
> > (In reply to Till Brychcy from comment #58)
> > > (In reply to Stephan Herrmann from comment #53)
> > > > Mostly, SPB.getType0() has gone completely. For those callers that are
> > > 
> > > I think as consequence PackageBinding.getPackage0Any can be removed.
> > 
> > This connection I don't see, please explain.
> 
> If it the result is in the cache, it is the same as getPackage0.
> Otherwise the result is a freshly combined SPB whose getType0 should be
> empty.

Oh, after this line
	packageBinding = packageBinding.getIncarnation(this.module);
we don't have SPB any more at all, so yes, SPB.getPackage0Any() should be dead code, and hence the whole method collapses to getPackage0(), nice :)

One more motivation to carefully what that PPB.knownPackages never contains SPB, so the iteration over compoundName segments stays within the realm of PPBs. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-03T07:42:28Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145342 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=39cebd69fe5aa5eb9aafb5a0040d3e7c9389f897 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-03T14:19:37Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The I20190702-1800 build shows failures on all 1.8 platforms in ReconcilerTests9.testBug547113:


Expecting no problems. ----------- Expected ------------ ----------\n ----------\n ------------ but was ------------ ----------\n 1. ERROR in /c/src/com/example/c/C.java (at line 12)\n System.out.println("done.");\n ^^^^^^\n System cannot be resolved\n ----------\n --------- Difference is ---------- expected:<----------\n []----------\n > but was:<----------\n [1. ERROR in /c/src/com/example/c/C.java (at line 12)\n System.out.println("done.");\n ^^^^^^\n System cannot be resolved\n ]----------\n >

junit.framework.ComparisonFailure: Expecting no problems.
----------- Expected ------------
----------\n
----------\n

------------ but was ------------
----------\n
1. ERROR in /c/src/com/example/c/C.java (at line 12)\n
System.out.println("done.");\n
^^^^^^\n
System cannot be resolved\n
----------\n

--------- Difference is ----------
expected:<----------\n
[]----------\n
> but was:<----------\n
[1. ERROR in /c/src/com/example/c/C.java (at line 12)\n
System.out.println("done.");\n
^^^^^^\n
System cannot be resolved\n
]----------\n
>
at org.eclipse.jdt.core.tests.junit.extension.TestCase.assertStringEquals(TestCase.java:266)
at org.eclipse.jdt.core.tests.junit.extension.TestCase.assertEquals(TestCase.java:242)
at org.eclipse.jdt.core.tests.model.AbstractJavaModelTests.assertProblems(AbstractJavaModelTests.java:889)
at org.eclipse.jdt.core.tests.model.ReconcilerTests9.testBug547113(ReconcilerTests9.java:936)

Need to check if there's a connection to this bug. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-03T17:46:10Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #65)
> The I20190702-1800 build shows failures on all 1.8 platforms in
> ReconcilerTests9.testBug547113:
> 
> [...]
> 
> Need to check if there's a connection to this bug.

Yes, it was added in the patch for this bug.

It is just missing a
if (!isJRE9)
	return;

I'll add it in my next simplification patch. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-03T17:53:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145420 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-03T22:00:37Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145420 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=f8480ac357ea4ce5d95c6e2a05c65fefd02632cd </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-04T12:30:31Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 546508 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-04T13:57:37Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 547113 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-04T17:34:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145492 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-04T18:33:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> ModuleBinding.getDeclaredPackage only returns already cached packages.

Can we be sure when this is used from ModuleBinding.combineWithPackagesFromOtherRelevantModules that all required packages are already cached?

Similar in SplitPackageBinding.combineWithSiblings. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-04T19:14:45Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145492 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=a73c2353d7810c3b248c523da998d659181ac7d8 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-04T20:57:31Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #72)
> ModuleBinding.getDeclaredPackage only returns already cached packages.
> 
> Can we be sure when this is used from
> ModuleBinding.combineWithPackagesFromOtherRelevantModules that all required
> packages are already cached?
> 
> Similar in SplitPackageBinding.combineWithSiblings.

In both cases we should only be interested in exported packages right?

Those are completely created when CUScope.buildTypeBindings() calls MD.resolvePackageDirectives() (which is actually the core of the changes in this bug :) ).

Do you see anything missing? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T06:26:26Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #74)
> In both cases we should only be interested in exported packages right?

Yes, as inaccessible packages are checked for separately via LE.getInaccessibleBinding.

> 
> Those are completely created when CUScope.buildTypeBindings() calls
> MD.resolvePackageDirectives() (which is actually the core of the changes in
> this bug :) ).
> 
> Do you see anything missing?

Just wanted to be sure, I think there is more redundant code that can be simplified :-) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T07:33:15Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> hello,

just tried the last compiler-version ecj-I20190704-1800 with our workspaces.

as described in bug 546508, comment 16, we now get the error

-----------------------------------------------------------------------
1. ERROR in /previous-project/src/package/ABC.java (at line 1)
        /*
        ^
The type another.package.XYZException cannot be resolved. It is indirectly referenced from required .class files
-----------------------------------------------------------------------

this workspace compiles without errors with ejc-4.10 as well as with javac of openJdk 11.

the class XYZException is defined in another project, which is compiled before and included on the classpath for the compile-task of the 'problematic-project'.

compilation is done project after project (according dependencies) and the the result is put on the classpath of the next project to compile.
we do not use java-modules - so it's all about pure classpath.

in case/as soon I find a way to reproduce this in a simple constellation I'll inform you about that setup.

I think this problem fits into this bug-report, but feel free to open another bug-report for this (or tell me and I'll do). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T11:53:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> 
it's not that easy to simplify the problem.

but maybe something of interest before - using ecj-I20190704-1800:

depending on the workspace-name (path to the collection of projects, not a real-eclipse-workspace), the same build results in errors in different projects.

indeed, I changed only 1 letter, the first one, from w (wr2019) to e (er2019) of the directoryname where the projects reside.

this workspace consists of 158 projects.

in case of wr2019 the 29th project shows up with errors, in case of er2019 it is the 67th.

ofcourse I tested that more often.
in contrast to bug 546508 these errors are reproduceable every time - as long as nothingelse is changed.
building with ecj-4.10 or javac all the projects build without errors.

buildlogic only differs in the call to the used-compiler.

all builds are configured for target java 11 - and run on openjdk 11.0.2. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T18:12:46Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to kurt ablinger from comment #76)
> I think this problem fits into this bug-report, but feel free to open
> another bug-report for this (or tell me and I'll do).

If s.t. that worked with *4.12* is broken using the recent build, then, yes, let's try to fix it here (hopefully before M1 next week!).

Otherwise please file a new bug. I appreciate the difficulty of creating a reproducer, but without it, there's hardly anything we can do. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T19:48:26Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145553 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T19:56:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #72)
> ModuleBinding.getDeclaredPackage only returns already cached packages.

Actually that method is overwritten for binary modules etc, but i was thinking of source modules. So the "this.declaredPackages.put(...)" in MB.addPackage is unnecessary and then this method is a NOP if checkForSplit=false. The code done for checkForSplit=true can be inlined at the single invocation location with checkForSplit=true and MB.addPackage removed.

(In reply to Eclipse Genie from comment #79)
> New Gerrit change created: https://git.eclipse.org/r/145553

Contains this and some further simplifications related to MB.getVisiblePackage, where MB.addPackage invocations were removed. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T20:20:48Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #80)
> (In reply to Till Brychcy from comment #72)
> > ModuleBinding.getDeclaredPackage only returns already cached packages.
> 
> Actually that method is overwritten for binary modules etc, but i was
> thinking of source modules. So the "this.declaredPackages.put(...)" in
> MB.addPackage is unnecessary and then this method is a NOP if
> checkForSplit=false. The code done for checkForSplit=true can be inlined at
> the single invocation location with checkForSplit=true and MB.addPackage
> removed.
> 
> (In reply to Eclipse Genie from comment #79)
> > New Gerrit change created: https://git.eclipse.org/r/145553
> 
> Contains this and some further simplifications related to
> MB.getVisiblePackage, where MB.addPackage invocations were removed.

Let's please for a moment not delete any cache-related code. The current failure in bug 544712 seems to be caused by duplicate PPB for the same package, indicating that our caching story is currently broken! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T20:39:17Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Duplicates are created in getOrCreateDeclaredPackage() because we only look in MB.declaredPackages but the PPB only exists in the LE.knowPackages tree.

- mayday - mayday - </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T20:45:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #82)
> Duplicates are created in getOrCreateDeclaredPackage() because we only look
> in MB.declaredPackages but the PPB only exists in the LE.knowPackages tree.
> 
> - mayday - mayday -

So getOrCreateDeclaredPackage is executed after the package has been created somewhere else and put into LE.knowPackages? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T20:48:47Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #83)
> (In reply to Stephan Herrmann from comment #82)
> > Duplicates are created in getOrCreateDeclaredPackage() because we only look
> > in MB.declaredPackages but the PPB only exists in the LE.knowPackages tree.
> > 
> > - mayday - mayday -
> 
> So getOrCreateDeclaredPackage is executed after the package has been created
> somewhere else and put into LE.knowPackages?

yep.

I have a fix, need a few minutes to make it look nice enough so you won't remove it at once :) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T21:03:58Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145556 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T21:07:46Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #85)
> New Gerrit change created: https://git.eclipse.org/r/145556

We obviously had two options:

(1) always look in the LE#knownModules tree before creating a PPB

(2) ensure that all PPB are recorded in MB#declaredPackages

For now I opted for (2). This means, each module knows as PPB all packages declared therein (all packages that are declared by a CU that is associated with the module), not only the exported ones. The special status of exported packages is only that those are guaranteed to be created early on. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T21:14:50Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I like the strict separation: 

Everything creating a PPB should go through the MB which will remember it.

LE is only a secondary lookup structure possibly composing PPB to SPB.



There is a new smell of code duplication in MB, perhaps to be address when we're back on firm grounds: createDeclaredToplevelPackage() vs. createDeclaredPackage() vs. getOrCreateDeclaredPackage(). 
The latter is invoked by clients that don't perform any tree lookup.
The former two are bridges for old LE functions that still need to potentially create a new PPB. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T21:22:41Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #85)
> New Gerrit change created: https://git.eclipse.org/r/145556

I'm locally running RunAllJava9Tests and if no regressions found before 18:00 EDT I plan to directly push this fix, even if jenkins hasn't finished by then.

Objections? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T21:33:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #87)
> I like the strict separation: 
> 
> Everything creating a PPB should go through the MB which will remember it.
> 
> LE is only a secondary lookup structure possibly composing PPB to SPB.

Yes, I like that, too! We are heading in a good direction where the code is easy to understand again :-)

(In reply to Stephan Herrmann from comment #88)
> (In reply to Eclipse Genie from comment #85)
> > New Gerrit change created: https://git.eclipse.org/r/145556
> 
> I'm locally running RunAllJava9Tests and if no regressions found before
> 18:00 EDT I plan to directly push this fix, even if jenkins hasn't finished
> by then.
> 
> Objections?

No, looks very good! 
Actually this immediately solves some open questions I had in my head. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T21:56:15Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145556 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=b62b223587dcd5da652588c255ae8a2001bb7091 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T22:06:21Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 544712 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-05T22:13:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #90)
> Gerrit change https://git.eclipse.org/r/145556 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=b62b223587dcd5da652588c255ae8a2001bb7091

I checked the I-build:

00:06:02 From ssh://git.eclipse.org:29418/jdt/eclipse.jdt.core
00:06:02    a73c2353d7..b62b223587  master      -> origin/master

b62b223587 is our guy, so I20190705-1800 will contain the fix.

For additional evidence see the tag: https://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=I20190705-1800&id=b62b223587dcd5da652588c255ae8a2001bb7091 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-06T15:53:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #81)
> (In reply to Till Brychcy from comment #80)
> > (In reply to Till Brychcy from comment #72)
> > thinking of source modules. So the "this.declaredPackages.put(...)" in
> > MB.addPackage is unnecessary and then this method is a NOP if
[...]
> 
> Let's please for a moment not delete any cache-related code. The current
> failure in bug 544712 seems to be caused by duplicate PPB for the same
> package, indicating that our caching story is currently broken!

Can I continue now? 
In the updated patch, I've still removed addPackage, but replaced the direct PPB constructor invocation with the new MB.createDeclaredPackage so the PPBs are guaranteed properly registered in their MB. (There is only one remaining invocation of the PPB constructor outside MB in BindingKeyResolver, which I've left alone for now). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-06T17:44:16Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #93)
> (In reply to Stephan Herrmann from comment #81)
> > (In reply to Till Brychcy from comment #80)
> > > (In reply to Till Brychcy from comment #72)
> > > thinking of source modules. So the "this.declaredPackages.put(...)" in
> > > MB.addPackage is unnecessary and then this method is a NOP if
> [...]
> > 
> > Let's please for a moment not delete any cache-related code. The current
> > failure in bug 544712 seems to be caused by duplicate PPB for the same
> > package, indicating that our caching story is currently broken!
> 
> Can I continue now? 

yes.

> In the updated patch, I've still removed addPackage, but replaced the direct
> PPB constructor invocation with the new MB.createDeclaredPackage so the PPBs
> are guaranteed properly registered in their MB.

Since I didn't add a test for bug 544712, we should at least re-test further changes done here against that bug. If you don't have an environment for testing it, just give me a note.

> (There is only one remaining
> invocation of the PPB constructor outside MB in BindingKeyResolver, which
> I've left alone for now).

I saw that too, couldn't really make head or tails of what's needed there ... </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-06T19:40:21Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145553 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=7404b0f200034ff780553aca9ce3c785a56994aa </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-06T19:42:20Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #94)
> 
> Since I didn't add a test for bug 544712, we should at least re-test further
> changes done here against that bug. If you don't have an environment for
> testing it, just give me a note.

I haven't. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-06T20:57:33Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #96)
> (In reply to Stephan Herrmann from comment #94)
> > 
> > Since I didn't add a test for bug 544712, we should at least re-test further
> > changes done here against that bug. If you don't have an environment for
> > testing it, just give me a note.
> 
> I haven't.

OK, I pulled the change, generated ecj.jar and ran the bug 544712, successfully.

At this point, to you have further plans of either review or cleanup?

Otherwise, why don't you update the review flag, so I can resolve the bug for M1? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-06T21:46:39Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #97)
> OK, I pulled the change, generated ecj.jar and ran the bug 544712,
> successfully.

Thanks.

> 
> At this point, to you have further plans of either review or cleanup?

I have a list of TODOs where I have some doubts and not all cleanups are done yet.

Cleanups note done yet:
- I still suspect the module parameter is not needed in SPB.combineWithSiblings (and therefore in PB.addPackage).
- remove getPackage0Any


Here's is a list of TODOs that I have open (no particular order).

- I think PackageBinding.getPackage(char[], ModuleBinding) can only work if moduleBinding is the enclosingModule, which it is when called from CUS.checkAndSetImports, but maybe not when called from Scope.getOnlyPackage (which is only used by DefaultBindingResolver). Reason is that the computed value depends on mod (for PPBs) but the getPackage0() is just based on name.
- Similar in PackageBinding.getTypeOrPackage
- Should the parent of PPB also always be a PPB?
- SPB.findPackage doesn't use module parameter at all except for passing to addPackage. I wonder if SPB.findPackage could be comletely removed, so the impl from PPB is used (doing this doesn't cause any test failures)
- Is it true, that all elements of LE.knowPackages are PPBs (possibly from another module) or SPBs whose enclosingModule is the LE's module? If not, should we try to reach that state?
- In CodeSnippetScope.getBinding, a null is passed as mod to packageBinding.getTypeOrPackage, which looks like it can lead to an NPE
- I think doing SplitPackageBinding.combine in a loop could lead to lots unnecessary  addWrappingSplitPackageBinding for intermediate results
- ModuleBinding.UNOBSERVABLE is used only in FileSystem, not by other NameEnvironments, which seems strange
- add the end of MB.getVisiblePackage, if parent is a SPB,  addPackage will try to add siblings even though the computed package should already be fine

> 
> Otherwise, why don't you update the review flag, so I can resolve the bug
> for M1?

I'm setting it to "+", as I'm sure that the current state is MUCH better than before this bug.

This bug is already quite long, so I'm ok if we close this for M1 and do further work in another bug (or separate bugs) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-08T21:02:32Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #98)
> I'm setting it to "+", as I'm sure that the current state is MUCH better
> than before this bug.

Thanks, resolving this bug for 4.13 M1.

Many thanks for the co-operation!

> This bug is already quite long, so I'm ok if we close this for M1 and do
> further work in another bug (or separate bugs)

Over to bug 549077. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T06:28:51Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #99)
> Many thanks for the co-operation!
Thanks, too! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T09:19:26Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> 
just to let you know:

  latest tests with ecj-I20190708-1800.jar are ok again
  no more strange behaviour so far

thanks </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T18:45:36Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145721 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T18:49:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #102)
> New Gerrit change created: https://git.eclipse.org/r/145721

I found some issues during testing:

Possible NPEs:
- IResource.getFileExtension() can return null
- fPackage can be null for ProblemReferenceBindings (problem in LE.combine)
- output directory can contain subdirectories with copied resources, so
fall back to sources if no .class found

I don't have standalone repos yet, I'll try to provide junits later (where possible). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T19:56:24Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #103)

> - IResource.getFileExtension() can return null

This can lead to an NPE if a project that is accessed as automatic module contains copied file resources without extension:

java.lang.NullPointerException
	at org.eclipse.jdt.internal.core.builder.ClasspathDirectory.lambda$0(ClasspathDirectory.java:262)
	at org.eclipse.core.internal.resources.Resource.lambda$1(Resource.java:117)
	at org.eclipse.core.internal.resources.Resource.lambda$0(Resource.java:85)
	at org.eclipse.core.internal.watson.ElementTreeIterator.doIteration(ElementTreeIterator.java:85)
	at org.eclipse.core.internal.watson.ElementTreeIterator.doIteration(ElementTreeIterator.java:90)
	at org.eclipse.core.internal.watson.ElementTreeIterator.doIteration(ElementTreeIterator.java:90)
	at org.eclipse.core.internal.watson.ElementTreeIterator.iterate(ElementTreeIterator.java:135)
	at org.eclipse.core.internal.resources.Resource.accept(Resource.java:94)
	at org.eclipse.core.internal.resources.Resource.accept(Resource.java:55)
	at org.eclipse.core.internal.resources.Resource.accept(Resource.java:117)
	at org.eclipse.core.internal.resources.Resource.accept(Resource.java:105)
	at org.eclipse.jdt.internal.core.builder.ClasspathDirectory.listPackages(ClasspathDirectory.java:261)
	at org.eclipse.jdt.internal.core.builder.ModulePathEntry.listPackages(ModulePathEntry.java:129)
	at org.eclipse.jdt.internal.core.builder.NameEnvironment.listPackages(NameEnvironment.java:696)
	at org.eclipse.jdt.internal.compiler.lookup.BinaryModuleBinding$AutomaticModuleBinding.getDeclaredPackage(BinaryModuleBinding.java:65)
	at org.eclipse.jdt.internal.compiler.lookup.ModuleBinding.combineWithPackagesFromOtherRelevantModules(ModuleBinding.java:670) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T20:05:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145721 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=32a3857797bf19248aee13ba9b4a02f63d66f233 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T21:22:53Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> While trying to isolate an example that needs the change in ClasspathMultiDirectory, I noted that it still can happen, that duplicate PPBs are created:

org.eclipse.jdt.internal.compiler.lookup.SourceModuleBinding(org.eclipse.jdt.internal.compiler.lookup.ModuleBinding).createDeclaredPackage(char[][], org.eclipse.jdt.internal.compiler.lookup.PackageBinding) line: 326	
org.eclipse.jdt.internal.compiler.lookup.LookupEnvironment.createPlainPackage(char[][]) line: 1147	
org.eclipse.jdt.internal.compiler.lookup.CompilationUnitScope.buildTypeBindings(org.eclipse.jdt.internal.compiler.env.AccessRestriction) line: 135	
org.eclipse.jdt.internal.compiler.lookup.LookupEnvironment.buildTypeBindings(org.eclipse.jdt.internal.compiler.ast.CompilationUnitDeclaration, org.eclipse.jdt.internal.compiler.env.AccessRestriction) line: 473	
org.eclipse.jdt.internal.compiler.Compiler.internalBeginToCompile(org.eclipse.jdt.internal.compiler.env.ICompilationUnit[], int) line: 839	
org.eclipse.jdt.internal.compiler.Compiler.beginToCompile(org.eclipse.jdt.internal.compiler.env.ICompilationUnit[]) line: 394	
org.eclipse.jdt.internal.compiler.Compiler.compile(org.eclipse.jdt.internal.compiler.env.ICompilationUnit[], boolean) line: 444	
org.eclipse.jdt.internal.compiler.Compiler.compile(org.eclipse.jdt.internal.compiler.env.ICompilationUnit[]) line: 426	
org.eclipse.jdt.internal.core.builder.BatchImageBuilder(org.eclipse.jdt.internal.core.builder.AbstractImageBuilder).compile(org.eclipse.jdt.internal.core.builder.SourceFile[], org.eclipse.jdt.internal.core.builder.SourceFile[], boolean) line: 386	
org.eclipse.jdt.internal.core.builder.BatchImageBuilder.compile(org.eclipse.jdt.internal.core.builder.SourceFile[], org.eclipse.jdt.internal.core.builder.SourceFile[], boolean) line: 214	

createDeclaredPackage doesn't check if the packages is already in the map.

Maybe we should simply use getOrCreateDeclaredPackage instead of createDeclaredPackage/createDeclaredToplevelPackage everywhere?

Unfortunately it is getting too late today. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T07:40:12Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145762 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T09:00:32Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145762 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=3122a06e3a023df004c6d9fca731a8e0da4ab108 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T10:49:52Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #106)
> While trying to isolate an example that needs the change in
> ClasspathMultiDirectory, I noted that it still can happen, that duplicate
> PPBs are created: 
> [...]

This happened, if a package was exported in module-info.java, but the first compiled package was a sibling which was not mentioned in the module-info.java, in which case a duplicate top-level package and then duplicate lower case packages were created.

I have not been able to create a visible defect for this (after the patch from comment #102), but there might be one when other modules are involved, which access the packages via mb.getDeclaredPackage, so I fixed it in the patch in comment #108 and verified it in the debugger.

The patch in comment #108 also contains a test for the situation from comment #104.

Setting to resolved for 4.13M1 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-20T17:02:53Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> @Stephan and Till: I just wanted to let you know that with version 4.13 M1 I'm not able to reproduce any of the bugs I described (Comment #18). Thank you very much(!) for your prompt work and refactoring during the last weeks. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-20T17:18:49Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sam Peters from comment #110)
> @Stephan and Till: I just wanted to let you know that with version 4.13 M1
> I'm not able to reproduce any of the bugs I described (Comment #18). Thank
> you very much(!) for your prompt work and refactoring during the last weeks.

Phew! :)

Thanks for confirming!
Marking as verified by reporter (of original bug 547113). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-08-21T12:47:45Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 550263 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-23T20:21:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 550801 has been marked as a duplicate of this bug. *** </td> </tr>
        </table>
</body>
</html>
