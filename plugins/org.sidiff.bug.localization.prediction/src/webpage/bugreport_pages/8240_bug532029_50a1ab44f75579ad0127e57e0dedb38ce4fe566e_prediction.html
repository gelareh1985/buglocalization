<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 532029 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> [annotation processor] RoundDispatcher.handleProcessor throws NoClassDefFoundError </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2018-03-05T16:44:16Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> VERIFIED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 567183 - [compiler] No error for a var declaration that refers to a
package private type in another package

Change-Id: I14951582df0982a9ec2bbf11916549ef82031120
Signed-off-by: Jay Arthanareeswaran <jarthana@in.ibm.com>
 </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2020-09-22T02:56:36Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerToolTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RunCompilerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Compiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JDTCompilerAdapter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterBugsTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleInfoBuilder; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> InterfaceMethodsTest_9; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClasspathTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractCompilerTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavadocParser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FieldInitsFakingFlowContext; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractLeakTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FormatterCommentsBugsTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClasspathUtil; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> LambdaFactory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> TextBlockTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FieldBackPointerTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AptConfig$ProcessorOptionsParser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ReferenceExpressionSyntaxTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> SingleNameReference; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> OneLineEnforcer; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> StructDef; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacTestOptions$JavacBug8179483; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RegressionTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Disassembler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> SelectionParser; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/AbstractRegressionTest$JavacCompiler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.compiler.tool.tests/Lorg/eclipse/jdt/compiler/tool/tests/CompilerToolTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunCompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunOnly335CompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.compiler.tool.tests/Lorg/eclipse/jdt/compiler/tool/tests/CompilerToolJava9Tests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; font-weight: bold; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/Compiler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/JDTCompilerAdapter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/builder/ModuleInfoBuilder; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ClassFile; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/InterfaceMethodsTest_9; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/SwitchExpressionsYieldTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/BatchCompilerTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/JavadocTestForModule; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/ModuleAttributeTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ClasspathTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/batch/Main; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/util/AbstractCompilerTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/parser/JavadocParser; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.compiler.tool.tests/Lorg/eclipse/jdt/compiler/tool/tests/AbstractCompilerToolTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ModuleBuilderTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/flow/FieldInitsFakingFlowContext; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.builder/Lorg/eclipse/jdt/core/tests/builder/AbstractLeakTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/formatter/FormatterCommentsBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/generatedfile/ClasspathUtil; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/CompilerInvocationTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullAnnotationBatchCompilerTest; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-03-05T16:44:16Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 273004
JMH and its dependencies in one jar

Since roughly ECJ 4.7.2, we are seeing a NoClassDefFoundError when using an annotation processor from JMH[1]. This should be reproducible with the following TestJMH_1_18 class:

----
package test.jmh_1_18;
import org.openjdk.jmh.annotations.*;

@Warmup(iterations = 2)
@Measurement(iterations = 2)
@Fork(2)
public class TestJMH_1_18 {

    @Benchmark
    @BenchmarkMode(Mode.All)
    public void testJMH() {
    }
}
----

rm -rf bin; java -jar ecj-4.8M5.jar -cp jmh-all.jar -nowarn -d bin -processorpath jmh-all.jar -source 1.8 TestJMH_1_18.java
----------
1. ERROR in /Users/dsimon/fff/test/jmh_1_18/generated/TestJMH_1_18_testJMH_jmhTest.java (at line 0)
	package test.jmh_1_18.generated;
	^
Internal compiler error: java.lang.Exception: java.lang.NoClassDefFoundError: org/openjdk/jmh/runner/BenchmarkListEntry at org.eclipse.jdt.internal.compiler.apt.dispatch.RoundDispatcher.handleProcessor(RoundDispatcher.java:169)
----------
1 problem (1 error)

rm -rf bin; java -jar ecj-4.5.1.jar -cp jmh-all.jar -nowarn -d bin -processorpath jmh-all.jar -source 1.8 TestJMH_1_18.java

[1] http://openjdk.java.net/projects/code-tools/jmh/ </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-08-30T06:45:52Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I ran into this as well with Tycho 1.2.0 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-12-10T08:26:36Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Any chance of this getting some attention? It's preventing the Graal project from supporting development on recent versions of Eclipse. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-01-08T19:33:20Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I can reproduce with ecj starting from 4.7.2 and 4.8M3.

It fails in this stack (running JDT HEAD on JDK-9 in this case):

URLClassPath.getLoader(int) line: 352	
URLClassPath.getResource(String, boolean) line: 243	
URLClassLoader$1.run() line: 450	
URLClassLoader$1.run() line: 447	
AccessController.doPrivileged(PrivilegedExceptionAction<T>, AccessControlContext) line: not available [native method]	
URLClassLoader.findClass(String) line: 446	
URLClassLoader(ClassLoader).loadClass(String, boolean) line: 563	
URLClassLoader(ClassLoader).loadClass(String) line: 496	
BenchmarkGenerator.complete(GeneratorSource, GeneratorDestination) line: 132	
BenchmarkProcessor.process(Set<TypeElement>, RoundEnvironment) line: 59	
RoundDispatcher.handleProcessor(ProcessorInfo) line: 142	
RoundDispatcher.round() line: 113	
BatchAnnotationProcessorManager(BaseAnnotationProcessorManager).processAnnotations(CompilationUnitDeclaration[], ReferenceBinding[], boolean) line: 171	
Compiler.processAnnotations() line: 978	
Compiler.compile(ICompilationUnit[], boolean) line: 450	
Compiler.compile(ICompilationUnit[]) line: 426	
Main.performCompilation() line: 4704	
Main.compile(String[]) line: 1768	
Main.main(String[]) line: 1491	

Here null is returned because URLClassPath.closed == true;

Closing happens in this call stack:

URLClassPath.closeLoaders() line: 166	
URLClassLoader.close() line: 376	
BatchAnnotationProcessorManager.reset() line: 263	
Compiler.processAnnotations() line: 967	
Compiler.compile(ICompilationUnit[], boolean) line: 450	
Compiler.compile(ICompilationUnit[]) line: 426	
Main.performCompilation() line: 4704	
Main.compile(String[]) line: 1768	
Main.main(String[]) line: 1491	

This doesn't look awfully suspicious, if you ask me...

Note, that here:
  Compiler.compile(ICompilationUnit[], boolean) line: 450	
we have a flag 'lastRound'.

Should that be passed down so we this.annotationProcessorManager.reset() only for the last round?? Or is some of the reset() work needed between rounds?

Is that enough information for you to proceed? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T20:44:16Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 547171 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T20:46:29Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The suspicious close() was added via https://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=BETA_JAVA9&id=0171d3fa20410a884ea6de07ec393bc179fb73bd </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-29T09:58:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #3)

> Should that be passed down so we this.annotationProcessorManager.reset()
> only for the last round?? Or is some of the reset() work needed between
> rounds?

Thanks Stephan, for the investigation. The reset() is certainly needed between rounds, mostly for what we in super.reset(), but we need to find a way to do the close() only at the end of final round. I need to see if this information is already passed to the BaseAnnotationProcessorManager. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-29T10:11:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Jay Arthanareeswaran from comment #6)
> Thanks Stephan, for the investigation. The reset() is certainly needed
> between rounds, mostly for what we in super.reset(), but we need to find a
> way to do the close() only at the end of final round. I need to see if this
> information is already passed to the BaseAnnotationProcessorManager.

On closer look, this may not be sufficient. The "lastRound" in the compiler doesn't necessarily mean there won't be another round as the annotation processors can still generate more files triggering compilation. Perhaps, we can check for newly added units and classes and if none then invoke close(). Will see what it takes during 4.13. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-08-27T06:37:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Bulk Move Out of 4.13 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-09T14:12:51Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> What's the status here? We're running into this with org.eclipse.jdt:ecj:3.18.0.

See also https://github.com/spring-projects/sts4/issues/171, which is exactly the error we're seeing.

Note that the AspectJ developer(s) have actually fixed this in their patched ecj version. Unfortunately they include only a zip of the compiler sources in their repo, but:

* download https://github.com/eclipse/org.aspectj/blob/2bcf229024608c411d8effa248e63c8742b35508/org.eclipse.jdt.core/jdtcore-for-aspectj-src.zip (their sources before their fix)

* download https://github.com/eclipse/org.aspectj/blob/380ef0ec470fcf02820bde4d22d3bd1a9efaf999/org.eclipse.jdt.core/jdtcore-for-aspectj-src.zip (their sources after their fix)

Unpack both in different directories and compare to see the 

I cannot tell whether that way to fix it is complete or sufficient. It goes in the direction that is suggested here. (Delaying closing the classpath.) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-11T06:50:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Thomas Wolf from comment #9)
> What's the status here? We're running into this with
> org.eclipse.jdt:ecj:3.18.0.

Sorry, we couldn't spend time on this as the team is currently busy with the Java 13 work. However, since you have already found the fix, would you be able to bring that fix in the form of a patch? If there's a patch, we will be able to take this to closure sooner. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-11T08:46:03Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/149331 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-11T08:48:24Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #11)
> New Gerrit change created: https://git.eclipse.org/r/149331

There you go. As I wrote above: I have no idea if this way to fix it is sound. Please take over this change. (I also wouldn't know how to write tests for this, and I don't have the time to figure it out.) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-12T12:23:11Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Thomas Wolf from comment #12)
> (In reply to Eclipse Genie from comment #11)
> > New Gerrit change created: https://git.eclipse.org/r/149331
> 
> There you go. As I wrote above: I have no idea if this way to fix it is
> sound. Please take over this change. (I also wouldn't know how to write
> tests for this, and I don't have the time to figure it out.)

Thanks, I slightly modified the patch:

- new method shouldn't be abstract, since this left some sub classes without an implementation

- renamed the method to speak more about intent (final cleanUp) rather than implementation (close a class loader, which only one subclass actually owns).

I manually checked with the steps from comment 0 that this indeed fixes the problem.

@Jay: Just like Thomas I'm not sufficiently versed in writing tests for annotation processing. Do you insist in having a test case, or may I push the fix without a test? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-12T13:14:04Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #13)
> @Jay: Just like Thomas I'm not sufficiently versed in writing tests for
> annotation processing. Do you insist in having a test case, or may I push
> the fix without a test?

+1 for the fix without a test. Thanks Stephan and Thomas! </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-12T16:03:37Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/149331 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=328421a0239051bed525c280adc9937c7a561a78 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-09-12T16:05:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #15)
> Gerrit change https://git.eclipse.org/r/149331 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=328421a0239051bed525c280adc9937c7a561a78

Released for 4.14 M1
thanks </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-10-09T10:17:16Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Verified for Eclipse Version: 2019-12 (4.14) M1 with  Build id: I20191008-1800 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-01-07T20:59:57Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> This might need to be reopened. As far as I can tell, Compiler.processAnnotations() is called into multiple times, so closing after one call is still too premature.

Example from Gradle build:

Stacktrace where close happens:

java.lang.Throwable
        at java.net.URLClassLoader.close(URLClassLoader.java:288)
        at org.eclipse.jdt.internal.compiler.apt.dispatch.BatchAnnotationProcessorManager.cleanUp(BatchAnnotationProcessorManager.java:264)
        at org.eclipse.jdt.internal.compiler.Compiler.processAnnotations(Compiler.java:933)
        at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:450)
        at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:426)
        at org.eclipse.jdt.internal.compiler.batch.Main.performCompilation(Main.java:4771)
        at org.eclipse.jdt.internal.compiler.batch.Main.compile(Main.java:1773)
        at org.eclipse.jdt.internal.compiler.batch.Main.main(Main.java:1496)

Stacktrace where NoClassDefFoundError occurs:

java.lang.Throwable
        at dagger.internal.codegen.DaggerStatisticsCollector.processingStopped(DaggerStatisticsCollector.java:80)
        at dagger.internal.codegen.ComponentProcessor.postRound(ComponentProcessor.java:188)
        at dagger.shaded.auto.common.BasicAnnotationProcessor.process(BasicAnnotationProcessor.java:176)
        at org.eclipse.jdt.internal.compiler.apt.dispatch.RoundDispatcher.handleProcessor(RoundDispatcher.java:142)
        at org.eclipse.jdt.internal.compiler.apt.dispatch.RoundDispatcher.round(RoundDispatcher.java:113)
        at org.eclipse.jdt.internal.compiler.apt.dispatch.BaseAnnotationProcessorManager.processAnnotations(BaseAnnotationProcessorManager.java:171)
        at org.eclipse.jdt.internal.compiler.Compiler.processAnnotationsInternal(Compiler.java:995)
        at org.eclipse.jdt.internal.compiler.Compiler.processAnnotations(Compiler.java:931)
        at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:450)
        at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:469)
        at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:426)
        at org.eclipse.jdt.internal.compiler.batch.Main.performCompilation(Main.java:4771)
        at org.eclipse.jdt.internal.compiler.batch.Main.compile(Main.java:1773)
        at org.eclipse.jdt.internal.compiler.batch.Main.main(Main.java:1496)

Gradle error:

Internal compiler error: java.lang.Exception: java.lang.BootstrapMethodError: java.lang.NoClassDefFoundError: dagger/internal/codegen/DaggerStatisticsRecorder at org.eclipse.jdt.internal.compiler.apt.dispatch.RoundDispatcher.handleProcessor(RoundDispatcher.java:172)

Tested with ecj batch compiler 4.14 release. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-08-26T08:26:19Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Henry Tung from comment #18)
> This might need to be reopened. As far as I can tell,
> Compiler.processAnnotations() is called into multiple times, so closing
> after one call is still too premature.

In the Scout project we see this error too. It is less common than before the fix but it still occurs. Possibly moving
this.annotationProcessorManager.cleanUp();
to the end of
Compiler.compile(ICompilationUnit[] sourceUnits, boolean lastRound)
instead of calling it prematurely in Compiler processAnnotations() could work? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-20T12:36:04Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/c/jdt/eclipse.jdt.core/+/169633 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-20T12:43:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Scout project here again. I have created a new patch, which will now hopefully fix this issue for us (graalvm and others). I assume the problem is that in case of a SourceTypeCollisionException (with lastRound == false) the new cleanUp method is called prematurely. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-22T03:40:59Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Ralph Steiner from comment #21)
> Scout project here again. I have created a new patch, which will now
> hopefully fix this issue for us (graalvm and others). I assume the problem
> is that in case of a SourceTypeCollisionException (with lastRound == false)
> the new cleanUp method is called prematurely.

When you say 'hopefully' and the patch doesn't have a test, it's that much more work for those reviewing :)

Will take a look at it this week. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-22T06:18:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Patch looks alright to me. Something to note: In our entire test suite, there's just one testcase in BuilderTests.testBug468893() that triggers this code. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-22T06:19:00Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/c/jdt/eclipse.jdt.core/+/169633 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=7149a5b706ba5c5fae4e1d1c8a919f79aebbcd6e </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-22T06:20:56Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Moving back to resolved. Not changing the target, but setting the whiteboard so that this shows in our verification list for 4.18 M1. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-22T19:03:54Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Is it possible that because of this change some tests in jdt.ui fail now? There are annotations that now have a newline. 

Content not as expected: is
package test1;

import org.eclipse.jdt.annotation.NonNull;

public class E {
    public <T extends Number> double foo(T t) {
        @NonNull
        Number n=t;
        return n.doubleValue();
    }
}

Differs at pos 141: onNull^
     
expected:
package test1;

import org.eclipse.jdt.annotation.NonNull;

public class E {
    public <T extends Number> double foo(T t) {
        @NonNull Number n=t;
        return n.doubleValue();
    }
}
 expected:<...) {
        @NonNull[] Number n=t;
       ...> but was:<...) {
        @NonNull[
       ] Number n=t;
       ...> 

Could easily be that it is one of our jdt.ui gerrits that is responsible but just want to be sure and don't understand this right now... </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-23T02:55:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Carsten Hammer from comment #26)
> Is it possible that because of this change some tests in jdt.ui fail now?
> There are annotations that now have a newline. 
> 
...
> Could easily be that it is one of our jdt.ui gerrits that is responsible but
> just want to be sure and don't understand this right now...

I highly doubt that. This change does nothing to alter the annotations. Hypothetically, it's possible that this fixed some annotation processor that is producing a different result now. But chances are very slim. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2020-09-30T23:43:39Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Verified for 4.18 m1 Version: 2020-12 (4.18) Build id: I20200928-1800
[by code walkthrough] </td> </tr>
        </table>
</body>
</html>
