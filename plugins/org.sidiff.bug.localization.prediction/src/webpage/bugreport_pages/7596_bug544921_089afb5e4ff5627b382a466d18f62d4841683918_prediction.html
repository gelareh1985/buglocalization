<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 544921 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> CompilationUnitStructureRequestor.resolveDuplicates has poor performance in extremely large source files with many field definitions </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2019-02-28T15:13:38Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> RESOLVED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 544921 - [performance] Poor performance with large source files

This patch uses sorted arrays in the CompilationUnitScope to improve
the runtime behavior with large source files where a large number of
dependent types exist and need to be recorded in the
qualifiedReferences, simpleNameReferences and rootReferences.

Lookup of memberTypes by name from a ReferenceBinding does use binary
search logic, too (similar approach as with fields).

Sorting of char[][] is extracted to SortedCharArrays.

CompoundNameVector is removed and replaced by SortedCompoundNameVector.
SimpleNameVector is removed and replaced by SortedSimpleNameVector.

Change-Id: Ib66c7f0399cdea0c5558a15bf835406ceb828988
Signed-off-by: Sebastian Zarnekow <sebastian.zarnekow@gmail.com>
Also-By: Simeon Andreev <simeon.danailov.andreev@gmail.com>
Signed-off-by: Andrey Loskutov <loskutov@gmx.de> </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2019-06-27T14:25:50Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IField; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RawGrowableArray; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterBugsTestJLS8; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RunCompilerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FullSourceWorkspaceModelTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GeneratedFileManager; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GenericsRegressionTest_1_8; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Main; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleBuilderTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFile; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> MatchLocator; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFile; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BatchCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FormatterBugsTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ProblemReporter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> EclipseFileManager; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JavadocParser; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Disassembler; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> NestedTypeBinding; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> StandAloneASTParserTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Database; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Util; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CastExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClasspathJrt; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> JDTCompilerAdapter; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/field/IField; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/RawGrowableArray; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/CompilationUnitResolver; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunCompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.performance/Lorg/eclipse/jdt/core/tests/performance/FullSourceWorkspaceModelTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunOnly335CompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter9Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/generatedfile/GeneratedFileManager; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_1_8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/batch/Main; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/JavadocTest_1_4; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS3; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ModuleBuilderTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/ClassFile; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/indexer/Indexer; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/SearchableEnvironment; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/JavadocTest_1_5; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/search/matching/MatchLocator; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ClassFileTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/JavadocTest_1_3; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/ClassFile; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/JavadocBugsTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/CompilationUnitTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/java/NdResourceFile; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter10Test; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/compiler/batch/BatchCompiler; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-28T15:13:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277715
YourKit snapshot showing a lot of time spent in CompilationUnitStructureRequestor.resolveDuplicates.

We have a case in our product with a generated source file that is ~30 MB. The file defines numerous fields (each representing a chip constant). After a slight modification, saving the source file causes a UI freeze of above 20 minutes (on a HPZ620 workstation, workspace is on a local hard disk). This save operation takes much longer than a save operation in a normal editor, such as KWrite or Kate (on Linux).


After profiling (see attached YourKit snapshots), we determined that nearly all of the computation time is spent in CompilationUnitStructureRequestor.resolveDuplicates, due to computing hash codes of objects:

org.eclipse.jdt.internal.core.CompilationUnitStructureRequestor.resolveDuplicates(SourceRefElement) CompilationUnitStructureRequestor.java 2 232 860ms (98% of total thread time)


Switching to JRE hash map implementations reduces the UI freeze to about 2 minutes, which for a file of this size is more acceptable (again see attached YourKit snapshots):

org.eclipse.jdt.internal.core.CompilationUnitStructureRequestor.resolveDuplicates(SourceRefElement) CompilationUnitStructureRequestor.java 5 636 ms (12% of total thread time) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-28T15:18:57Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 277716
YourKit snapshot showing improved execution time of  CompilationUnitStructureRequestor.resolveDuplicates after switching its object-to-int hash maps to JRE hash maps. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-28T15:25:51Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/137816 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-28T15:26:53Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Unfortunately we cannot provide the source file with which we are having problems. If necessary I'll try to provide a reproduction source file. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-28T15:30:58Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Simeon Andreev from comment #3)
> Unfortunately we cannot provide the source file with which we are having
> problems. If necessary I'll try to provide a reproduction source file.

I think you can replace internal names with some random strings and attach that result here, if it is not too much overhead. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-28T15:36:51Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I'll try to create an example from scratch tomorrow.

The original file is generated and has an unfortunate structure. There are some inner class definitions, then a lot of fields, then some more inner classes and fields and so on. It would be very hard to ensure I've scrambled everything in the file, it has 370k lines. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-02-28T15:38:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Simeon Andreev from comment #5)
> I'll try to create an example from scratch tomorrow.
> 
> The original file is generated and has an unfortunate structure. There are
> some inner class definitions, then a lot of fields, then some more inner
> classes and fields and so on. It would be very hard to ensure I've scrambled
> everything in the file, it has 370k lines.

OK, skip this please. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-16T17:32:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/137816 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=b9957bd06da31c58841b8ad50731877e58c32071 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-03T11:48:52Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> We should check if we can improve the remaining running time with changes similar to: https://git.eclipse.org/r/#/c/139806/

So far I tried with hash sets, but since the objects that are used are char arrays (1D and 2D) that change is not so pretty. Sorting on the other hand is maybe easier. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-15T07:20:19Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I profiled with the patch from bug 545491 (and the patch here), the problem is gone. What took 20+ minutes without patches and 5+ minutes with the patch here, how takes about 20-30 seconds. This is enough for a file this size.

Unfortunately the patch for bug 545491 was reverted due to introduced regressions. I'll wait for another patch (should be of a similar nature), will profile again and will then close this if results are good. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-15T07:27:11Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I've plans to work on bug 545491 until Wednesday. I'll keep you posted. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-15T09:22:24Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> see https://git.eclipse.org/r/140588 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-23T11:43:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 278362
Generator for huge Java file

Attached a slightly modified example Java project which can be used to generate huge Java files and validate the performance.

Just run "Generator" as Java application and try to open generated DeviceXY.java file.

With the build I20190422-1800 I can open 14 MB file with ~180 kilolines reasonably fast. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-09T10:05:31Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> What's the state of this now that the fix for the ReferenceCollection is available on master? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-09T10:14:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> When I checked with the first fix (that was reverted), the build time was reduced to 20-30 seconds. This is acceptable to me at least. I assume this is fixed.

I'll anyway do another measurement either today or tomorrow, since now we have the actual fix for ReferenceCollection in our product. I'll then let you know. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-09T10:15:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> 20-30 seconds ... not superb. Just in case, could you please share a snapshot / yourkit screenshot with your findings? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-09T15:04:36Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 278556
YourKit snapshot when compiling the big source, after performance improvements in ReferenceCollection. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-09T15:06:53Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Attached the snapshot. IMO fixed; 30 MB sources aren't really sources, they are data saved as sources. That the user must pay for this with running time 5-6x that of javac is IMO fine. Its not something the user should be doing in first place. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-09T15:10:59Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> In case we do want further improvements, here is the code that needs improvement:

Scope.java:3246 org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[], ReferenceBinding) 12450

Scope.java:3246 org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[], ReferenceBinding) 7028 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-09T16:26:52Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Simeon Andreev from comment #18)
> In case we do want further improvements, here is the code that needs
> improvement:
> 
> Scope.java:3246
> org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[],
> ReferenceBinding) 12450
> 
> Scope.java:3246
> org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[],
> ReferenceBinding) 7028

I had a quick look at those two candidates, too. The appear to do quadratic operations. I'll try to come up with smth better. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T06:57:12Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Looks like I was testing with an 8MB source file and not the original case of 26MB source file. The original case now takes 7 minutes. I'll look into this as well; previously I tried replacing the arrays with hash maps, didn't turn out particularly well. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T07:31:02Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Please have a look at org.eclipse.jdt.internal.compiler.lookup.SourceTypeBinding.getField(char[], boolean) where you can find these lines

	if ((this.tagBits & TagBits.AreFieldsComplete) != 0)
		return ReferenceBinding.binarySearch(fieldName, this.fields);

	// lazily sort fields
	if ((this.tagBits & TagBits.AreFieldsSorted) == 0) {
		int length = this.fields.length;
		if (length > 1)
			ReferenceBinding.sortFields(this.fields, 0, length);
		this.tagBits |= TagBits.AreFieldsSorted;
	}

We should probably also explore sorting / binary searches for org.eclipse.jdt.internal.compiler.lookup.ReferenceBinding.getMemberType(char[]) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T08:58:47Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 278565
YourKit snapshot for an even bigger source file. 6-7 minutes compile for 26MB source file, with many fields.

Added a snapshot with the bigger file, for completeness sake. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T11:07:47Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I see quadratic code here:

org.eclipse.jdt.internal.compiler.lookup.CompilationUnitScope.recordTypeReferences(TypeBinding[])

It uses ObjectVector, which in turn browses the entire vector each time before inserting. To my amazement replacing it with a linked hash set *degrades* performance. The search in the ObjectVector is done "of course" based on identity and not on equals/hashCode; maybe we have some objects in the vector which break the code when using a hash map, due to being equal but not identical... Or we just have types for which the hash code is very expensive to compute.

The array definitely gets big; I've added code which outputs the array size every *10 000* calls to the method above, here is some output:

array size is: 95707
array size is: 98178
array size is: 100650
array size is: 103121
array size is: 105592
array size is: 108064
array size is: 110535
array size is: 113007
array size is: 115478
array size is: 117950
array size is: 120421
array size is: 122893
array size is: 125364
array size is: 127836
array size is: 130307
array size is: 132779
array size is: 135250
array size is: 137721
array size is: 140193
array size is: 142664
array size is: 145136
array size is: 147607
array size is: 150079
array size is: 152550
array size is: 155022
array size is: 157493
array size is: 159965
array size is: 162436
array size is: 164908
array size is: 167379
array size is: 169850
array size is: 172322
array size is: 174793
array size is: 177265
array size is: 179736
array size is: 182208
array size is: 184679
array size is: 187150
array size is: 189621
array size is: 192093
array size is: 194564
array size is: 197036
array size is: 199507
array size is: 201978
array size is: 204450
array size is: 206921
array size is: 209393
array size is: 211864
array size is: 214336
array size is: 216807
array size is: 219279
array size is: 221750
array size is: 224222
array size is: 226693
array size is: 229165
array size is: 231636
array size is: 234107
array size is: 236579
array size is: 239050
array size is: 241522
array size is: 243993
array size is: 246465
array size is: 248936
array size is: 251408
array size is: 253879
array size is: 256351
array size is: 258822
array size is: 261294
array size is: 263765
array size is: 266236
array size is: 268708
array size is: 271179
array size is: 273651
array size is: 276122
array size is: 278594
array size is: 281065
array size is: 283537
array size is: 286008
array size is: 288480
array size is: 290951
array size is: 293423
array size is: 295894
array size is: 298365
array size is: 300837
array size is: 303308
array size is: 305779
array size is: 308251
array size is: 310722
array size is: 313194
array size is: 315665
array size is: 318137
array size is: 320608
array size is: 323080
array size is: 325551
array size is: 328023
array size is: 5484
array size is: 7955
array size is: 10427
array size is: 12898
array size is: 15370
array size is: 17841
array size is: 20313
array size is: 22784
array size is: 25256
array size is: 27727
array size is: 30199
array size is: 32670
array size is: 35142
array size is: 37613
array size is: 40084
array size is: 42556
array size is: 45027
array size is: 47499
array size is: 49970
array size is: 52442
array size is: 54913
array size is: 57385
array size is: 59856
array size is: 62328
array size is: 64799
array size is: 67271
array size is: 69742
array size is: 72213
array size is: 74685
array size is: 77156
array size is: 79628
array size is: 82099
array size is: 84571
array size is: 87042
array size is: 89514
array size is: 91985
array size is: 94456
array size is: 96927
array size is: 99399
array size is: 101870
array size is: 104341
array size is: 106813
array size is: 109284
array size is: 111756
array size is: 114227
array size is: 116699
array size is: 119170
array size is: 121642
array size is: 124113
array size is: 126585
array size is: 129056
array size is: 131528
array size is: 133999

So we definitely have quadratic complexity. I'll see if I can be clever with a hash map instead of a set (to also test for identity). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T12:53:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> org.eclipse.jdt.internal.compiler.lookup.ReferenceBinding.hashCode() seems to be inconsistent, in that the type has no equals implementation yet its possible for 2 hash codes to be equal. Not sure why that would be a problem but the hash map seems to be going through an endless loop while adding an object of type "org.eclipse.jdt.internal.compiler.lookup.MissingTypeBinding". Kind of odd. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T13:42:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/141973 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-10T14:06:45Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Created attachment 278569
YourKit snapshot after gerrit change 141973.

The compile is down to a minute with this change: https://git.eclipse.org/r/#/c/141973/

The rest of time time seems to be spread out here:

Scope.java:3246 org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[], ReferenceBinding) 3920

Scope.java:3246 org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[], ReferenceBinding) 2436

ProblemHandler.java:241 org.eclipse.jdt.internal.compiler.CompilationResult.record(CategorizedProblem, ReferenceContext, boolean) 2045

Compiler.java:907 org.eclipse.jdt.internal.compiler.lookup.CompilationUnitScope.storeDependencyInfo() 4382

CompilationResult.java:248 org.eclipse.jdt.internal.compiler.CompilationResult.quickPrioritize(CategorizedProblem[], int, int) 2447

FieldDeclaration.java:275 org.eclipse.jdt.internal.compiler.lookup.CompilationUnitScope.recordTypeConversion(TypeBinding, TypeBinding) 23087

Scope.java:3246 org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[], ReferenceBinding) 5236

Scope.java:3246 org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[], ReferenceBinding) 4131

ProblemHandler.java:241 org.eclipse.jdt.internal.compiler.CompilationResult.record(CategorizedProblem, ReferenceContext, boolean) 2105

Scope.java:3246 org.eclipse.jdt.internal.compiler.lookup.Scope.findMemberType(char[], ReferenceBinding) 1873 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-19T15:07:21Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/142396 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-05-21T06:21:36Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Bulk move to 4.13 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-27T16:58:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/142396 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=ce38a825e5163c3b9eafad08b20d1266948e370e </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T07:21:06Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #29)
> Gerrit change https://git.eclipse.org/r/142396 was merged to [master].
> Commit:
> http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
> ?id=ce38a825e5163c3b9eafad08b20d1266948e370e

This caused test fails in testBuildLargeFile_08, due OOM errors :-(
I will push a patch ASAP. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T07:30:32Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145080 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T08:59:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The latest commit is causing this:

IUs in current repo that increase versions but with qualifier only

Count: 1
IU id	Reference (old) version	Current (new) version
org.eclipse.jdt.core.tests.builder	3.10.600.v20190421-0854	3.10.600.v20190627-1425

Reported in https://download.eclipse.org/eclipse/downloads/drops4/I20190627-1800/buildlogs/reporeports/reports/versionChecks.html


Please increase the bundle version. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T09:00:13Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> This causes compilation failures like follows in my workspace.

The class file EnumMap<K,V> contains a signature 'Ljava/util/EnumMap<TK;TV;>.EnumMapIterator<Ljava/util/Map$Entry<TK;TV;>;>;' ill-formed at position 27

I don't have a standalone example yet.


(In reply to Eclipse Genie from comment #31)
> New Gerrit change created: https://git.eclipse.org/r/145080

Disabling tests is a not a good idea. Maybe we shouldn't use JDK-HashMaps here after all. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T09:04:25Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #33)
> This causes compilation failures like follows in my workspace.
> 
> The class file EnumMap<K,V> contains a signature
> 'Ljava/util/EnumMap<TK;TV;>.EnumMapIterator<Ljava/util/Map$Entry<TK;TV;>;>;'
> ill-formed at position 27
> 
> I don't have a standalone example yet.

No errors in the log, just a compilation error?

> (In reply to Eclipse Genie from comment #31)
> > New Gerrit change created: https://git.eclipse.org/r/145080
> 
> Disabling tests is a not a good idea. Maybe we shouldn't use JDK-HashMaps
> here after all.

The test generates HUGE Java files. We run Eclipse with 8 - 12 GB heap to be able to work with such files, so the 1 GB used by default is simply not fitting to the test data. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T09:17:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Repro:

import java.util.EnumMap;

enum E {

}

public class Test {
    Object x = new EnumMap<E, String>(E.class) {
        {
            E.values();
        }
    };

}

causes:

The class file EnumMap<K,V> contains a signature 'Ljava/util/EnumMap<TK;TV;>.EnumMapIterator<Ljava/util/Map$Entry<TK;TV;>;>;' ill-formed at position 27 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T09:20:43Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Andrey Loskutov from comment #34)
> The test generates HUGE Java files. We run Eclipse with 8 - 12 GB heap to be
> able to work with such files, so the 1 GB used by default is simply not
> fitting to the test data.

Well before this patch it was fitting, wasn't it? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T09:24:11Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #36)
> (In reply to Andrey Loskutov from comment #34)
> > The test generates HUGE Java files. We run Eclipse with 8 - 12 GB heap to be
> > able to work with such files, so the 1 GB used by default is simply not
> > fitting to the test data.
> 
> Well before this patch it was fitting, wasn't it?

Before this patch Eclipse was frozen for minutes with 100% CPU load. The tests are new, coming with this patch, so I can't say for sure if the new test data was fitting or not before - because before Eclipse was unusable. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T09:26:42Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Andrey Loskutov from comment #37)
> Before this patch Eclipse was frozen for minutes with 100% CPU load. The
> tests are new, coming with this patch, so I can't say for sure if the new
> test data was fitting or not before - because before Eclipse was unusable.

Ah, sorry, I thought you had disabled previously existing tests.

Still disabling them is bad, maybe the size can be reduced instead? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T09:29:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Till Brychcy from comment #38)
> (In reply to Andrey Loskutov from comment #37)
> > Before this patch Eclipse was frozen for minutes with 100% CPU load. The
> > tests are new, coming with this patch, so I can't say for sure if the new
> > test data was fitting or not before - because before Eclipse was unusable.
> 
> Ah, sorry, I thought you had disabled previously existing tests.
> 
> Still disabling them is bad, maybe the size can be reduced instead?

Till, there are tests for different sizes to verify, that we do not observe quadratic runtime complexity. Reducing the size would be pointless. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T09:30:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I wonder why the gerrit builds were green and master suffers from this problem. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T11:06:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Here the test for the bug, based on Till's code.

We should see that we either provide a fix for this till the next week, or revert it.

	public void testCompilerRegression() throws JavaModelException, Exception {
		IPath projectPath = env.addProject("Bug544921Test", "1.8"); //$NON-NLS-1$

		env.addExternalJars(projectPath, Util.getJavaClassLibs());
		env.addClass(projectPath, "a", "Test", //$NON-NLS-1$ //$NON-NLS-2$
				"package a;\n" +
				"\n" +
				"import java.util.EnumMap;\n" +
				"\n" +
				"enum E {\n" +
				"\n" +
				"}\n" +
				"\n" +
				"public class Test {\n" +
				"    Object x = new EnumMap<E, String>(E.class) {\n" +
				"        {\n" +
				"            E.values();\n" +
				"        }\n" +
				"    };\n" +
				"\n" +
				"}" //$NON-NLS-1$
				);
		fullBuild();
		expectingNoProblems();
	} </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T12:14:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> A first analysis reveals that we do have reentrant calls to memberTypes on the same instance.
So while we are resolving all member types, a reentrant call will reorder them. In the end, we miss a few member types from being sorted and have pending unresolved types in the array.
Patch is on the way. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T12:24:27Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Zarnekow from comment #42)
> A first analysis reveals that we do have reentrant calls to memberTypes on
> the same instance.
> So while we are resolving all member types, a reentrant call will reorder
> them. In the end, we miss a few member types from being sorted and have
> pending unresolved types in the array.
> Patch is on the way.

Please either re-use Gerrit https://git.eclipse.org/r/#/c/145080/ or if you prefer a new Gerrit please:

+ version increment for tests bundle
+ new test for regression
+ patch for the regression
+ disable memory hungry tests </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-28T12:45:41Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/145112 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-06-30T06:31:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/145112 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=ee8afd3f2611403b3beb75ba311eda4769a6da40 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-01T06:59:30Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Thanks Sebastian for fast fix. Tests are also green now. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T16:55:11Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> The part of the change relating to member type sorting is incompatible with the Object Teams fork of jdt.core. While this is not a responsibility of JDT please help me finding a suitable solution.

(FYI, Object Teams needs member types to be sorted topologically by subtype relation).

What is the relation between the bug topic ("...with many field definitions") and sorting of member types?

What would be a typical number of member types that would require them to be sorted? What is the speed up at - say - 10 member types? 20? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T17:12:15Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hey Stefan,

there is a new testclass available that illustrates the perf gain. You may want to toy around with that one to gain the insights you are looking for. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T17:27:43Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Zarnekow from comment #48)
> Hey Stefan,
> 
> there is a new testclass available that illustrates the perf gain. You may
> want to toy around with that one to gain the insights you are looking for.

Hmm, you mean we don't have any numbers for this performance fix?

Also the test class will probably not answer my first question:

(In reply to Stephan Herrmann from comment #47)
> What is the relation between the bug topic ("...with many field definitions")
> and sorting of member types?

This I would expect to be answered in bugzilla independent of the conflict with Object Teams.

*Stephan*
;) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T17:38:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #49)
> (In reply to Sebastian Zarnekow from comment #48)
> > Hey Stefan,
> > 
> > there is a new testclass available that illustrates the perf gain. You may
> > want to toy around with that one to gain the insights you are looking for.
> 
> Hmm, you mean we don't have any numbers for this performance fix?

The numbers are "unusable" vs "few seconds".

> Also the test class will probably not answer my first question:
> 
> (In reply to Stephan Herrmann from comment #47)
> > What is the relation between the bug topic ("...with many field definitions")
> > and sorting of member types?
> 
> This I would expect to be answered in bugzilla independent of the conflict
> with Object Teams.

The test constructs big classes. Depending on the workstation config slowdown can start with 1000 or 1000.000. So concrete number is "many". </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T17:52:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Andrey Loskutov from comment #50)
> The test constructs big classes. Depending on the workstation config
> slowdown can start with 1000 or 1000.000. So concrete number is "many".

According to the bug title I read this as 1000 or 1.000.000 fields.

Or are you saying this bug fixes a problem for users having a file with 1.000.000 member types?

Additionally, this fix increases existing confusion about type identity, see bug 549116 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T18:05:57Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Mea culpa Stephan. Answering bugzillas on the phone is a bad habit of mine. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T18:47:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Zarnekow from comment #52)
> Mea culpa Stephan. Answering bugzillas on the phone is a bad habit of mine.

accepted :)

To answer my own question: in the test case where the code comment speaks of 25 minutes, enabling / disabling member type sorting makes a difference in the range of 14 vs. 19 seconds. I assume this is already a very rare situation. Smaller tests naturally have less significant differences.

In that light, I'm not really convinced that the complexity introduced by member type sorting (see e.g., comment 42) is balanced by the gain for the community. I should add that this is said from a JDT point of view - for Object Teams my strategy is clear :). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T21:29:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hmm fields and methods are sorted as well so I wonder what makes nested types fundamentally different from the others such that we should not explore the very same optimisation there, too?

Regarding the reference to the other bug about TypeBindingWrappers: If I recall correctly, there were introduced to improve the editing experience for heavily broken project setups (large files, missing types on classpath). So maybe we should reiterate the entire approach here and get a clear picture. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-09T22:03:13Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Zarnekow from comment #54)
> Hmm fields and methods are sorted as well so I wonder what makes nested
> types fundamentally different from the others such that we should not
> explore the very same optimisation there, too?

I'm not against exploring, but anything that adds complexity should only be done for a noticeable benefit. For fields I can readily see that their number can grow large, but I'm lacking imagination for classes with thousands of member types or more. That's why to me it has the smell of speculative optimization.

> Regarding the reference to the other bug about TypeBindingWrappers: If I
> recall correctly, there were introduced to improve the editing experience
> for heavily broken project setups (large files, missing types on classpath).

I'm not sure which concept exactly you are referring to.

UnresolvedReferenceBinding supports lazy resolving of transitive dependencies.

Everything inside class TypeSystem is here to ensure uniqueness of type bindings and their variants (parameterized, annotated, ...). </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T06:48:38Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hi Stephan,

the code which is now sorting / using that sorted state previously had quadratic complexity during the compile. Now it has nlogn complexity, which is already much better.

The comment refers to 26 MB source file size, not 26 minutes.

Our users had the following problem:

1. Generate a mega-source-file which holds constants for a chip.
2. Add this source file to their project.
3. Observe compile times that take above 30 minutes (on a HP Z620).

To work with this they removed the source file from the project classpath and added an extra command line builder to compile the file, as javac compiled it in under 10 seconds. It is very difficult to justify minutes of compile time when javac does it in a few seconds.

We already had some performance fixes for this, however the compile time still took minutes: 5 or 7 minutes on a HP Z620, depending on having compile errors / having no errors in the source file.

Sorry, but to me reducing quadratic complexity is always a noticable benefit?

Best regards,
Simeon </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T15:53:34Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Simeon Andreev from comment #56)
> Hi Stephan,
> 
> the code which is now sorting / using that sorted state previously had
> quadratic complexity during the compile. Now it has nlogn complexity, which
> is already much better.
> 
> The comment refers to 26 MB source file size, not 26 minutes.

I just quoted from Bug544921Test.java:
... The example that took 25 minutes ...

> Our users had the following problem:
> 
> 1. Generate a mega-source-file which holds constants for a chip.
> 2. Add this source file to their project.
> 3. Observe compile times that take above 30 minutes (on a HP Z620).
> 
> To work with this they removed the source file from the project classpath
> and added an extra command line builder to compile the file, as javac
> compiled it in under 10 seconds. It is very difficult to justify minutes of
> compile time when javac does it in a few seconds.

I 100% agree and never stated differently, did I?
 
> We already had some performance fixes for this, however the compile time
> still took minutes: 5 or 7 minutes on a HP Z620, depending on having compile
> errors / having no errors in the source file.

Sorry, but I'm only speaking about one particular optimization which reduced 19 seconds to 14 seconds (see comment 53), not about the optimization 25 minutes down to 20 seconds. Why does everybody think I'm questioning that big improvement?? Please read carefully!
 
> Sorry, but to me reducing quadratic complexity is always a noticable benefit?

Sorry, but for small n this is just not true. And I believe small n is *by far* the normal situation for member types. 

Think of it: maybe the original developers (under the lead of Philip Mulet - one of the smartest developers Eclipse had in its history) back around 2006 actually had reasons to add sorting for fields and methods but not for member types? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T16:08:43Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> All agreed.

Stephan, am I right with the assumption that the only runtime problem with the sorting is observable in ObjectTeams, which uses aspect oriented techniques to hook into internals and implementation details of JDT?
Apart from that, it is most importantly a raised concern about maintenance effort? Or is there a potential bug lurking that I missed? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T16:45:47Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Zarnekow from comment #58)
> All agreed.
> 
> Stephan, am I right with the assumption that the only runtime problem with
> the sorting is observable in ObjectTeams,

right

> which uses aspect oriented
> techniques to hook into internals and implementation details of JDT?

At this level we have a plain fork of the code. With my performance results from comment 53 the solution for Object Teams is simple (done).

> Apart from that, it is most importantly a raised concern about maintenance
> effort? Or is there a potential bug lurking that I missed?

Right, my concern is 93% about maintenance (and 7% about a possible performance penalty for the vast majority of cases).

BTW, any of you could easily shortcut the maintenance discussion by promising to actively watch for and react to bug reports in this code area :) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T16:48:57Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #59)
> BTW, any of you could easily shortcut the maintenance discussion by
> promising to actively watch for and react to bug reports in this code area :)

Done ;)

What's to be clarified for me is your comment about type identity.

> Additionally, this fix increases existing confusion about type identity, see bug 549116

But this discussion is better to be taken over into the other ticket. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-07-10T17:11:39Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Sebastian Zarnekow from comment #60)
> (In reply to Stephan Herrmann from comment #59)
> > BTW, any of you could easily shortcut the maintenance discussion by
> > promising to actively watch for and react to bug reports in this code area :)
> 
> Done ;)

thanks </td> </tr>
        </table>
</body>
</html>
