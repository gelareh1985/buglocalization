<html>

<style>
html{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif ;
    font-size: 17px;
    display: table;
}
table,th,td {
  border: 1px solid black;
  width: 1200;
  text-align:justify;
  word-break:break-all;
}

th{
background-color: lightskyblue;
font-size: 16px;
border: none;
text-align:left;
}

td{
background-color: #d5e3c8;
font-size: 14px;
}

.container {
  position: relative;
  text-align:center;
  padding-top: 70%;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #73AD21;
}

</style>
<body>

<h2>Bug report Information</h2>
<table>

    <th colspan="2"> Bug Report </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bug Report Number </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 535819 </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Summary </td>
        <td  style="width: 80%; background-color:#f7fff0;"> possible NPE when using ecj >3.13.0 with annotation processor </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Creation Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2018-06-12T16:37:06Z </td>
    </tr>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Status </td>
        <td  style="width: 80%; background-color:#f7fff0;"> RESOLVED </td>
    </tr>

    <th colspan="2"> Bug Fix </th>
    <tr>
        <td  style="width: 20%; background-color:#d5e3c8;"> Bugfix Commit </td>
        <td  style="width: 80%; background-color:#f7fff0;"> Bug 535819 - possible NPE when using ecj >3.13.0 with annotation
processor

Testcase

Change-Id: I02882bb552fe4837cb62fe5554f9b68eb4e052ac
Signed-off-by: Jay Arthanareeswaran <jarthana@in.ibm.com>
 </td>
    </tr>
    <tr>
        <td  tyle="width: 20%; background-color:#d5e3c8;"> Bugfix Time </td>
        <td  style="width: 80%; background-color:#f7fff0;"> 2019-04-02T06:31:22Z </td>
    </tr>
    </table>
<table>

<th colspan="2"> Ranked List of Class Diagrams </th>

<tr>
<td  style="width: 20%; font-size: 10px; background-color:#d5e3c8">

            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> GenericsRegressionTest_1_8; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Compiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> DatabaseRef; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleUpdater; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ASTConverterBugsTestJLS3; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CompilerToolTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> CodeFormatterApplication; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FieldInitsFakingFlowContext; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FinalRoundTestTrigger; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Database; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BuilderTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RunOnly335CompilerTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ClassFileToIndexConverter; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Disassembler; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IUpdatableModule; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Factory; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleBuilderTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ModuleInfoBuilder; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> RecoveredModule; </a> </li>
            </ul>   
            
            <ul>
                <li style="font-weight: bold;"> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> MatchLocator; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> IPolyExpression; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AbstractRegressionTest$JavacCompiler; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> FormatterJSR335Tests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> MethodVerifier; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> BTreeExpensiveTests; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> ParserTest; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> Options; </a> </li>
            </ul>   
            
            <ul>
                <li> <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" target="myIframe"> AptConfig$ProcessorOptionsParser; </a> </li>
            </ul>   
            
</td>
<td  rowspan="30" style="width: 80%;  background-color:#d5e3c8"> 
    <div class="container">
    <iframe class="responsive-iframe" src="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html" name="myIframe">
        <a href="C:/Users/gelareh/git/buglocalization/plugins/org.sidiff.bug.localization.prediction/src/webpage/image_html_pages/diagram_default.html">SELFHTML</a>
    </iframe>
    </div>
</td>
</tr>
</table>
<table>

<th colspan="2"> Ranked List of Classifiers </th>

                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/dom/ASTConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/GenericsRegressionTest_1_8; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/Compiler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/DatabaseRef; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/ModuleUpdater; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/impl/CompilerOptions; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/pdom/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterBugsTestJLS3; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.compiler.tool.tests/Lorg/eclipse/jdt/compiler/tool/tests/CompilerToolTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/core/formatter/CodeFormatterApplication; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverterJavadocTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullTypeAnnotationTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/LambdaRegressionTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/flow/FieldInitsFakingFlowContext; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.pluggable.tests/Lorg/eclipse/jdt/apt/pluggable/tests/annotations/FinalRoundTestTrigger; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/db/Database; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/NullAnnotationTest; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.pluggable.tests/Lorg/eclipse/jdt/apt/pluggable/tests/BuilderTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/RunOnly335CompilerTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/InterfaceMethodsTest_9; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.compiler/Lorg/eclipse/jdt/core/tests/compiler/regression/AnnotationTest_9; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/nd/indexer/ClassFileToIndexConverter; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/util/Disassembler; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/env/IUpdatableModule; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.compiler.tool.tests/Lorg/eclipse/jdt/compiler/tool/tests/CompilerToolJava9Tests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/compiler/parser/Parser; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.apt.core/Lorg/eclipse/jdt/apt/core/internal/util/Factory; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/model/ModuleBuilderTests; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core/Lorg/eclipse/jdt/internal/core/LambdaExpression; </td>
                </tr>

                
                <tr>
                    <td  style="font-size: 12px; background-color:#d5e3c8"> org.eclipse.jdt.core.tests.model/Lorg/eclipse/jdt/core/tests/dom/ASTConverter18Test; </td>
                </tr>

                </table>
<table>

<th colspan="2"> Discussion </th>

        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-06-12T16:37:06Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> We are using the ecj/jdt.core in conjunction with annotation processors.

Our project won't compile in eclipse 4.7.3 - eclipse reports a NullPointerException (without stack-trace - was really hard to debug)


This PR fixes two NPEs that happened here. The behavour came with org.eclipse.jdt.core > 3.13.0
(version 3.13.0 / Eclipse 4.7.0 did not have that error)

*Possible cause of the error*
It seems that the annotation-processor needs more rounds, so in the first round not all dependent java files are generated, and eclipse creates a problemPackageBinding which is not fully initialized. Unfortunately, methods from the PropblemPackageBinding are accessed, which throw a NPE.

Stack traces

Eclipse build:

Thread [Worker-16] (Suspended (exception NullPointerException))	
	ProblemPackageBinding(PackageBinding).getPackage0(char[]) line: 171	
	LookupEnvironment.createPackage(char[][]) line: 1081	
	CompilationUnitScope.buildTypeBindings(AccessRestriction) line: 129	
	LookupEnvironment.buildTypeBindings(CompilationUnitDeclaration, AccessRestriction) line: 457	
	Compiler.internalBeginToCompile(ICompilationUnit[], int) line: 838	
	Compiler.processAnnotations() line: 954	
	Compiler.compile(ICompilationUnit[], boolean) line: 443	
	Compiler.compile(ICompilationUnit[]) line: 419	
	BatchImageBuilder(AbstractImageBuilder).compile(SourceFile[], SourceFile[], boolean) line: 372	
	BatchImageBuilder.compile(SourceFile[], SourceFile[], boolean) line: 187	
	BatchImageBuilder(AbstractImageBuilder).compile(SourceFile[]) line: 305	
	BatchImageBuilder.build() line: 61	
	JavaBuilder.buildAll() line: 256	
	JavaBuilder.build(int, Map, IProgressMonitor) line: 180	
	BuildManager$2.run() line: 735	
	SafeRunner.run(ISafeRunnable) line: 42	
	BuildManager.basicBuild(int, IncrementalProjectBuilder, Map<String,String>, MultiStatus, IProgressMonitor) line: 206	
	BuildManager.basicBuild(IBuildConfiguration, int, IBuildContext, ICommand[], MultiStatus, IProgressMonitor) line: 246	
	BuildManager$1.run() line: 301	
	SafeRunner.run(ISafeRunnable) line: 42	
	BuildManager.basicBuild(IBuildConfiguration, int, IBuildContext, MultiStatus, IProgressMonitor) line: 304	
	BuildManager.basicBuildLoop(IBuildConfiguration[], IBuildConfiguration[], int, MultiStatus, IProgressMonitor) line: 360	
	BuildManager.build(IBuildConfiguration[], IBuildConfiguration[], int, IProgressMonitor) line: 383	
	AutoBuildJob.doBuild(IProgressMonitor) line: 142	
	AutoBuildJob.run(IProgressMonitor) line: 232	
	Worker.run() line: 56	


Maven build:

Thread [main] (Suspended (exception NullPointerException))	
	ProblemPackageBinding(PackageBinding).addType(ReferenceBinding) line: 102	
	ClassScope.buildType(SourceTypeBinding, PackageBinding, AccessRestriction) line: 429	
	CompilationUnitScope.buildTypeBindings(AccessRestriction) line: 185	
	LookupEnvironment.buildTypeBindings(CompilationUnitDeclaration, AccessRestriction) line: 457	
	Compiler.internalBeginToCompile(ICompilationUnit[], int) line: 838	
	Compiler.processAnnotations() line: 954	
	Compiler.compile(ICompilationUnit[], boolean) line: 443	
	Compiler.compile(ICompilationUnit[]) line: 419	
	EclipseCompilerMain(Main).performCompilation() line: 4687	
	EclipseJavaCompiler.performCompile(CompilerConfiguration) line: 148	
	CompilerMojo(AbstractCompilerMojo).execute() line: 952	
	CompilerMojo.execute() line: 158	
	DefaultBuildPluginManager.executeMojo(MavenSession, MojoExecution) line: 134	
	MojoExecutor.execute(MavenSession, MojoExecution, ProjectIndex, DependencyContext) line: 207	
	MojoExecutor.execute(MavenSession, MojoExecution, ProjectIndex, DependencyContext, PhaseRecorder) line: 153	
	MojoExecutor.execute(MavenSession, List<MojoExecution>, ProjectIndex) line: 145	
	LifecycleModuleBuilder.buildProject(MavenSession, MavenSession, ReactorContext, MavenProject, TaskSegment) line: 116	
	LifecycleModuleBuilder.buildProject(MavenSession, ReactorContext, MavenProject, TaskSegment) line: 80	
	SingleThreadedBuilder.build(MavenSession, ReactorContext, ProjectBuildList, List<TaskSegment>, ReactorBuildStatus) line: 51	
	LifecycleStarter.execute(MavenSession) line: 128	
	DefaultMaven.doExecute(MavenExecutionRequest, MavenSession, MavenExecutionResult, DefaultRepositorySystemSession) line: 307	
	DefaultMaven.doExecute(MavenExecutionRequest) line: 193	
	DefaultMaven.execute(MavenExecutionRequest) line: 106	
	MavenCli.execute(CliRequest) line: 863	
	MavenCli.doMain(CliRequest) line: 288	
	MavenCli.main(String[], ClassWorld) line: 199	
	NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) line: not available [native method]	
	NativeMethodAccessorImpl.invoke(Object, Object[]) line: 62	
	DelegatingMethodAccessorImpl.invoke(Object, Object[]) line: 43	
	Method.invoke(Object, Object...) line: 498	
	Launcher.launchEnhanced(String[]) line: 289	
	Launcher.launch(String[]) line: 229	
	Launcher.mainWithExitCode(String[]) line: 415	
	Launcher.main(String[]) line: 356	


There is a suggested fix here:
https://github.com/eclipse/eclipse.jdt.core/pull/10 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-06-12T17:33:49Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Thanks for your analysis.

Still I would love to see the problem fixed closer to the root.

I don't think we should even try to #addType() on a ProblemPackageBinding. Actually, creating the type binding should be an indication that the ProblemPackageBinding should be replaced by a real PackageBinding (provided the problem reason is NotFound, rather than a visibility issue).

The case of getPackage0() could be similar, like we are trying to create a package binding with a ProblemPackageBinding as its parent. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-06-12T22:16:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hello Stephan,

I agree, that my workaround is only a minimal fix for the root of the problem. 

As far as I understand, the ProblemPackageBinding is just a marker-singletin with no internal state.
In my opinion, every method that access any member should be overwritten and should return a default value or throw an exception. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-06-14T11:57:22Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> For the sake of trying different solution strategies, could you create a minimal example that triggers the bug?

Also, please consider signing the Eclipse Contributor Agreement ( https://wiki.eclipse.org/ECA ) and if possible submit proposed changes / tests to gerrit rather than github (LMK if you have questions regarding gerrit).
TIA </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-06-19T09:36:28Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #3)
> For the sake of trying different solution strategies, could you create a
> minimal example that triggers the bug?

Hmm, This is a big challenge because our project uses several annotation processors. (some of them closed source) 
I can try to strip that down to a minimal example in one or two weeks.
 
> Also, please consider signing the Eclipse Contributor Agreement (
> https://wiki.eclipse.org/ECA ) and if possible submit proposed changes /
> tests to gerrit rather than github (LMK if you have questions regarding
> gerrit).
> TIA

As the current fixes only the NPEs and probably not the root case, it is not worth to merge that in. I'll contact you, if I want to create a new PR in gerrit.

TIA
Roland </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-06-27T14:54:01Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> I think we are running into this as well:

Caused by: java.lang.NullPointerException: null
at org.eclipse.jdt.internal.compiler.lookup.PackageBinding.addType(PackageBinding.java:102)
at org.eclipse.jdt.internal.compiler.lookup.ClassScope.buildType(ClassScope.java:429)
at org.eclipse.jdt.internal.compiler.lookup.CompilationUnitScope.buildTypeBindings(CompilationUnitScope.java:185)
at org.eclipse.jdt.internal.compiler.lookup.LookupEnvironment.buildTypeBindings(LookupEnvironment.java:453)
at org.eclipse.jdt.internal.compiler.Compiler.internalBeginToCompile(Compiler.java:838)
at org.eclipse.jdt.internal.compiler.Compiler.processAnnotations(Compiler.java:979)
at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:443)
at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:419) </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2018-06-27T21:03:55Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Gunnar Wagenknecht from comment #5)
> I think we are running into this as well:

So this goes to you as well:

(In reply to Stephan Herrmann from comment #3)
> For the sake of trying different solution strategies, could you create a
> minimal example that triggers the bug? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-01-31T23:58:32Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #3)
> For the sake of trying different solution strategies, could you create a
> minimal example that triggers the bug?

About 30 weeks later, I have a minimal working example here:
https://github.com/FOCONIS/ecj_bug_535819
I hope you can reproduce the bug. Please let me know, if you still need an ECA from me.

Best regards
Roland </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-22T10:07:00Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hi,

I updated Roland's sample project with the latest eclipse compiler release (ecj-3.17.0.jar). It still throws a NPE when compiling Roland's sample code.

Are there any news on this issue? We face this "fragile compiler breakage" sporadically during development.

Best regards,

Manuel </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-22T10:50:51Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Roland Praml from comment #7)
> About 30 weeks later, I have a minimal working example here:

(In reply to Manuel Danisch from comment #8)

Thanks for the update. The team just got somewhat less busy after the Java 12 work. I will see if I can spare some time for this during 4.12.


Meanwhile, if someone is willing to lend a helping hand and come up with a patch, that will be awesome too. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-22T12:17:29Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Hello,

In his first comment, Roland suggested a fix which he posted in github. This might be a good starting point to debug the issue:

https://github.com/eclipse/eclipse.jdt.core/pull/10

Best regards,

Manuel </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-26T16:47:18Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Today we ran again in this bug.

I figured out by trial & error that adding a dummy const in one of the classes that we changed in the last commit fixes/hides the bug:
---
public static final @Nonnull QListXXX FIX_COMPILER_BUG = new QListXXX ();
---

Note 1: This line does nothing in the class: It is not referenced, It is just there and generates an additional import line, of course.
(I also figured out earlier, that an `import my.package.*` behaves different than a resolved import, see example on github)

Note 2: The @Nonnull is also required - there are also a lot of other @Nonnull annotations in this class (maybe this is an important information)

I also tried to dump the output with -verbose 

(shortened/anonymized version of a successful run)
---
[parsing    de\foconis\p1\Class1.java - #1/256]
   :
[parsing    de\foconis\p2\Class57.java - #57/256] <- here I added const
   :
[parsing    de\foconis\p3\ListXXX.java - #180/256] <- generates QListXXX by apt
   :
[parsing    de\foconis\Class256.java - #256/256] <- last class for this round
   :
[reading ...] <-- as far as I understand, this is the first APT round
   :
[parsing    generated-sources\de\foconis\query\QListXXX.java - #1/112] 
[parsing    de\foconis\Class1.java - #1/368]
   :
[368 units compiled]
[506 .class files generated]
---

On a failure run, the output looks exactly the same till line
[parsing    generated-sources\de\foconis\query\QListXXX.java - #1/112]
This is the last line printed, and then the NPE occurs.

Note also the jump from [#1/112] to [#1/368] 

As far as I can tell you now, I figured out the following facts:

- QListXXX class is the first class, that is compiled in the next round
- if this class is not referenced anywhere in the same project -> NPE
- it seems that it not matter in which class I put that reference

I know now, If I run into this error again, I have to
- run the compiler in verbose mode
- look at the last printed class before NPE (in this case [QListXXX.java - #1/112]) and put a @Nonnull reference somewhere in the code.

So I hope with this information it is possible to narrow down the problem.
(Unfortunately I do not understand too much about ecj, so my patch on github may fix the problem, but I do not know why and if it had side effects)

Cheers
Roland </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-26T21:39:35Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Roland Praml from comment #7)
> (In reply to Stephan Herrmann from comment #3)
> > For the sake of trying different solution strategies, could you create a
> > minimal example that triggers the bug?
> 
> About 30 weeks later, I have a minimal working example here:
> https://github.com/FOCONIS/ecj_bug_535819
> I hope you can reproduce the bug.

Yes, thanks, I can reproduce.

First we fail to resolve the package de.foconis.ecjbug.domain.query (from an import in Finder.java) in this call stack:

PackageBinding.addNotFoundPackage(char[]) line: 80	
PackageBinding.getTypeOrPackage(char[], ModuleBinding, boolean) line: 294	
CompilationUnitScope.findImport(char[][], int) line: 539	
CompilationUnitScope.findSingleImport(char[][], int, boolean) line: 606	
CompilationUnitScope.resolveSingleImport(ImportBinding, int) line: 832	
MethodScope(Scope).getTypeOrPackage(char[], int, boolean) line: 3331	
MethodScope(Scope).getType(char[]) line: 3063	
SingleTypeReference.getTypeBinding(Scope) line: 57	
SingleTypeReference(TypeReference).internalResolveType(Scope, int) line: 514	
SingleTypeReference(TypeReference).resolveType(BlockScope, boolean, int) line: 615	
SingleTypeReference(TypeReference).resolveType(BlockScope, boolean) line: 611	
SourceTypeBinding.resolveTypesWithSuspendedTempErrorHandlingPolicy(MethodBinding) line: 2045	
SourceTypeBinding.resolveTypesFor(MethodBinding) line: 1883	
AnnotationDiscoveryVisitor.visit(MethodDeclaration, ClassScope) line: 176	
MethodDeclaration.traverse(ASTVisitor, ClassScope) line: 335	
TypeDeclaration.traverse(ASTVisitor, CompilationUnitScope) line: 1448	
CompilationUnitDeclaration.traverse(ASTVisitor, CompilationUnitScope, boolean) line: 812	
CompilationUnitDeclaration.traverse(ASTVisitor, CompilationUnitScope) line: 773	
RoundEnvImpl.<init>(CompilationUnitDeclaration[], ReferenceBinding[], boolean, BaseProcessingEnvImpl) line: 64	
BatchAnnotationProcessorManager(BaseAnnotationProcessorManager).processAnnotations(CompilationUnitDeclaration[], ReferenceBinding[], boolean) line: 163	
Compiler.processAnnotations() line: 940	
Compiler.compile(ICompilationUnit[], boolean) line: 450	
Compiler.compile(ICompilationUnit[]) line: 426	
Main.performCompilation() line: 4718	
Main.compile(String[]) line: 1768	
Main.main(String[]) line: 1491	

Later when we compile the generated class QEntity1.java its package declaration finds the not-found package and assigns it to #fPackage which should never happen. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-26T21:51:47Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/139543 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-26T21:57:04Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Eclipse Genie from comment #13)
> New Gerrit change created: https://git.eclipse.org/r/139543

With this we avoid to add any not-found package or type while the RoundEnv requests to suppressImportErrors.

@Jay, a corresponding JUnit would need an annotation processor, which is unknown territory to me :)  - may I ask your help here? </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-27T07:55:45Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Stephan Herrmann from comment #14)
> (In reply to Eclipse Genie from comment #13)
> > New Gerrit change created: https://git.eclipse.org/r/139543
> 
> With this we avoid to add any not-found package or type while the RoundEnv
> requests to suppressImportErrors.
> 
> @Jay, a corresponding JUnit would need an annotation processor, which is
> unknown territory to me :)  - may I ask your help here?

Sure, not a problem. I will add the test case soon, probably in a day. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-29T05:29:40Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/139714 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-03-29T21:30:30Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> *** Bug 545895 has been marked as a duplicate of this bug. *** </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-02T06:32:48Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/139874 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-02T06:36:05Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> New Gerrit change created: https://git.eclipse.org/r/139875 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-02T10:21:41Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/139714 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=11c8aa046b654035396fabe27672bbab88bb0fda </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-02T10:24:39Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Gerrit change https://git.eclipse.org/r/139875 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=6c19f59ccc7eddfcbe29da18a067179f04929983 </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-02T10:57:08Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> Thanks Stephan. I have released the fix and new tests. </td> </tr>
        
        <tr>
            <td style="width: 20%; font-size: 12px; background-color:#d5e3c8"> Creation Time </td>
            <td style="width: 80%; font-size: 12px; background-color:#d5e3c8"> 2019-04-02T12:00:36Z </td>
        </tr>
        <tr> <td colspan="2" style="font-size: 12px; background-color:#f7fff0"> (In reply to Jay Arthanareeswaran from comment #22)
> Thanks Stephan. I have released the fix and new tests.

Thanks

(for a minute I was confused by the four(!) different gerrits, but it seems, three of them have the same content, and the other has the test, so all is well that ends well :) ). </td> </tr>
        </table>
</body>
</html>
